<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.0.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.chenwj.cn","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="学习，坚持。">
<meta property="og:type" content="website">
<meta property="og:title" content="茄子的博客">
<meta property="og:url" content="http://www.chenwj.cn/page/6/index.html">
<meta property="og:site_name" content="茄子的博客">
<meta property="og:description" content="学习，坚持。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="陈伟杰">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://www.chenwj.cn/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>茄子的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="茄子的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">茄子的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技术博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">68</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">26</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">75</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-02-08/redis%E9%9B%86%E7%BE%A4-%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-02-08/redis%E9%9B%86%E7%BE%A4-%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">redis集群-主从配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-02-08 00:57:55" itemprop="dateCreated datePublished" datetime="2018-02-08T00:57:55+08:00">2018-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>由于redis支持的redis cluster和redis sentinel 的集群模式为了保证高可用和高负载需要多台服务器.用redis的主从模式,读写分离,是另一种高可用的方案(容灾效果相对不好).</p>
<h1 id="redis主从模式的特点"><a href="#redis主从模式的特点" class="headerlink" title="redis主从模式的特点"></a>redis主从模式的特点</h1><ul>
<li>一个master可以拥有多个slave</li>
<li>多个slave链接同一个master，也可以链接其它slave</li>
<li>主从复制不会阻塞master,在同步数据时，master可以继续处理client请求.</li>
<li>slave 配置为slave-read-only on需要升级为主节点或者写入配置文件中, 而不能在默认slave情况下直接设置</li>
<li>master与slave断开后会检测心跳, 从新建立连接.</li>
<li>可以直接copy DUMP文件从新重启master</li>
<li>在Master为空以后，slave同步数据会抹掉全部数据.</li>
<li>在实际的使用中最好主服务器还是使用50%到65%的内存,剩下的用于bgsave命令的运行和创建记录写命令的缓冲区.</li>
<li>从服务器在同步主服务器的数据的时候,会清空从服务器中的数据,并被替换为主服务器发来的数据.</li>
</ul>
<p>以下为redis的主从配置实战</p>
<h1 id="下载并编译redis源码包"><a href="#下载并编译redis源码包" class="headerlink" title="下载并编译redis源码包"></a>下载并编译redis源码包</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-3.2.10.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf redis-3.2.10.tar.gz</span><br><span class="line"></span><br><span class="line">cd &#x2F;redis-3.2.10&#x2F;src&#x2F;</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="配置redis主从"><a href="#配置redis主从" class="headerlink" title="配置redis主从"></a>配置redis主从</h1><p>主：127.0.0.1:6379</p>
<p>从：127.0.0.1:6380</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir redis-6379 redis-6380</span><br><span class="line"></span><br><span class="line">sudo cp redis-3.2.10&#x2F;* -r redis-6379&#x2F;</span><br><span class="line"></span><br><span class="line">sudo cp redis-3.2.10&#x2F;* -r redis-6380&#x2F;</span><br><span class="line"></span><br><span class="line">sudo mkdir &#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6379&#x2F;run  &#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6380&#x2F;run</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="配置主节点-redis-config-注意-prod环境需要配置bind-参数"><a href="#配置主节点-redis-config-注意-prod环境需要配置bind-参数" class="headerlink" title="配置主节点 redis.config (注意,prod环境需要配置bind 参数)"></a>配置主节点 redis.config (注意,prod环境需要配置bind 参数)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6379&#x2F;run&#x2F;redis_6379.pid</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="配置从节点-redis-config"><a href="#配置从节点-redis-config" class="headerlink" title="配置从节点 redis.config"></a>配置从节点 redis.config</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6380&#x2F;run&#x2F;redis_6380.pid</span><br><span class="line">slaveof 127.0.0.1 6379</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其它配置采用默认配置即可</p>
<h1 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6379$ sudo .&#x2F;src&#x2F;redis-server redis.conf &amp;</span><br><span class="line"></span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6380$ sudo .&#x2F;src&#x2F;redis-server redis.conf &amp;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="连接客户端测试"><a href="#连接客户端测试" class="headerlink" title="连接客户端测试"></a>连接客户端测试</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6380$ sudo .&#x2F;src&#x2F;redis-cli -h 127.0.0.1 -p 6380</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip&#x3D;127.0.0.1,port&#x3D;6380,state&#x3D;online,offset&#x3D;533,lag&#x3D;0</span><br><span class="line">master_repl_offset:533</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:532</span><br><span class="line">127.0.0.1:6379&gt; set master 127.0.0.1:6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set slave 127.0.0.1:6380</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisSlave&#x2F;redis-6379$ sudo .&#x2F;src&#x2F;redis-cli -h 127.0.0.1 -p 6379</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:9</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:750</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">127.0.0.1:6380&gt; get master</span><br><span class="line">&quot;127.0.0.1:6379&quot;</span><br><span class="line">127.0.0.1:6380&gt; get slave</span><br><span class="line">&quot;127.0.0.1:6380&quot;</span><br><span class="line">127.0.0.1:6380&gt; set slave test</span><br><span class="line">(error) READONLY You can&#39;t write against a read only slave.</span><br><span class="line">127.0.0.1:6380&gt; </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上信息中role分别代表master 和slave.</p>
<p>在主节点中set master和slave,在从节点中可以获取到值的信息.表示主从配置成功.</p>
<h1 id="从节点复制从节点"><a href="#从节点复制从节点" class="headerlink" title="从节点复制从节点"></a>从节点复制从节点</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">6381配置和6380的一样都是作为6379的丛节点.</span><br><span class="line"></span><br><span class="line">6382的配置和6380不同的是,slaveof参数为6381</span><br><span class="line"></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:8</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:3284</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip&#x3D;127.0.0.1,port&#x3D;6382,state&#x3D;online,offset&#x3D;113,lag&#x3D;0</span><br><span class="line">master_repl_offset:113</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:112</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">127.0.0.1:6382&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6381</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:8</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:99</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="主从切换"><a href="#主从切换" class="headerlink" title="主从切换"></a>主从切换</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">主挂掉了后从执行：</span><br><span class="line">src&#x2F;redis-cli -p 6380 slaveof NO ONE</span><br><span class="line"></span><br><span class="line">主恢复后从执行：</span><br><span class="line">src&#x2F;redis-cli -p 6380 slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure>

<h1 id="主从配置密码"><a href="#主从配置密码" class="headerlink" title="主从配置密码"></a>主从配置密码</h1><p>主:redis.conf中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirepass abc</span><br></pre></td></tr></table></figure>

<p>从:redis.conf中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masterauth abc</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-02-05/redis%E9%9B%86%E7%BE%A4-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-02-05/redis%E9%9B%86%E7%BE%A4-cluster/" class="post-title-link" itemprop="url">redis集群-cluster</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-02-05 00:20:33" itemprop="dateCreated datePublished" datetime="2018-02-05T00:20:33+08:00">2018-02-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>49k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>45 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近学习了redis设计与实现这本书.这本书中主要讲述是理论知识,所以最近首先整理一下关于redis的集群的知识.然后学习redis实战这本书,实战一下.</p>
<h1 id="关于redis-cluster"><a href="#关于redis-cluster" class="headerlink" title="关于redis cluster"></a>关于redis cluster</h1><p>redis cluster在设计的时候，就考虑到了去中心化，去中间件，也就是说，集群中的每个节点都是平等的关系，都是对等的，每个节点都保存各自的数据和整个集群的状态。每个节点都和其他所有节点连接，而且这些连接保持活跃，这样就保证了我们只需要连接集群中的任意一个节点，就可以获取到其他节点的数据。</p>
<p>Redis 集群<strong>没有使用传统的一致性哈希</strong>来分配数据，而是采用另外一种叫做<strong>哈希槽</strong> (hash slot)的方式来分配的。redis cluster 默认分配了 16384 个slot，当我们set一个key 时，会用CRC16算法来取模得到所属的slot，然后将这个key 分到哈希槽区间的节点上，具体算法就是：CRC16(key) % 16384。</p>
<h1 id="Redis-Cluster主从模式"><a href="#Redis-Cluster主从模式" class="headerlink" title="Redis Cluster主从模式"></a>Redis Cluster主从模式</h1><p>redis cluster 为了保证数据的高可用性，加入了主从模式，一个主节点对应一个或多个从节点，主节点提供数据存取，从节点则是从主节点拉取数据备份，当这个主节点挂掉后，就会有这个从节点选取一个来充当主节点，从而保证集群不会挂掉。</p>
<ul>
<li>例子</li>
</ul>
<p>集群有ABC三个主节点, 如果这3个节点都没有加入从节点，如果B挂掉了，我们就无法访问整个集群了。A和C的slot也无法访问。所以我们在集群建立的时候，一定要为每个主节点都添加了从节点,比如像这样, 集群包含主节点A、B、C, 以及从节点A1、B1、C1, 那么即使B挂掉系统也可以继续正确工作。B1节点替代了B节点，所以Redis集群将会选择B1节点作为新的主节点，集群将会继续正确地提供服务。当B重新开启后，它就会变成B1的从节点。不过需要注意，如果节点B和B1同时挂了，Redis集群就无法继续正确地提供服务了。</p>
<p>更多关于redisCluster的知识访问我的博文 <a target="_blank" rel="noopener" href="http://chenwj.cn/2018-01-28/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-cluster/">redisCluster</a></p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>按照<a target="_blank" rel="noopener" href="http://redis.io/topics/cluster-tutorial">官方cluster文档</a>进行实战 </p>
<h2 id="创建并使用集群"><a href="#创建并使用集群" class="headerlink" title="创建并使用集群"></a>创建并使用集群</h2><p>Redis 集群由多个运行在集群模式（cluster mode）下的 Redis 实例组成， 实例的集群模式需要通过配置来开启， 开启集群模式的实例将可以使用集群特有的功能和命令。</p>
<p>以下是一个包含了最少选项的集群配置文件示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">port 7000    &#x2F;&#x2F;端口号</span><br><span class="line">cluster-enabled yes   &#x2F;&#x2F;开启集群模式</span><br><span class="line">cluster-config-file nodes.conf   &#x2F;&#x2F;集群的配置文件</span><br><span class="line">cluster-node-timeout 5000   &#x2F;&#x2F;认定节点下线的时间</span><br><span class="line">appendonly yes   &#x2F;&#x2F;开启aof持久化</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>官方建议三主三从来搭建集群(本集群采用3.2.11版本)</p>
<p>首先下载redis的源码 地址<a target="_blank" rel="noopener" href="http://download.redis.io/releases/redis-3.2.11.tar.gz">redis-3.2.11</a></p>
<ul>
<li>下载源码 修改文件权限<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-3.2.11.tar.gz</span><br><span class="line">sudo chmod  753 redis-3.2.11.tar.gz </span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>创建集群文件夹  解压redis源码 进入redis集群文件夹下的redis-3.2.11</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir &#x2F;usr&#x2F;local&#x2F;redisCluster</span><br><span class="line">sudo tar -zxvf redis-3.2.11.tar.gz -C &#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;</span><br><span class="line">cd &#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;redis-3.2.11&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>安装(该操作需要linux系统有c环境,如果报错请自行查阅资料安装) 以上操作后在src文件夹下会生成可执行文件 redis-server和redis-cli等,如果出现编译问题,请切换到root用户下操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make&amp;&amp;make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo vim redis.conf</span><br><span class="line"></span><br><span class="line">如下</span><br><span class="line"></span><br><span class="line">port 7000    &#x2F;&#x2F;端口号</span><br><span class="line">cluster-enabled yes   &#x2F;&#x2F;开启集群模式</span><br><span class="line">cluster-config-file nodes.conf   &#x2F;&#x2F;集群的配置文件</span><br><span class="line">cluster-node-timeout 5000   &#x2F;&#x2F;认定节点下线的时间</span><br><span class="line">appendonly yes   &#x2F;&#x2F;开启aof持久化</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>让我们进入一个新目录， 并创建六个以端口号为名字的子目录， 稍后我们在将每个目录中运行一个 Redis 实例</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br><span class="line">sudo mkdir 7000 7001 7002 7003 7004 7005 </span><br><span class="line"></span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo cp -r redis-3.2.11&#x2F;*  7000&#x2F;</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo cp -r redis-3.2.11&#x2F;*  7001&#x2F;</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo cp -r redis-3.2.11&#x2F;*  7002&#x2F;</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo cp -r redis-3.2.11&#x2F;*  7003&#x2F;</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo cp -r redis-3.2.11&#x2F;*  7004&#x2F;</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo cp -r redis-3.2.11&#x2F;*  7005&#x2F;</span><br><span class="line"></span><br><span class="line">现在只需修改每个配置文件下的port参数就行    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>然后进入每个端口号命名的文件夹下运行以下命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo .&#x2F;src&#x2F;redis-server redis.conf &amp;</span><br><span class="line"></span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ ps -ef|grep redis</span><br><span class="line">root      4700  3041  0 00:56 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4701  4700  0 00:56 pts&#x2F;4    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:7003 [cluster]</span><br><span class="line">root      4721  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4722  4721  0 00:57 pts&#x2F;4    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:7000 [cluster]</span><br><span class="line">root      4740  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4741  4740  0 00:57 pts&#x2F;4    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:7001 [cluster]</span><br><span class="line">root      4755  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4756  4755  0 00:57 pts&#x2F;4    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:7002 [cluster]</span><br><span class="line">root      4771  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4772  4771  0 00:57 pts&#x2F;4    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:7004 [cluster]</span><br><span class="line">root      4789  3041  0 00:58 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4790  4789  0 00:58 pts&#x2F;4    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:7005 [cluster]</span><br><span class="line">zhuning+  4794  3041  0 00:58 pts&#x2F;4    00:00:00 grep --color&#x3D;auto redis</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 Redis 集群命令行工具 redis-trib ， 编写节点配置文件的工作可以非常容易地完成</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ sudo .&#x2F;src&#x2F;redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 </span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line">127.0.0.1:7000</span><br><span class="line">127.0.0.1:7001</span><br><span class="line">127.0.0.1:7002</span><br><span class="line">Adding replica 127.0.0.1:7003 to 127.0.0.1:7000</span><br><span class="line">Adding replica 127.0.0.1:7004 to 127.0.0.1:7001</span><br><span class="line">Adding replica 127.0.0.1:7005 to 127.0.0.1:7002</span><br><span class="line">M: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">S: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   replicates a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">Can I set the above configuration? (type &#39;yes&#39; to accept): </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中–replicas 1表示每个主节点创建一个从节点,该命令自动为各个主节点分配槽位.m表示主节点,s表示从节点;</p>
<p>yes确认</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">Can I set the above configuration? (type &#39;yes&#39; to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">4722:M 06 Feb 01:04:46.722 # configEpoch set to 1 via CLUSTER SET-CONFIG-EPOCH</span><br><span class="line">4741:M 06 Feb 01:04:46.722 # configEpoch set to 2 via CLUSTER SET-CONFIG-EPOCH</span><br><span class="line">4756:M 06 Feb 01:04:46.723 # configEpoch set to 3 via CLUSTER SET-CONFIG-EPOCH</span><br><span class="line">4701:M 06 Feb 01:04:46.723 # configEpoch set to 4 via CLUSTER SET-CONFIG-EPOCH</span><br><span class="line">4772:M 06 Feb 01:04:46.724 # configEpoch set to 5 via CLUSTER SET-CONFIG-EPOCH</span><br><span class="line">4790:M 06 Feb 01:04:46.724 # configEpoch set to 6 via CLUSTER SET-CONFIG-EPOCH</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">4722:M 06 Feb 01:04:46.747 # IP address for this node updated to 127.0.0.1</span><br><span class="line">4741:M 06 Feb 01:04:46.801 # IP address for this node updated to 127.0.0.1</span><br><span class="line">4790:M 06 Feb 01:04:46.801 # IP address for this node updated to 127.0.0.1</span><br><span class="line">4701:M 06 Feb 01:04:46.801 # IP address for this node updated to 127.0.0.1</span><br><span class="line">4756:M 06 Feb 01:04:46.802 # IP address for this node updated to 127.0.0.1</span><br><span class="line">4772:M 06 Feb 01:04:46.802 # IP address for this node updated to 127.0.0.1</span><br><span class="line">Waiting for the cluster to join...</span><br><span class="line">4701:S 06 Feb 01:04:50.766 # Cluster state changed: ok</span><br><span class="line">4772:S 06 Feb 01:04:50.768 # Cluster state changed: ok</span><br><span class="line">4790:S 06 Feb 01:04:50.769 # Cluster state changed: ok</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">M: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">S: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ 4701:S 06 Feb 01:04:51.318 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:04:51.318 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:04:51.318 * Non blocking connect for SYNC fired the event.</span><br><span class="line">4701:S 06 Feb 01:04:51.318 * Master replied to PING, replication can continue...</span><br><span class="line">4701:S 06 Feb 01:04:51.319 * Partial resynchronization not possible (no cached master)</span><br><span class="line">4722:M 06 Feb 01:04:51.319 * Slave 127.0.0.1:7003 asks for synchronization</span><br><span class="line">4722:M 06 Feb 01:04:51.319 * Full resync requested by slave 127.0.0.1:7003</span><br><span class="line">4722:M 06 Feb 01:04:51.319 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">4722:M 06 Feb 01:04:51.320 * Background saving started by pid 5685</span><br><span class="line">4701:S 06 Feb 01:04:51.321 * Full resync from master: 4e9540a7b3c5c6caeb88fd51d09a1ecfc067fd5b:1</span><br><span class="line">5685:C 06 Feb 01:04:51.348 * DB saved on disk</span><br><span class="line">5685:C 06 Feb 01:04:51.350 * RDB: 6 MB of memory used by copy-on-write</span><br><span class="line">4722:M 06 Feb 01:04:51.426 * Background saving terminated with success</span><br><span class="line">4722:M 06 Feb 01:04:51.426 * Synchronization with slave 127.0.0.1:7003 succeeded</span><br><span class="line">4701:S 06 Feb 01:04:51.426 * MASTER &lt;-&gt; SLAVE sync: receiving 77 bytes from master</span><br><span class="line">4701:S 06 Feb 01:04:51.427 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">4701:S 06 Feb 01:04:51.427 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</span><br><span class="line">4701:S 06 Feb 01:04:51.427 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br><span class="line">4701:S 06 Feb 01:04:51.428 * Background append only file rewriting started by pid 5686</span><br><span class="line">4701:S 06 Feb 01:04:51.462 * AOF rewrite child asks to stop sending diffs.</span><br><span class="line">5686:C 06 Feb 01:04:51.462 * Parent agreed to stop sending diffs. Finalizing AOF...</span><br><span class="line">5686:C 06 Feb 01:04:51.462 * Concatenating 0.00 MB of AOF diff received from parent.</span><br><span class="line">5686:C 06 Feb 01:04:51.463 * SYNC append only file rewrite performed</span><br><span class="line">5686:C 06 Feb 01:04:51.463 * AOF rewrite: 6 MB of memory used by copy-on-write</span><br><span class="line">4701:S 06 Feb 01:04:51.519 * Background AOF rewrite terminated with success</span><br><span class="line">4701:S 06 Feb 01:04:51.520 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</span><br><span class="line">4701:S 06 Feb 01:04:51.520 * Background AOF rewrite finished successfully</span><br><span class="line">4772:S 06 Feb 01:04:51.527 * Connecting to MASTER 127.0.0.1:7001</span><br><span class="line">4772:S 06 Feb 01:04:51.527 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4772:S 06 Feb 01:04:51.527 * Non blocking connect for SYNC fired the event.</span><br><span class="line">4772:S 06 Feb 01:04:51.528 * Master replied to PING, replication can continue...</span><br><span class="line">4772:S 06 Feb 01:04:51.529 * Partial resynchronization not possible (no cached master)</span><br><span class="line">4741:M 06 Feb 01:04:51.529 * Slave 127.0.0.1:7004 asks for synchronization</span><br><span class="line">4741:M 06 Feb 01:04:51.529 * Full resync requested by slave 127.0.0.1:7004</span><br><span class="line">4741:M 06 Feb 01:04:51.529 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">4741:M 06 Feb 01:04:51.532 * Background saving started by pid 5687</span><br><span class="line">4772:S 06 Feb 01:04:51.535 * Full resync from master: be30d158d2de1e2edf37e74dc2c3cee348d02410:1</span><br><span class="line">5687:C 06 Feb 01:04:51.565 * DB saved on disk</span><br><span class="line">5687:C 06 Feb 01:04:51.566 * RDB: 6 MB of memory used by copy-on-write</span><br><span class="line">4790:S 06 Feb 01:04:51.584 * Connecting to MASTER 127.0.0.1:7002</span><br><span class="line">4790:S 06 Feb 01:04:51.584 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4790:S 06 Feb 01:04:51.584 * Non blocking connect for SYNC fired the event.</span><br><span class="line">4790:S 06 Feb 01:04:51.585 * Master replied to PING, replication can continue...</span><br><span class="line">4790:S 06 Feb 01:04:51.585 * Partial resynchronization not possible (no cached master)</span><br><span class="line">4756:M 06 Feb 01:04:51.585 * Slave 127.0.0.1:7005 asks for synchronization</span><br><span class="line">4756:M 06 Feb 01:04:51.585 * Full resync requested by slave 127.0.0.1:7005</span><br><span class="line">4756:M 06 Feb 01:04:51.585 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">4756:M 06 Feb 01:04:51.586 * Background saving started by pid 5688</span><br><span class="line">4790:S 06 Feb 01:04:51.587 * Full resync from master: 11082aa273a96447d9bdad8a6a004ea85878ad65:1</span><br><span class="line">4741:M 06 Feb 01:04:51.599 * Background saving terminated with success</span><br><span class="line">4772:S 06 Feb 01:04:51.600 * MASTER &lt;-&gt; SLAVE sync: receiving 77 bytes from master</span><br><span class="line">4741:M 06 Feb 01:04:51.600 * Synchronization with slave 127.0.0.1:7004 succeeded</span><br><span class="line">4772:S 06 Feb 01:04:51.600 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">4772:S 06 Feb 01:04:51.600 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</span><br><span class="line">4772:S 06 Feb 01:04:51.600 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br><span class="line">5688:C 06 Feb 01:04:51.624 * DB saved on disk</span><br><span class="line">4772:S 06 Feb 01:04:51.625 * Background append only file rewriting started by pid 5689</span><br><span class="line">5688:C 06 Feb 01:04:51.625 * RDB: 6 MB of memory used by copy-on-write</span><br><span class="line">4722:M 06 Feb 01:04:51.627 # Cluster state changed: ok</span><br><span class="line">4772:S 06 Feb 01:04:51.663 * AOF rewrite child asks to stop sending diffs.</span><br><span class="line">5689:C 06 Feb 01:04:51.663 * Parent agreed to stop sending diffs. Finalizing AOF...</span><br><span class="line">5689:C 06 Feb 01:04:51.663 * Concatenating 0.00 MB of AOF diff received from parent.</span><br><span class="line">5689:C 06 Feb 01:04:51.663 * SYNC append only file rewrite performed</span><br><span class="line">5689:C 06 Feb 01:04:51.664 * AOF rewrite: 6 MB of memory used by copy-on-write</span><br><span class="line">4756:M 06 Feb 01:04:51.665 * Background saving terminated with success</span><br><span class="line">4756:M 06 Feb 01:04:51.665 # Cluster state changed: ok</span><br><span class="line">4790:S 06 Feb 01:04:51.665 * MASTER &lt;-&gt; SLAVE sync: receiving 77 bytes from master</span><br><span class="line">4756:M 06 Feb 01:04:51.665 * Synchronization with slave 127.0.0.1:7005 succeeded</span><br><span class="line">4790:S 06 Feb 01:04:51.665 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">4790:S 06 Feb 01:04:51.665 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</span><br><span class="line">4790:S 06 Feb 01:04:51.665 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br><span class="line">4790:S 06 Feb 01:04:51.666 * Background append only file rewriting started by pid 5690</span><br><span class="line">4741:M 06 Feb 01:04:51.699 # Cluster state changed: ok</span><br><span class="line">4790:S 06 Feb 01:04:51.705 * AOF rewrite child asks to stop sending diffs.</span><br><span class="line">5690:C 06 Feb 01:04:51.705 * Parent agreed to stop sending diffs. Finalizing AOF...</span><br><span class="line">5690:C 06 Feb 01:04:51.706 * Concatenating 0.00 MB of AOF diff received from parent.</span><br><span class="line">5690:C 06 Feb 01:04:51.706 * SYNC append only file rewrite performed</span><br><span class="line">5690:C 06 Feb 01:04:51.707 * AOF rewrite: 4 MB of memory used by copy-on-write</span><br><span class="line">4772:S 06 Feb 01:04:51.727 * Background AOF rewrite terminated with success</span><br><span class="line">4772:S 06 Feb 01:04:51.727 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</span><br><span class="line">4772:S 06 Feb 01:04:51.727 * Background AOF rewrite finished successfully</span><br><span class="line">4790:S 06 Feb 01:04:51.785 * Background AOF rewrite terminated with success</span><br><span class="line">4790:S 06 Feb 01:04:51.785 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</span><br><span class="line">4790:S 06 Feb 01:04:51.785 * Background AOF rewrite finished successfully</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上为创建集群成功后的整个打印信息.</p>
<p>以下信息表示集群创建成功.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<p>连接上集群,查看集群信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ .&#x2F;src&#x2F;redis-cli -h 127.0.0.1 -p 7005</span><br><span class="line">127.0.0.1:7005&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:3</span><br><span class="line">cluster_stats_messages_sent:1559</span><br><span class="line">cluster_stats_messages_received:1559</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="检查集群"><a href="#检查集群" class="headerlink" title="检查集群"></a>检查集群</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ .&#x2F;src&#x2F;redis-cli -c -p 7005</span><br><span class="line">127.0.0.1:7005&gt; get foo</span><br><span class="line">-&gt; Redirected to slot [12182] located at 127.0.0.1:7002</span><br><span class="line">&quot;bar&quot;</span><br><span class="line">127.0.0.1:7002&gt; set test test</span><br><span class="line">-&gt; Redirected to slot [6918] located at 127.0.0.1:7001</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7001&gt; get test</span><br><span class="line">&quot;test&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面参数 -c表示集群客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7001&gt; get foo</span><br><span class="line">-&gt; Redirected to slot [12182] located at 127.0.0.1:7002</span><br><span class="line">&quot;bar&quot;</span><br><span class="line">127.0.0.1:7002&gt; get foo</span><br><span class="line">&quot;bar&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意以上语句 7002节点上存在foo/bar和cluster/test键值对,我们查看它对应的从节点7005的aof中存在的数据.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ cat -n appendonly.aof </span><br><span class="line">     1    *2</span><br><span class="line">     2    $6</span><br><span class="line">     3    SELECT</span><br><span class="line">     4    $1</span><br><span class="line">     5    0</span><br><span class="line">     6    *3</span><br><span class="line">     7    $3</span><br><span class="line">     8    set</span><br><span class="line">     9    $3</span><br><span class="line">    10    foo</span><br><span class="line">    11    $3</span><br><span class="line">    12    bar</span><br><span class="line">    13    *3</span><br><span class="line">    14    $3</span><br><span class="line">    15    set</span><br><span class="line">    16    $7</span><br><span class="line">    17    cluster</span><br><span class="line">    18    $4</span><br><span class="line">    19    test</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>aof中显示,7005节点存在两组键值对,表示主节点的数据同步到从节点上.</p>
<h2 id="集群故障"><a href="#集群故障" class="headerlink" title="集群故障"></a>集群故障</h2><p>查看集群的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7005&gt; cluster nodes</span><br><span class="line">442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005 myself,slave bb31a89640b381e8de18f15a845512f08ab9f16f 0 0 6 connected</span><br><span class="line">df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003 slave a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 0 1517851933524 4 connected</span><br><span class="line">0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001 master - 0 1517851932019 2 connected 5461-10922</span><br><span class="line">bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002 master - 0 1517851933023 3 connected 10923-16383</span><br><span class="line">37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004 slave 0ca3673dfd352052b651b3898ba3f807ff9c7f55 0 1517851932019 5 connected</span><br><span class="line">a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000 master - 0 1517851933023 1 connected 0-5460</span><br></pre></td></tr></table></figure>
<p>此时kill掉7000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ ps -ef|grep redis</span><br><span class="line">root      4700  3041  0 00:56 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4701  4700  0 00:56 pts&#x2F;4    00:00:04 .&#x2F;src&#x2F;redis-server 127.0.0.1:7003 [cluster]</span><br><span class="line">root      4721  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4722  4721  0 00:57 pts&#x2F;4    00:00:04 .&#x2F;src&#x2F;redis-server 127.0.0.1:7000 [cluster]</span><br><span class="line">root      4740  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4741  4740  0 00:57 pts&#x2F;4    00:00:04 .&#x2F;src&#x2F;redis-server 127.0.0.1:7001 [cluster]</span><br><span class="line">root      4755  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4756  4755  0 00:57 pts&#x2F;4    00:00:04 .&#x2F;src&#x2F;redis-server 127.0.0.1:7002 [cluster]</span><br><span class="line">root      4771  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4772  4771  0 00:57 pts&#x2F;4    00:00:04 .&#x2F;src&#x2F;redis-server 127.0.0.1:7004 [cluster]</span><br><span class="line">root      4789  3041  0 00:58 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4790  4789  0 00:58 pts&#x2F;4    00:00:04 .&#x2F;src&#x2F;redis-server 127.0.0.1:7005 [cluster]</span><br><span class="line">zhuning+ 10601  3041  0 01:33 pts&#x2F;4    00:00:00 grep --color&#x3D;auto redis</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ sudo kill -9 4722</span><br><span class="line">[sudo] password for zhuningning: </span><br><span class="line">4701:S 06 Feb 01:34:11.707 # Connection with master lost.</span><br><span class="line">4701:S 06 Feb 01:34:11.707 * Caching the disconnected master state.</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7005$ 4701:S 06 Feb 01:34:12.163 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:34:12.163 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:34:12.163 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">4701:S 06 Feb 01:34:13.168 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:34:13.169 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:34:13.169 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">4701:S 06 Feb 01:34:14.174 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:34:14.175 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:34:14.175 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">4701:S 06 Feb 01:34:15.180 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:34:15.181 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:34:15.181 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">4701:S 06 Feb 01:34:16.186 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:34:16.186 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:34:16.186 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">4701:S 06 Feb 01:34:17.190 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:34:17.190 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:34:17.190 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">4790:S 06 Feb 01:34:17.769 * Marking node a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 as failing (quorum reached).</span><br><span class="line">4790:S 06 Feb 01:34:17.769 # Cluster state changed: fail</span><br><span class="line">4756:M 06 Feb 01:34:18.088 * Marking node a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 as failing (quorum reached).</span><br><span class="line">4756:M 06 Feb 01:34:18.088 # Cluster state changed: fail</span><br><span class="line">4741:M 06 Feb 01:34:18.089 * FAIL message received from bb31a89640b381e8de18f15a845512f08ab9f16f about a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4</span><br><span class="line">4701:S 06 Feb 01:34:18.089 * FAIL message received from bb31a89640b381e8de18f15a845512f08ab9f16f about a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4</span><br><span class="line">4772:S 06 Feb 01:34:18.089 * FAIL message received from bb31a89640b381e8de18f15a845512f08ab9f16f about a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4</span><br><span class="line">4701:S 06 Feb 01:34:18.089 # Cluster state changed: fail</span><br><span class="line">4741:M 06 Feb 01:34:18.089 # Cluster state changed: fail</span><br><span class="line">4772:S 06 Feb 01:34:18.089 # Cluster state changed: fail</span><br><span class="line">4701:S 06 Feb 01:34:18.094 # Start of election delayed for 515 milliseconds (rank #0, offset 2465).</span><br><span class="line">4701:S 06 Feb 01:34:18.194 * Connecting to MASTER 127.0.0.1:7000</span><br><span class="line">4701:S 06 Feb 01:34:18.194 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">4701:S 06 Feb 01:34:18.194 # Error condition on socket for SYNC: Connection refused</span><br><span class="line">4701:S 06 Feb 01:34:18.697 # Starting a failover election for epoch 7.</span><br><span class="line">4756:M 06 Feb 01:34:18.740 # Failover auth granted to df9ac983886f0f09b0c62feef9288a9296a1a08c for epoch 7</span><br><span class="line">4741:M 06 Feb 01:34:18.740 # Failover auth granted to df9ac983886f0f09b0c62feef9288a9296a1a08c for epoch 7</span><br><span class="line">4701:S 06 Feb 01:34:18.740 # Failover election won: I&#39;m the new master.</span><br><span class="line">4701:S 06 Feb 01:34:18.740 # configEpoch set to 7 after successful failover</span><br><span class="line">4701:M 06 Feb 01:34:18.740 * Discarding previously cached master state.</span><br><span class="line">4701:M 06 Feb 01:34:18.740 # Cluster state changed: ok</span><br><span class="line">4756:M 06 Feb 01:34:18.782 # Cluster state changed: ok</span><br><span class="line">4772:S 06 Feb 01:34:18.782 # Cluster state changed: ok</span><br><span class="line">4741:M 06 Feb 01:34:18.782 # Cluster state changed: ok</span><br><span class="line">4790:S 06 Feb 01:34:18.782 # Cluster state changed: ok</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上信息表示,在五秒的尝试连接7000节点,发现其连接不上.某个节点首先将其标识为fail状态,然后通过节点间通讯,各个节点都将7000节点对应的状态置为fail状态,然后各个节点将集群状态标识为fail状态.然后各个节点为7000节点的从节点投票选举出7003(在这7000只有一个从节点)为主节点,代替元7000的工作(管理其对应的槽位),然后集群状态恢复.</p>
<p>此时集群状态如下: 7000 节点此时为fail状态,集群中正常的节点有5个.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7005&gt; cluster nodes</span><br><span class="line">442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005 myself,slave bb31a89640b381e8de18f15a845512f08ab9f16f 0 0 6 connected</span><br><span class="line">df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003 master - 0 1517852576553 7 connected 0-5460</span><br><span class="line">0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001 master - 0 1517852576054 2 connected 5461-10922</span><br><span class="line">bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002 master - 0 1517852575048 3 connected 10923-16383</span><br><span class="line">37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004 slave 0ca3673dfd352052b651b3898ba3f807ff9c7f55 0 1517852575552 5 connected</span><br><span class="line">a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000 master,fail - 1517852051773 1517852049869 1 disconnected</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="故障节点恢复"><a href="#故障节点恢复" class="headerlink" title="故障节点恢复"></a>故障节点恢复</h2><p>恢复节点7000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7000$ sudo .&#x2F;src&#x2F;redis-server redis.conf &amp;</span><br><span class="line"></span><br><span class="line">13569:M 06 Feb 01:45:53.163 # Server started, Redis version 3.2.11</span><br><span class="line">13569:M 06 Feb 01:45:53.163 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory&#x3D;1&#39; for this to take effect.</span><br><span class="line">13569:M 06 Feb 01:45:53.163 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&#39; as root, and add it to your &#x2F;etc&#x2F;rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br><span class="line">13569:M 06 Feb 01:45:53.164 * The server is now ready to accept connections on port 7000</span><br><span class="line">13569:M 06 Feb 01:45:53.165 # Configuration change detected. Reconfiguring myself as a replica of df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">13569:S 06 Feb 01:45:53.166 # Cluster state changed: ok</span><br><span class="line">4756:M 06 Feb 01:45:53.247 * Clear FAIL state for node a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4: master without slots is reachable again.</span><br><span class="line">4790:S 06 Feb 01:45:53.247 * Clear FAIL state for node a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4: master without slots is reachable again.</span><br><span class="line">4772:S 06 Feb 01:45:53.254 * Clear FAIL state for node a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4: master without slots is reachable again.</span><br><span class="line">4701:M 06 Feb 01:45:53.259 * Clear FAIL state for node a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4: master without slots is reachable again.</span><br><span class="line">4741:M 06 Feb 01:45:53.261 * Clear FAIL state for node a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4: master without slots is reachable again.</span><br><span class="line">13569:S 06 Feb 01:45:54.168 * Connecting to MASTER 127.0.0.1:7003</span><br><span class="line">13569:S 06 Feb 01:45:54.168 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">13569:S 06 Feb 01:45:54.168 * Non blocking connect for SYNC fired the event.</span><br><span class="line">13569:S 06 Feb 01:45:54.168 * Master replied to PING, replication can continue...</span><br><span class="line">13569:S 06 Feb 01:45:54.169 * Partial resynchronization not possible (no cached master)</span><br><span class="line">4701:M 06 Feb 01:45:54.169 * Slave 127.0.0.1:7000 asks for synchronization</span><br><span class="line">4701:M 06 Feb 01:45:54.169 * Full resync requested by slave 127.0.0.1:7000</span><br><span class="line">4701:M 06 Feb 01:45:54.169 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">4701:M 06 Feb 01:45:54.170 * Background saving started by pid 13572</span><br><span class="line">13569:S 06 Feb 01:45:54.171 * Full resync from master: cecbe45078fac08152e9ca95d7741ae086b4ea68:1</span><br><span class="line">13572:C 06 Feb 01:45:54.218 * DB saved on disk</span><br><span class="line">13572:C 06 Feb 01:45:54.219 * RDB: 6 MB of memory used by copy-on-write</span><br><span class="line">4701:M 06 Feb 01:45:54.261 * Background saving terminated with success</span><br><span class="line">13569:S 06 Feb 01:45:54.261 * MASTER &lt;-&gt; SLAVE sync: receiving 77 bytes from master</span><br><span class="line">4701:M 06 Feb 01:45:54.261 * Synchronization with slave 127.0.0.1:7000 succeeded</span><br><span class="line">13569:S 06 Feb 01:45:54.262 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">13569:S 06 Feb 01:45:54.262 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</span><br><span class="line">13569:S 06 Feb 01:45:54.262 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br><span class="line">13569:S 06 Feb 01:45:54.281 * Background append only file rewriting started by pid 13573</span><br><span class="line">13569:S 06 Feb 01:45:54.333 * AOF rewrite child asks to stop sending diffs.</span><br><span class="line">13573:C 06 Feb 01:45:54.333 * Parent agreed to stop sending diffs. Finalizing AOF...</span><br><span class="line">13573:C 06 Feb 01:45:54.333 * Concatenating 0.00 MB of AOF diff received from parent.</span><br><span class="line">13573:C 06 Feb 01:45:54.334 * SYNC append only file rewrite performed</span><br><span class="line">13573:C 06 Feb 01:45:54.334 * AOF rewrite: 4 MB of memory used by copy-on-write</span><br><span class="line">13569:S 06 Feb 01:45:54.382 * Background AOF rewrite terminated with success</span><br><span class="line">13569:S 06 Feb 01:45:54.382 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</span><br><span class="line">13569:S 06 Feb 01:45:54.382 * Background AOF rewrite finished successfully</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以下两种方式检查集群的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7000$ .&#x2F;src&#x2F;redis-cli -c -p 7000</span><br><span class="line">127.0.0.1:7000&gt; cluster nodes</span><br><span class="line">37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004 slave 0ca3673dfd352052b651b3898ba3f807ff9c7f55 0 1517852872929 5 connected</span><br><span class="line">df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003 master - 0 1517852872427 7 connected 0-5460</span><br><span class="line">442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005 slave bb31a89640b381e8de18f15a845512f08ab9f16f 0 1517852873431 6 connected</span><br><span class="line">bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002 master - 0 1517852873431 3 connected 10923-16383</span><br><span class="line">0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001 master - 0 1517852871424 2 connected 5461-10922</span><br><span class="line">a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000 myself,slave df9ac983886f0f09b0c62feef9288a9296a1a08c 0 0 1 connected</span><br><span class="line">127.0.0.1:7000&gt; quit</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7000$ .&#x2F;src&#x2F;redis-trib.rb check 127.0.0.1:7001</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7001)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时7000节点变为7003节点的从节点</p>
<h2 id="集群中新加入删除节点"><a href="#集群中新加入删除节点" class="headerlink" title="集群中新加入删除节点"></a>集群中新加入删除节点</h2><h3 id="作为主节点加入"><a href="#作为主节点加入" class="headerlink" title="作为主节点加入"></a>作为主节点加入</h3><p>新复制一个节点7006,修改其端口号配置,然后启动.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo mkdir 7006 </span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster$ sudo cp redis-3.2.11&#x2F;* -r 7006&#x2F;</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster$ cd 7006</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ sudo .&#x2F;src&#x2F;redis-server redis.conf &amp;</span><br><span class="line">[8] 15048</span><br><span class="line"></span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ ps -ef|grep redis</span><br><span class="line">root      4700  3041  0 00:56 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4701  4700  0 00:56 pts&#x2F;4    00:00:09 .&#x2F;src&#x2F;redis-server 127.0.0.1:7003 [cluster]</span><br><span class="line">root      4740  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4741  4740  0 00:57 pts&#x2F;4    00:00:09 .&#x2F;src&#x2F;redis-server 127.0.0.1:7001 [cluster]</span><br><span class="line">root      4755  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4756  4755  0 00:57 pts&#x2F;4    00:00:09 .&#x2F;src&#x2F;redis-server 127.0.0.1:7002 [cluster]</span><br><span class="line">root      4771  3041  0 00:57 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4772  4771  0 00:57 pts&#x2F;4    00:00:08 .&#x2F;src&#x2F;redis-server 127.0.0.1:7004 [cluster]</span><br><span class="line">root      4789  3041  0 00:58 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root      4790  4789  0 00:58 pts&#x2F;4    00:00:09 .&#x2F;src&#x2F;redis-server 127.0.0.1:7005 [cluster]</span><br><span class="line">root     13568  3041  0 01:45 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root     13569 13568  0 01:45 pts&#x2F;4    00:00:01 .&#x2F;src&#x2F;redis-server 127.0.0.1:7000 [cluster]</span><br><span class="line">root     15048  3041  0 01:55 pts&#x2F;4    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root     15049 15048  0 01:55 pts&#x2F;4    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:7006 [cluster]</span><br><span class="line">zhuning+ 15139  3041  0 01:55 pts&#x2F;4    00:00:00 grep --color&#x3D;auto redis</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>加入新节点7006</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ .&#x2F;src&#x2F;redis-trib.rb add-node 127.0.0.1:7006 127.0.0.1:7000</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Adding node 127.0.0.1:7006 to cluster 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">S: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node 127.0.0.1:7006 to make it join the cluster.</span><br><span class="line">[OK] New node added correctly.</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ 15049:M 06 Feb 01:57:40.626 # IP address for this node updated to 127.0.0.1</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ 15049:M 06 Feb 01:57:45.733 # Cluster state changed: ok</span><br></pre></td></tr></table></figure>

<p>add-node是加入指令，127.0.0.1:7006 表示新加入的节点，127.0.0.1:7000 表示加入的集群的一个节点，用来辨识是哪个集群，理论上哪个都可以。</p>
<p>检查集群状态,此时7006为master节点,处于无槽位状态.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ .&#x2F;src&#x2F;redis-trib.rb check 127.0.0.1:7006</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7006)</span><br><span class="line">M: 54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line">   0 additional replica(s)</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看来，redis cluster 不是在新加节点的时候帮我们做好了迁移工作，需要我们手动对集群进行重新分片迁移，也是这个命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ .&#x2F;src&#x2F;redis-trib.rb reshard 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">S: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line">   0 additional replica(s)</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 4096</span><br><span class="line">What is the receiving node ID? efc3131fbdc6cf929720e0e0f7136cae85657481</span><br><span class="line">*** The specified node is not known or not a master, please retry.</span><br><span class="line">What is the receiving node ID? 54fe323634d8830f2ef93feaaedb2b70e19d0765</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type &#39;all&#39; to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type &#39;done&#39; once you entered all the source nodes IDs.</span><br><span class="line">Source node #1:all</span><br><span class="line"></span><br><span class="line">Ready to move 4096 slots.</span><br><span class="line">  Source nodes:</span><br><span class="line">    M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">    M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">    M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">  Destination node:</span><br><span class="line">    M: 54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006</span><br><span class="line">   slots: (0 slots) master</span><br><span class="line">   0 additional replica(s)</span><br><span class="line">  Resharding plan:</span><br><span class="line">    Moving slot 5461 from 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第一个问句 how many slots do you want to move 平均的4096个</p>
<p>第二个问句,接收节点的id :7006对应的节点id:efc3131fbdc6cf929720e0e0f7136cae85657481</p>
<p>第三个问句,从哪获取这些槽位,  如果我们不打算从特定的节点上取出指定数量的哈希槽， 那么可以向 redis-trib 输入 all ， 这样的话， 集群中的所有主节点都会成为源节点.</p>
<p>它会提示是否迁移,输入yes即可,但是最后出现如下的error,查阅资料说时cluster的 <a target="_blank" rel="noopener" href="https://github.com/antirez/redis/issues/4272">bug</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[ERR] Calling MIGRATE: ERR Syntax error, try CLIENT (LIST | KILL | GETNAME | SETNAME | PAUSE | REPLY)</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ .&#x2F;src&#x2F;redis-trib.rb reshard 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">S: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:1365-5460 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006</span><br><span class="line">   slots:0-1364,5461-6826,10923-12181 (3990 slots) master</span><br><span class="line">   0 additional replica(s)</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:12182-16383 (4202 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:6827-10922 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">[WARNING] Node 127.0.0.1:7006 has slots in importing state (12182).</span><br><span class="line">[WARNING] Node 127.0.0.1:7002 has slots in migrating state (12182).</span><br><span class="line">[WARNING] The following slots are open: 12182</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">*** Please fix your cluster problems before resharding</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>12182这个数字看着比较熟悉,原来是之前的该槽位中有数据.暂时还么有解决.(???????????)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7006$ .&#x2F;src&#x2F;redis-cli -c -p 7006</span><br><span class="line">127.0.0.1:7006&gt; cluster nodes</span><br><span class="line">37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004 slave 0ca3673dfd352052b651b3898ba3f807ff9c7f55 0 1517854904123 2 connected</span><br><span class="line">df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003 master - 0 1517854903119 7 connected 1365-5460</span><br><span class="line">442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005 slave bb31a89640b381e8de18f15a845512f08ab9f16f 0 1517854903119 3 connected</span><br><span class="line">bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002 master - 0 1517854903621 3 connected 12182-16383</span><br><span class="line">54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006 myself,master - 0 0 8 connected 0-1364 5461-6826 10923-12181 [12182-&lt;-bb31a89640b381e8de18f15a845512f08ab9f16f]</span><br><span class="line">0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001 master - 0 1517854903621 2 connected 6827-10922</span><br><span class="line">a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000 slave df9ac983886f0f09b0c62feef9288a9296a1a08c 0 1517854902617 7 connected</span><br><span class="line">127.0.0.1:7006&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:7</span><br><span class="line">cluster_size:4</span><br><span class="line">cluster_current_epoch:8</span><br><span class="line">cluster_my_epoch:8</span><br><span class="line">cluster_stats_messages_sent:7375</span><br><span class="line">cluster_stats_messages_received:7362</span><br><span class="line"></span><br><span class="line">127.0.0.1:7001&gt; set age 100</span><br><span class="line">-&gt; Redirected to slot [741] located at 127.0.0.1:7006</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7006&gt; get age</span><br><span class="line">&quot;100&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>暂时集群时可以用的,不知道以上的error有啥影响.</p>
<h3 id="新建一个7007从节点"><a href="#新建一个7007从节点" class="headerlink" title="新建一个7007从节点"></a>新建一个7007从节点</h3><p>新建一个节点,启动和之前类似,不做描述.</p>
<p>加入一个新节点,7007 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7007$ .&#x2F;src&#x2F;redis-trib.rb add-node --slave 127.0.0.1:7007 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Adding node 127.0.0.1:7007 to cluster 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">S: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:1365-5460 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006</span><br><span class="line">   slots:0-1364,5461-6826,10923-12181 (3990 slots) master</span><br><span class="line">   0 additional replica(s)</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:12182-16383 (4202 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:6827-10922 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">[WARNING] Node 127.0.0.1:7006 has slots in importing state (12182).</span><br><span class="line">[WARNING] Node 127.0.0.1:7002 has slots in migrating state (12182).</span><br><span class="line">[WARNING] The following slots are open: 12182</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">Automatically selected master 127.0.0.1:7006</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node 127.0.0.1:7007 to make it join the cluster.</span><br><span class="line">Waiting for the cluster to join.20427:M 06 Feb 02:30:11.160 # IP address for this node updated to 127.0.0.1</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Configure node as replica of 127.0.0.1:7006.</span><br><span class="line">20427:S 06 Feb 02:30:12.032 # Cluster state changed: ok</span><br><span class="line">[OK] New node added correctly.</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7007$ 20427:S 06 Feb 02:30:12.136 * Connecting to MASTER 127.0.0.1:7006</span><br><span class="line">20427:S 06 Feb 02:30:12.136 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">20427:S 06 Feb 02:30:12.136 * Non blocking connect for SYNC fired the event.</span><br><span class="line">20427:S 06 Feb 02:30:12.136 * Master replied to PING, replication can continue...</span><br><span class="line">20427:S 06 Feb 02:30:12.137 * Partial resynchronization not possible (no cached master)</span><br><span class="line">15049:M 06 Feb 02:30:12.137 * Slave 127.0.0.1:7007 asks for synchronization</span><br><span class="line">15049:M 06 Feb 02:30:12.137 * Full resync requested by slave 127.0.0.1:7007</span><br><span class="line">15049:M 06 Feb 02:30:12.137 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">15049:M 06 Feb 02:30:12.138 * Background saving started by pid 20906</span><br><span class="line">20427:S 06 Feb 02:30:12.139 * Full resync from master: defd3e21a2f15f27e3319035074c5002d4ff4b1b:1</span><br><span class="line">20906:C 06 Feb 02:30:12.500 * DB saved on disk</span><br><span class="line">20906:C 06 Feb 02:30:12.501 * RDB: 6 MB of memory used by copy-on-write</span><br><span class="line">15049:M 06 Feb 02:30:12.509 * Background saving terminated with success</span><br><span class="line">20427:S 06 Feb 02:30:12.510 * MASTER &lt;-&gt; SLAVE sync: receiving 89 bytes from master</span><br><span class="line">15049:M 06 Feb 02:30:12.510 * Synchronization with slave 127.0.0.1:7007 succeeded</span><br><span class="line">20427:S 06 Feb 02:30:12.510 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">20427:S 06 Feb 02:30:12.510 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</span><br><span class="line">20427:S 06 Feb 02:30:12.510 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br><span class="line">20427:S 06 Feb 02:30:12.512 * Background append only file rewriting started by pid 20907</span><br><span class="line">20427:S 06 Feb 02:30:12.581 * AOF rewrite child asks to stop sending diffs.</span><br><span class="line">20907:C 06 Feb 02:30:12.582 * Parent agreed to stop sending diffs. Finalizing AOF...</span><br><span class="line">20907:C 06 Feb 02:30:12.582 * Concatenating 0.00 MB of AOF diff received from parent.</span><br><span class="line">20907:C 06 Feb 02:30:12.582 * SYNC append only file rewrite performed</span><br><span class="line">20907:C 06 Feb 02:30:12.583 * AOF rewrite: 6 MB of memory used by copy-on-write</span><br><span class="line">20427:S 06 Feb 02:30:12.639 * Background AOF rewrite terminated with success</span><br><span class="line">20427:S 06 Feb 02:30:12.639 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</span><br><span class="line">20427:S 06 Feb 02:30:12.639 * Background AOF rewrite finished successfully</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>add-node的时候加上–slave表示是加入到从节点中，但是这样加，是随机的。这里的命令行完全像我们在添加一个新主服务器时使用的一样，所以我们没有指定要给哪个主服 务器添加副本。这种情况下，redis-trib 会将7007作为一个具有较少副本的随机的主服务器的副本。</p>
<ul>
<li>加入从节点,为该从节点指定一个主节点 </li>
</ul>
<p>新建7008节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7008$ .&#x2F;src&#x2F;redis-trib.rb add-node --slave --master-id df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7008 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Adding node 127.0.0.1:7008 to cluster 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">S: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates df9ac983886f0f09b0c62feef9288a9296a1a08c</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">M: df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003</span><br><span class="line">   slots:1365-5460 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: db439109563a804d8d63ffdb6937baf88adde5cc 127.0.0.1:7007</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 54fe323634d8830f2ef93feaaedb2b70e19d0765</span><br><span class="line">M: 54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006</span><br><span class="line">   slots:0-1364,5461-6826,10923-12181 (3990 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:12182-16383 (4202 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:6827-10922 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">[WARNING] Node 127.0.0.1:7006 has slots in importing state (12182).</span><br><span class="line">[WARNING] Node 127.0.0.1:7002 has slots in migrating state (12182).</span><br><span class="line">[WARNING] The following slots are open: 12182</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node 127.0.0.1:7008 to make it join the cluster.</span><br><span class="line">Waiting for the cluster to join.21391:M 06 Feb 02:36:05.351 # IP address for this node updated to 127.0.0.1</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Configure node as replica of 127.0.0.1:7003.</span><br><span class="line">21391:S 06 Feb 02:36:06.188 # Cluster state changed: ok</span><br><span class="line">[OK] New node added correctly.</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7008$ 21391:S 06 Feb 02:36:06.612 * Connecting to MASTER 127.0.0.1:7003</span><br><span class="line">21391:S 06 Feb 02:36:06.612 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">21391:S 06 Feb 02:36:06.612 * Non blocking connect for SYNC fired the event.</span><br><span class="line">21391:S 06 Feb 02:36:06.613 * Master replied to PING, replication can continue...</span><br><span class="line">21391:S 06 Feb 02:36:06.613 * Partial resynchronization not possible (no cached master)</span><br><span class="line">4701:M 06 Feb 02:36:06.613 * Slave 127.0.0.1:7008 asks for synchronization</span><br><span class="line">4701:M 06 Feb 02:36:06.614 * Full resync requested by slave 127.0.0.1:7008</span><br><span class="line">4701:M 06 Feb 02:36:06.614 * Starting BGSAVE for SYNC with target: disk</span><br><span class="line">4701:M 06 Feb 02:36:06.616 * Background saving started by pid 21659</span><br><span class="line">21391:S 06 Feb 02:36:06.617 * Full resync from master: cecbe45078fac08152e9ca95d7741ae086b4ea68:4201</span><br><span class="line">21659:C 06 Feb 02:36:06.659 * DB saved on disk</span><br><span class="line">21659:C 06 Feb 02:36:06.660 * RDB: 8 MB of memory used by copy-on-write</span><br><span class="line">4701:M 06 Feb 02:36:06.753 * Background saving terminated with success</span><br><span class="line">4701:M 06 Feb 02:36:06.753 * Synchronization with slave 127.0.0.1:7008 succeeded</span><br><span class="line">21391:S 06 Feb 02:36:06.753 * MASTER &lt;-&gt; SLAVE sync: receiving 77 bytes from master</span><br><span class="line">21391:S 06 Feb 02:36:06.754 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">21391:S 06 Feb 02:36:06.754 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</span><br><span class="line">21391:S 06 Feb 02:36:06.754 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br><span class="line">21391:S 06 Feb 02:36:06.755 * Background append only file rewriting started by pid 21660</span><br><span class="line">21391:S 06 Feb 02:36:06.790 * AOF rewrite child asks to stop sending diffs.</span><br><span class="line">21660:C 06 Feb 02:36:06.790 * Parent agreed to stop sending diffs. Finalizing AOF...</span><br><span class="line">21660:C 06 Feb 02:36:06.791 * Concatenating 0.00 MB of AOF diff received from parent.</span><br><span class="line">21660:C 06 Feb 02:36:06.791 * SYNC append only file rewrite performed</span><br><span class="line">21660:C 06 Feb 02:36:06.792 * AOF rewrite: 6 MB of memory used by copy-on-write</span><br><span class="line">21391:S 06 Feb 02:36:06.814 * Background AOF rewrite terminated with success</span><br><span class="line">21391:S 06 Feb 02:36:06.814 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</span><br><span class="line">21391:S 06 Feb 02:36:06.814 * Background AOF rewrite finished successfully</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>–master-id 指定7003节点成为7008节点的主节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7008$ .&#x2F;src&#x2F;redis-cli -c -p 7008 </span><br><span class="line">127.0.0.1:7008&gt; cluster nodes</span><br><span class="line">db439109563a804d8d63ffdb6937baf88adde5cc 127.0.0.1:7007 slave 54fe323634d8830f2ef93feaaedb2b70e19d0765 0 1517855860750 8 connected</span><br><span class="line">bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002 master - 0 1517855861752 3 connected 12182-16383</span><br><span class="line">54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006 master - 0 1517855861751 8 connected 0-1364 5461-6826 10923-12181</span><br><span class="line">df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003 master - 0 1517855859747 7 connected 1365-5460</span><br><span class="line">0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001 master - 0 1517855860248 2 connected 6827-10922</span><br><span class="line">37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004 slave 0ca3673dfd352052b651b3898ba3f807ff9c7f55 0 1517855861251 2 connected</span><br><span class="line">442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005 slave bb31a89640b381e8de18f15a845512f08ab9f16f 0 1517855860750 3 connected</span><br><span class="line">c29ea305fc8283a9987629b10dbc2ccae97c0c38 127.0.0.1:7008 myself,slave df9ac983886f0f09b0c62feef9288a9296a1a08c 0 0 0 connected</span><br><span class="line">a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000 slave df9ac983886f0f09b0c62feef9288a9296a1a08c 0 1517855860248 7 connected</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>7003是7008和7000的主节点,kill掉70003,7000成为主节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7008&gt; cluster nodes</span><br><span class="line">db439109563a804d8d63ffdb6937baf88adde5cc 127.0.0.1:7007 slave 54fe323634d8830f2ef93feaaedb2b70e19d0765 0 1517856011263 8 connected</span><br><span class="line">bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002 master - 0 1517856010761 3 connected 12182-16383</span><br><span class="line">54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006 master - 0 1517856010862 8 connected 0-1364 5461-6826 10923-12181</span><br><span class="line">df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003 master,fail - 1517855992209 1517855990103 7 disconnected</span><br><span class="line">0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001 master - 0 1517856009257 2 connected 6827-10922</span><br><span class="line">37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004 slave 0ca3673dfd352052b651b3898ba3f807ff9c7f55 0 1517856010761 2 connected</span><br><span class="line">442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005 slave bb31a89640b381e8de18f15a845512f08ab9f16f 0 1517856009757 3 connected</span><br><span class="line">c29ea305fc8283a9987629b10dbc2ccae97c0c38 127.0.0.1:7008 myself,slave a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 0 0 0 connected</span><br><span class="line">a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000 master - 0 1517856010258 9 connected 1365-5460</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="移除一个主节点"><a href="#移除一个主节点" class="headerlink" title="移除一个主节点"></a>移除一个主节点</h3><p>和新加节点有点不同的是，移除需要节点的node-id。那我们尝试将7002这个主节点移除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7008$ .&#x2F;src&#x2F;redis-trib.rb del-node 127.0.0.1:7000 bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">&gt;&gt;&gt; Removing node bb31a89640b381e8de18f15a845512f08ab9f16f from cluster 127.0.0.1:7000</span><br><span class="line">[ERR] Node 127.0.0.1:7002 is not empty! Reshard data away and try again.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>提示节点非空,需要重新分片</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7008$ .&#x2F;src&#x2F;redis-trib.rb reshard 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">M: a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000</span><br><span class="line">   slots:1365-5460 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: db439109563a804d8d63ffdb6937baf88adde5cc 127.0.0.1:7007</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 54fe323634d8830f2ef93feaaedb2b70e19d0765</span><br><span class="line">M: 54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006</span><br><span class="line">   slots:0-1364,5461-6826,10923-12181 (3990 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001</span><br><span class="line">   slots:6827-10922 (4096 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: c29ea305fc8283a9987629b10dbc2ccae97c0c38 127.0.0.1:7008</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4</span><br><span class="line">S: 37b5d56cbce25be2e3ad25b52ce39e3e4885654e 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0ca3673dfd352052b651b3898ba3f807ff9c7f55</span><br><span class="line">S: 442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bb31a89640b381e8de18f15a845512f08ab9f16f</span><br><span class="line">M: bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002</span><br><span class="line">   slots:12182-16383 (4202 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">[WARNING] Node 127.0.0.1:7006 has slots in importing state (12182).</span><br><span class="line">[WARNING] Node 127.0.0.1:7002 has slots in migrating state (12182).</span><br><span class="line">[WARNING] The following slots are open: 12182</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">*** Please fix your cluster problems before resharding</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于上面的error,现在不能重新分片,所以暂时没办法演示删除主节点.如果你的可以重新分片,则将7002中的槽位移动到其它某个master节点(不知道slave节点是否可以,读者可以自行实验).</p>
<p>然后重新执行删除操作即可.</p>
<h3 id="移除一个从节点"><a href="#移除一个从节点" class="headerlink" title="移除一个从节点"></a>移除一个从节点</h3><p>由于不考虑数据迁移,则直接删除即可,在此删除从节点7004</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7008$ .&#x2F;src&#x2F;redis-trib.rb del-node 127.0.0.1:7000 37b5d56cbce25be2e3ad25b52ce39e3e4885654e</span><br><span class="line">&gt;&gt;&gt; Removing node 37b5d56cbce25be2e3ad25b52ce39e3e4885654e from cluster 127.0.0.1:7000</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="line">&gt;&gt;&gt; SHUTDOWN the node.</span><br><span class="line">4772:S 06 Feb 02:52:42.770 # User requested shutdown...</span><br><span class="line">4772:S 06 Feb 02:52:42.770 * Calling fsync() on the AOF file.</span><br><span class="line">4772:S 06 Feb 02:52:42.770 * Saving the final RDB snapshot before exiting.</span><br><span class="line">4772:S 06 Feb 02:52:42.860 * DB saved on disk</span><br><span class="line">4772:S 06 Feb 02:52:42.860 * Removing the pid file.</span><br><span class="line">4772:S 06 Feb 02:52:42.860 # Redis is now ready to exit, bye bye...</span><br><span class="line">4741:M 06 Feb 02:52:42.861 # Connection with slave 127.0.0.1:7004 lost.</span><br><span class="line">[5]   Done                    sudo .&#x2F;src&#x2F;redis-server redis.conf  (wd: &#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7004)</span><br><span class="line">(wd now: &#x2F;usr&#x2F;local&#x2F;redisCluster&#x2F;7008)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查询集群状态,被删除的和fail状态的不同.fail仍然数据该集群,恢复后仍然可以加入集群,删除则不存在集群了,需要手动操作去加入集群.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7008&gt; cluster nodes</span><br><span class="line">db439109563a804d8d63ffdb6937baf88adde5cc 127.0.0.1:7007 slave 54fe323634d8830f2ef93feaaedb2b70e19d0765 0 1517856814381 8 connected</span><br><span class="line">bb31a89640b381e8de18f15a845512f08ab9f16f 127.0.0.1:7002 master - 0 1517856814884 3 connected 12182-16383</span><br><span class="line">54fe323634d8830f2ef93feaaedb2b70e19d0765 127.0.0.1:7006 master - 0 1517856814884 8 connected 0-1364 5461-6826 10923-12181</span><br><span class="line">df9ac983886f0f09b0c62feef9288a9296a1a08c 127.0.0.1:7003 master,fail - 1517855992209 1517855990103 7 disconnected</span><br><span class="line">0ca3673dfd352052b651b3898ba3f807ff9c7f55 127.0.0.1:7001 master - 0 1517856815383 2 connected 6827-10922</span><br><span class="line">442c6654dfda38fe6544c96627fcafaac833a7be 127.0.0.1:7005 slave bb31a89640b381e8de18f15a845512f08ab9f16f 0 1517856814381 3 connected</span><br><span class="line">c29ea305fc8283a9987629b10dbc2ccae97c0c38 127.0.0.1:7008 myself,slave a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 0 0 0 connected</span><br><span class="line">a05c8dcbd5e7861000b3b5bf7e28d6843c85efe4 127.0.0.1:7000 master - 0 1517856813375 9 connected 1365-5460</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.zybuluo.com/phper/note/195558">redis集群研究和实践</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.51cto.com/hsbxxl/1978491">在线迁移redis cluster</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-28/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-28/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-cluster/" class="post-title-link" itemprop="url">redis设计与实现-cluster</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-28 00:18:54" itemprop="dateCreated datePublished" datetime="2018-01-28T00:18:54+08:00">2018-01-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Redis集群时redis提供的分布式数据库方案.</p>
<h1 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h1><p>一个 Redis 集群通常由多个节点（node）组成， 在刚开始的时候， 每个节点都是相互独立的， 它们都处于一个只包含自己的集群当中， 要组建一个真正可工作的集群， 我们必须将各个独立的节点连接起来， 构成一个包含多个节点的集群。</p>
<p>当一个节点使用下面的命令时,使得ip和port制定的节点进行握手,当捂手成功后,node节点就会将该ip和port所在的节点添加到自己的集群中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER MEET &lt;ip&gt; &lt;port&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>假设我们当前有三个节点:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root     21254  9329  0 01:35 pts&#x2F;2    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root     21255 21254  0 01:35 pts&#x2F;2    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:6002 [cluster]</span><br><span class="line">root     21263  9329  0 01:36 pts&#x2F;2    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root     21264 21263  0 01:36 pts&#x2F;2    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:6001 [cluster]</span><br><span class="line">root     21283  9329  0 01:36 pts&#x2F;2    00:00:00 sudo .&#x2F;src&#x2F;redis-server redis.conf</span><br><span class="line">root     21284 21283  0 01:36 pts&#x2F;2    00:00:00 .&#x2F;src&#x2F;redis-server 127.0.0.1:6000 [cluster]</span><br><span class="line">zhuning+ 21466  9329  0 01:37 pts&#x2F;2    00:00:00 grep --color&#x3D;auto redis</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将节点加入集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisClusterTest&#x2F;6000&#x2F;src$ .&#x2F;redis-cli -p 127.0.0.1 -p 6000</span><br><span class="line">127.0.0.1:6000&gt; cluster nodes</span><br><span class="line">e6f7de12f623d0a92da8aa307a7ee224da73b92e :6000 myself,master - 0 0 0 connected</span><br><span class="line">127.0.0.1:6000&gt; cluster meet 127.0.0.1 6001</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6000&gt; 21264:M 29 Jan 01:39:45.936 # IP address for this node updated to 127.0.0.1</span><br><span class="line">                                                                                           21284:M 29 Jan 01:39:45.975 # IP address for this node updated to 127.0.0.1 </span><br><span class="line">127.0.0.1:6000&gt; cluster nodes</span><br><span class="line">5e57d9227987c64486ec791217b64712ad201016 127.0.0.1:6001 master - 0 1517161211620 1 connected</span><br><span class="line">e6f7de12f623d0a92da8aa307a7ee224da73b92e 127.0.0.1:6000 myself,master - 0 0 0 connected</span><br><span class="line">127.0.0.1:6000&gt; cluster meet 127.0.0.1 6002</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6000&gt; 21255:M 29 Jan 01:41:29.250 # IP address for this node updated to 127.0.0.1</span><br><span class="line">127.0.0.1:6000&gt; </span><br><span class="line">127.0.0.1:6000&gt; clsuter nodes</span><br><span class="line">(error) ERR unknown command &#39;clsuter&#39;</span><br><span class="line">127.0.0.1:6000&gt; cluster nodes</span><br><span class="line">94a98e405ec368ad45469b9d5fb0e019bdf2d796 127.0.0.1:6002 master - 0 1517161300885 2 connected</span><br><span class="line">5e57d9227987c64486ec791217b64712ad201016 127.0.0.1:6001 master - 0 1517161299882 1 connected</span><br><span class="line">e6f7de12f623d0a92da8aa307a7ee224da73b92e 127.0.0.1:6000 myself,master - 0 0 0 connected</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上是建立集群的过程</p>
<h2 id="启动节点"><a href="#启动节点" class="headerlink" title="启动节点"></a>启动节点</h2><p>启动的时候redis会根据参数cluster-enabled参数来决定是否启动集群模式.</p>
<p>node在集群模式下仍然会使用单机集群的功能,比如运行serverCron函数,而serverCron函数又会调用clusterCron函数.</p>
<p>除此之外节点会继续使用 redisServer 结构来保存服务器的状态， 使用 redisClient 结构来保存客户端的状态， 至于那些只有在集群模式下才会用到的数据， 节点将它们保存到了 cluster.h/clusterNode 结构， cluster.h/clusterLink 结构， 以及 cluster.h/clusterState 结构里面</p>
<h2 id="集群数据结构"><a href="#集群数据结构" class="headerlink" title="集群数据结构"></a>集群数据结构</h2><p>每个节点都会使用一个 clusterNode 结构来记录自己的状态， 并为集群中的所有其他节点（包括主节点和从节点）都创建一个相应的 clusterNode 结构</p>
<p>结构如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">struct clusterNode &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 创建节点的时间</span><br><span class="line">    mstime_t ctime;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 节点的名字，由 40 个十六进制字符组成</span><br><span class="line">    &#x2F;&#x2F; 例如 68eef66df23420a5862208ef5b1a7005b806f2ff</span><br><span class="line">    char name[REDIS_CLUSTER_NAMELEN];</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 节点标识</span><br><span class="line">    &#x2F;&#x2F; 使用各种不同的标识值记录节点的角色（比如主节点或者从节点），</span><br><span class="line">    &#x2F;&#x2F; 以及节点目前所处的状态（比如在线或者下线）。</span><br><span class="line">    int flags;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 节点当前的配置纪元，用于实现故障转移</span><br><span class="line">    uint64_t configEpoch;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 节点的 IP 地址</span><br><span class="line">    char ip[REDIS_IP_STR_LEN];</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 节点的端口号</span><br><span class="line">    int port;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 保存连接节点所需的有关信息</span><br><span class="line">    clusterLink *link;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>clusterNode 结构的 link 属性是一个 clusterLink 结构， 该结构保存了连接节点所需的有关信息， 比如套接字描述符， 输入缓冲区和输出缓冲区：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">typedef struct clusterLink &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 连接的创建时间</span><br><span class="line">    mstime_t ctime;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; TCP 套接字描述符</span><br><span class="line">    int fd;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 输出缓冲区，保存着等待发送给其他节点的消息（message）。</span><br><span class="line">    sds sndbuf;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 输入缓冲区，保存着从其他节点接收到的消息。</span><br><span class="line">    sds rcvbuf;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 与这个连接相关联的节点，如果没有的话就为 NULL</span><br><span class="line">    struct clusterNode *node;</span><br><span class="line"></span><br><span class="line">&#125; clusterLink;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>redisClient 结构和 clusterLink 结构的相同和不同之处</li>
</ul>
<p>redisClient 结构和 clusterLink 结构都有自己的套接字描述符和输入、输出缓冲区， 这两个结构的区别在于， redisClient 结构中的套接字和缓冲区是用于连接客户端的， 而 clusterLink 结构中的套接字和缓冲区则是用于连接节点的。</p>
<p>每个节点都保存着一个 clusterState 结构， 这个结构记录了在当前节点的视角下， 集群目前所处的状态 —— 比如集群是在线还是下线， 集群包含多少个节点， 集群当前的配置纪元</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">typedef struct clusterState &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 指向当前节点的指针</span><br><span class="line">    clusterNode *myself;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 集群当前的配置纪元，用于实现故障转移</span><br><span class="line">    uint64_t currentEpoch;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 集群当前的状态：是在线还是下线</span><br><span class="line">    int state;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 集群中至少处理着一个槽的节点的数量</span><br><span class="line">    int size;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 集群节点名单（包括 myself 节点）</span><br><span class="line">    &#x2F;&#x2F; 字典的键为节点的名字，字典的值为节点对应的 clusterNode 结构</span><br><span class="line">    dict *nodes;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">&#125; clusterState;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建了三个节点的集群结构如下图:</p>
<p><img src="/images/redis/cluster/%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%89%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E9%9B%86%E7%BE%A4%E7%BB%93%E6%9E%84.png" alt="创建了三个节点的集群结构"></p>
<p>结构的 currentEpoch 属性的值为 0 ， 表示集群当前的配置纪元为 0 。</p>
<p>结构的 size 属性的值为 0 ， 表示集群目前没有任何节点在处理槽： 因此结构的 state 属性的值为 REDIS_CLUSTER_FAIL —— 这表示集群目前处于下线状态。</p>
<p>结构的 nodes 字典记录了集群目前包含的三个节点， 这三个节点分别由三个 clusterNode 结构表示： 其中 myself 指针指向代表节点 7000 的 clusterNode 结构， 而字典中的另外两个指针则分别指向代表节点 7001 和代表节点 7002 的 clusterNode 结构， 这两个节点是节点 7000 已知的在集群中的其他节点。</p>
<p>三个节点的 clusterNode 结构的 flags 属性都是 REDIS_NODE_MASTER ，说明三个节点都是主节点。</p>
<h2 id="CLUSTER-MEET-命令的实现¶"><a href="#CLUSTER-MEET-命令的实现¶" class="headerlink" title="CLUSTER MEET 命令的实现¶"></a>CLUSTER MEET 命令的实现¶</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLUSTER MEET &lt;ip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure>
<p>节点A发送以上的命令给B.A节点与B节点进行握手:</p>
<ol>
<li>节点 A 会为节点 B 创建一个 clusterNode 结构， 并将该结构添加到自己的 clusterState.nodes 字典里面。</li>
<li>之后， 节点 A 将根据 CLUSTER MEET 命令给定的 IP 地址和端口号， 向节点 B 发送一条 MEET 消息（message）。</li>
<li>如果一切顺利， 节点 B 将接收到节点 A 发送的 MEET 消息， 节点 B 会为节点 A 创建一个 clusterNode 结构， 并将该结构添加到自己的 clusterState.nodes 字典里面。</li>
<li>之后， 节点 B 将向节点 A 返回一条 PONG 消息。</li>
<li>如果一切顺利， 节点 A 将接收到节点 B 返回的 PONG 消息， 通过这条 PONG 消息节点 A 可以知道节点 B 已经成功地接收到了自己发送的 MEET 消息。</li>
<li>之后， 节点 A 将向节点 B 返回一条 PING 消息。</li>
<li>如果一切顺利， 节点 B 将接收到节点 A 返回的 PING 消息， 通过这条 PING 消息节点 B 可以知道节点 A 已经成功地接收到了自己返回的 PONG 消息， 握手完成。</li>
</ol>
<h1 id="槽指派"><a href="#槽指派" class="headerlink" title="槽指派"></a>槽指派</h1><p>数据库中的每个键都属于16384个槽位中的其中一个,集群中的每个及诶点都可以处理0个最多16384个槽位.之后全部的槽为被处理后,那么这个集群才处于上线状态,否则处于下线状态.</p>
<p>上一节中,cluster meet命令将三个节点加到一个集群中,但是没有进行槽位指派,所以集群处于fail状态.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redisClusterTest&#x2F;6002$ .&#x2F;src&#x2F;redis-cli -h 127.0.0.1 -p 6002</span><br><span class="line">127.0.0.1:6002&gt; </span><br><span class="line">127.0.0.1:6002&gt; </span><br><span class="line">127.0.0.1:6002&gt; cluster info</span><br><span class="line">cluster_state:fail</span><br><span class="line">cluster_slots_assigned:0</span><br><span class="line">cluster_slots_ok:0</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:3</span><br><span class="line">cluster_size:0</span><br><span class="line">cluster_current_epoch:2</span><br><span class="line">cluster_my_epoch:2</span><br><span class="line">cluster_stats_messages_sent:1858</span><br><span class="line">cluster_stats_messages_received:0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样启动后,查看集群状态,处于fail状态.</p>
<p>可以连接上连接上node节点使用 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6000&gt; cluster addslots 0 1 2 3 ... 5000</span><br><span class="line">127.0.0.1:6001&gt; cluster addslots 5001 5002 2 3 ... 10000</span><br><span class="line">127.0.0.1:6002&gt; cluster addslots 10001 10002 10003 ... 16383 </span><br></pre></td></tr></table></figure>
<p>分配槽位.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6000&gt; cluster nodes</span><br><span class="line">5e57d9227987c64486ec791217b64712ad201016 127.0.0.1:6001 master - 0 1517243097362 1 connected</span><br><span class="line">94a98e405ec368ad45469b9d5fb0e019bdf2d796 127.0.0.1:6002 master - 0 1517243098365 2 connected</span><br><span class="line">e6f7de12f623d0a92da8aa307a7ee224da73b92e 127.0.0.1:6000 myself,master - 0 0 0 connected</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="记录节点的槽指派信息"><a href="#记录节点的槽指派信息" class="headerlink" title="记录节点的槽指派信息"></a>记录节点的槽指派信息</h2><p>clusterNode结构的slots和numslot属性记录了节点负责处理哪些槽.</p>
<p><img src="/images/redis/cluster/clusterMode%E7%BB%93%E6%9E%84.png" alt="clusterMode结构"></p>
<p>slots属性时一个二进制位数组.这个数组的长度时16384/8=2048个字节,共包含16384个二进制位.</p>
<p><img src="/images/redis/cluster/slots%E6%95%B0%E7%BB%84%E7%A4%BA%E4%BE%8B.png" alt="slots数组示例"></p>
<p>值是1表示该节点处理该槽位.</p>
<p>由于取出和设置slots数组中的任意一个二进制位的值的复杂度仅为O(1),所以对于一个制定节点的slots数组来说,检查该节点是否处理某个槽,时间复杂度都为O(1).</p>
<h2 id="传播节点的槽指派信息"><a href="#传播节点的槽指派信息" class="headerlink" title="传播节点的槽指派信息"></a>传播节点的槽指派信息</h2><p>一个节点除了会将自己负责的槽记录在clusterNode结构的slots属性和numslots属性中,还会将自己的slots数组通过消息发送到集群中的其他节点,以此来告知其他节点自己目前处理的哪些槽.</p>
<p><img src="/images/redis/cluster/node%E5%91%8A%E7%9F%A5%E5%88%AB%E7%9A%84%E8%8A%82%E7%82%B9%E8%87%AA%E5%B7%B1%E5%A4%84%E7%90%86%E7%9A%84%E6%A7%BD%E4%BD%8D.png" alt="node告知别的节点自己处理的槽位"></p>
<p>这样,某个节点会将别的节点处理的槽位记录在其记录的该节点的clusterNode结构中.</p>
<h2 id="记录集群所有槽的指派信息"><a href="#记录集群所有槽的指派信息" class="headerlink" title="记录集群所有槽的指派信息"></a>记录集群所有槽的指派信息</h2><p>clusterState结构的slots数组记录了集群中所有的槽位的指派信息.如果只将槽位的指派信息记录到clusterNode节点中,则查找某个槽位在哪个节点还要遍历各个节点,时间复杂度为O(N)</p>
<p>有了clusterState结构,则时间复杂度为O(1)</p>
<p><img src="/images/redis/cluster/clusterState%E7%BB%93%E6%9E%84%E7%9A%84slots%E6%95%B0%E7%BB%84.png" alt="clusterState结构的slots数组"></p>
<p>clusterState结构的slots数组包含16384个项,存储的是指向某一个clusterNode节点的指针.</p>
<p>clusterNode.slots数组记录了节点的指派信息,clusterState.slots数组记录了所有的槽位指派信息.前者是便于发送槽位指派信息,后者是便于查找某一个槽位在哪个节点.</p>
<h2 id="CLUSTER-ADDSLOTS命令的实现"><a href="#CLUSTER-ADDSLOTS命令的实现" class="headerlink" title="CLUSTER ADDSLOTS命令的实现"></a>CLUSTER ADDSLOTS命令的实现</h2><p>cluster addslots<slot>[slot …] ,将槽位指派给接收该命令的节点负责</p>
<p><img src="/images/redis/cluster/clusteraddslots%E7%9A%84%E4%BC%AA%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0.png" alt="cluster addslots 的伪代码实现"></p>
<p>未指派的cluster结构:</p>
<p><img src="/images/redis/cluster/%E6%9C%AA%E6%8C%87%E6%B4%BE%E7%9A%84cluster%E7%BB%93%E6%9E%84.png" alt="未指派的cluster结构"></p>
<p>执行命令后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster addslots 1 2</span><br></pre></td></tr></table></figure>
<p>![执行cluster addSlots命令后](/images/redis/cluster/执行cluster addSlots命令后.png)</p>
<p>之后,节点会通过发送命令发送消息告知集群中的其它节点,自己正在处理的哪些槽.</p>
<h1 id="在集群中执行命令"><a href="#在集群中执行命令" class="headerlink" title="在集群中执行命令"></a>在集群中执行命令</h1><p>槽位指派完后,集群进入上线状态.这时客户端就可以向集群发送数据命令了.</p>
<p><img src="/images/redis/cluster/%E5%88%A4%E6%96%AD%E5%AE%A2%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E8%BD%AC%E5%90%91%E5%85%B6%E5%AE%83%E6%B5%81%E7%A8%8B.png" alt="判断客客户端是否需要转向其它流程"></p>
<h2 id="计算键属于哪个槽"><a href="#计算键属于哪个槽" class="headerlink" title="计算键属于哪个槽"></a>计算键属于哪个槽</h2><p>计算键属于哪个槽位</p>
<p><img src="/images/redis/cluster/%E8%AE%A1%E7%AE%97%E9%94%AE%E7%9A%84%E6%A7%BD%E4%BD%8D.png" alt="计算键的槽位"></p>
<p>cluster keyslot <key> 查看给定的键属于哪个槽.</p>
<h2 id="判断槽位是否由当前节点处理"><a href="#判断槽位是否由当前节点处理" class="headerlink" title="判断槽位是否由当前节点处理"></a>判断槽位是否由当前节点处理</h2><p>当节点计算出键所属的槽i后,接待节点检查自己在clusterState.slots数组的项i,看槽是否由自己负责.</p>
<p>如果自己负责,则执行命令,否则返回负责该槽位的节点ip和端口号.并向客户端返回 moved错误.</p>
<h2 id="moved错误"><a href="#moved错误" class="headerlink" title="moved错误"></a>moved错误</h2><p>MOVED错误的格式:</p>
<p>moved<slot><ip>:<port> ,其中slot是键所在的槽,ip和por是处理该键的节点.</p>
<p>一个集群客户端通常会与集群中的多个节点建立套接字连接.而所谓的节点转向其实就是换一个节点自来发送命令.</p>
<p>单机模式的客户端会打印moved信息,而集群客户端不会打印,只是自动进行节点转向.</p>
<h2 id="节点数据库的实现"><a href="#节点数据库的实现" class="headerlink" title="节点数据库的实现"></a>节点数据库的实现</h2><p>节点数据库只可以使用0号数据库.<strong>节点使用clusterState结构中的slots_to_keys跳跃表来保存槽和键之间的关系.</strong></p>
<p>slots_to_keys跳跃表每个节点的分之都是一个槽号,每个节点的成员都是一个数据库键.</p>
<p>当往数据库中添加一个新的键值对时,节点都会将这个键及键的槽号关联到slots_to_keys跳跃表.</p>
<p><img src="/images/redis/cluster/%E8%8A%82%E7%82%B97000%E7%9A%84%E8%B7%B3%E8%B7%83%E8%A1%A8.png" alt="节点7000的跳跃表"></p>
<h1 id="重新分片"><a href="#重新分片" class="headerlink" title="重新分片"></a>重新分片</h1><p>redis集群的重新分片操作可以将任意数量已经指派给某个几点的槽改为指派给另一个节点,并且想过槽所属的键值对也会从源节点移动到目标节点.</p>
<p>重新分片可以在线进行,在重新分片的过程中,集群不需要下线,并且源节点和目标节点都可以继续处理命令请求.</p>
<h2 id="重新分片的实现原理"><a href="#重新分片的实现原理" class="headerlink" title="重新分片的实现原理:"></a>重新分片的实现原理:</h2><p>redis集群的重新分片操作是有redis的集群管理软件redis-trib负责执行的.redis-trib通过向源节点和目标节点发送命令来实现的.</p>
<p><img src="/images/redis/cluster/%E9%87%8D%E6%96%B0%E5%88%86%E7%89%87%E7%9A%84%E6%93%8D%E4%BD%9C.png" alt="重新分片的操作"></p>
<p><img src="/images/redis/cluster/%E8%BF%81%E7%A7%BB%E9%94%AE%E7%9A%84%E8%BF%87%E7%A8%8B.png" alt="迁移键的过程"></p>
<p><img src="/images/redis/cluster/%E5%AF%B9%E6%A7%BD%E8%BF%9B%E8%A1%8C%E9%87%8D%E6%96%B0%E5%88%86%E7%89%87%E7%9A%84%E8%BF%87%E7%A8%8B.png" alt="对槽进行重新分片的过程"></p>
<h1 id="ASK错误"><a href="#ASK错误" class="headerlink" title="ASK错误"></a>ASK错误</h1><p>在进行重新分片期间,源节点向目标节点迁移一个槽的过程中.可能出现:属于被迁移槽的一部分键值对保存在源节点里面,而另一部分键值对保存在目标节点里面.</p>
<p>当客户端向源节点发送一个与数据库键有关的命令,并且命令要处理的数据恰好属于被迁移的槽时:</p>
<p>源节点会先在自己的数据库里面查找制定的键,如果找到的话,就直接执行客户端发送的命令.源节点没能在自己的数据库里面找到制定的键,那么键有可能被迁移到目标节点,源节点向客户端返回一个ASK错误,指引客户端转向正在导入槽的目标节点,并再次发送之前要执行的命令.</p>
<p><img src="/images/redis/cluster/%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%8F%91%E9%80%81ASK%E9%94%99%E8%AF%AF%E7%9A%84%E8%BF%87%E7%A8%8B.png" alt="判断是否发送ASK错误的过程"></p>
<p>和moved错误情况类似,集群模式的客户端会自动根据错误提供的ip和端口进行转向动作.</p>
<h2 id="cluster-setslot-importing命令的实现"><a href="#cluster-setslot-importing命令的实现" class="headerlink" title="cluster setslot importing命令的实现"></a>cluster setslot importing命令的实现</h2><p>clusterState结构的importing_slots_from数组记录了当前节点正在从其他节点导入的槽</p>
<p><img src="/images/redis/cluster/importing_slots_from%E6%95%B0%E7%BB%84.png" alt="importing_slots_from数组"></p>
<p>如果importing_slots_from[i]不为null,而是指向一个clusterNode结构,那么表示当前节点正在从clusterNode所代表的节点导入槽.</p>
<p>在对集群重新进行分片的时候,向目标节点发送命令:</p>
<p>cluster setslot<i> importing <source_id> ,可以将目标节点的clusterState.importing_slots_from[i] 的值设置为source_id所代表的cluster_node结构</p>
<p><img src="/images/redis/cluster/%E5%8F%91%E9%80%81setslot%E5%91%BD%E4%BB%A4.png" alt="发送setslot命令"></p>
<h2 id="cluster-setslot-migrating命令的实现"><a href="#cluster-setslot-migrating命令的实现" class="headerlink" title="cluster setslot migrating命令的实现"></a>cluster setslot migrating命令的实现</h2><p>clusterState结构的migrating_slots_to数组记录了当前节点正在迁移至其他节点的槽.</p>
<p>如果migrating_slots_to[i]不为null,而是指向一个clusterNode结构,那么表示当前节点正在将槽i迁移至clusterNode所代表的节点.</p>
<p>节点7002的migrating_slots_to数组:</p>
<p><img src="/images/redis/cluster/%E8%8A%82%E7%82%B97002%E7%9A%84migrating_slots_to%E6%95%B0%E7%BB%84.png" alt="节点7002的migrating_slots_to数组"></p>
<h2 id="ASK错误-1"><a href="#ASK错误-1" class="headerlink" title="ASK错误"></a>ASK错误</h2><p>如果节点收到一个关于键key的命令请求,并且键key所属的槽i正好指派给该节点,则该节点处理该命令.否则节点会检查migrating_slots_to[i],看键key所属的槽i是否正在进行迁移,如果槽i的确正在迁移,那么节点会向客户端返回一个ASK错误.</p>
<p>比如返回 ASK 16198 127.0.0.1:7003 表示客户端可以尝试到ip为127.0.0.1,端口号为7003的节点去执行和槽16198有关的操作.</p>
<p>接收到ASK错误的客户端会根据错误提供的ip和端口号,转向正在导入槽的目标及节点,然后首先向目标节点发送一个ASKING命令,之后重新发送原本想要执行的命令.</p>
<h2 id="ASKING命令"><a href="#ASKING命令" class="headerlink" title="ASKING命令"></a>ASKING命令</h2><p>ASKING命令唯一要做的就是打开发送该命令的客户端redis_asking标示.</p>
<p><img src="/images/redis/cluster/%E8%8A%82%E7%82%B9%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E6%89%A7%E8%A1%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E7%9A%84%E8%BF%87%E7%A8%8B.png" alt="节点判断是否执行客户端命令的过程"></p>
<p>当客户端接收到ASK错误并转向至正在导入槽的节点时,客户端会首先发送ASKING命令,然后才重新发送需要执行的命令.如果不发送ASKING命令,直接发送要执行的命令,客户端会拒绝执行,返回moved错误.</p>
<p>客户端redis_asking标示是一次性的.当节点执行了一个带有该标识的命令后,该标示就会被移除.</p>
<h2 id="ASK错误和MOVED错误的区别"><a href="#ASK错误和MOVED错误的区别" class="headerlink" title="ASK错误和MOVED错误的区别"></a>ASK错误和MOVED错误的区别</h2><p><img src="/images/redis/cluster/ASK%E9%94%99%E8%AF%AF%E5%92%8CMOVED%E9%94%99%E8%AF%AF%E7%9A%84%E5%8C%BA%E5%88%AB.png" alt="ASK错误和MOVED错误的区别"></p>
<h1 id="复制和故障转移"><a href="#复制和故障转移" class="headerlink" title="复制和故障转移"></a>复制和故障转移</h1><p>redis集群中的节点分为主节点和从节点,主节点用于处理槽,从节点用于复制某个主节点,并在被复制的主节点下线时,代替下线朱及诶点继续处理命令请求.</p>
<h2 id="设置从节点"><a href="#设置从节点" class="headerlink" title="设置从节点"></a>设置从节点</h2><p>向一个节点发送</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster replicate&lt;node_id&gt;</span><br></pre></td></tr></table></figure>
<p>可以让接收命令的节点成为node_id所指定节点的从节点,并开始对主节点进行复制.</p>
<ol>
<li>接收到命令的节点首先从clusterState.nodes字典中找到node_id所对应节点的clusterNode结构,,并将自己的clusterState.mysql.slaveof指针指向这个结构,以此来记录这个节点正在复制主节点.</li>
<li>然后节点会修改自己在clusterState.myself.flags中的属性.关闭原本的REDIS_NODE_MASTER属性.打开redis_node_slave属性.</li>
<li>最后,节点会调用复制代码,并根据clusterState.myself.slaveof指向的clusterNode结构保存的ip地址和端口号.</li>
</ol>
<p><img src="/images/redis/cluster/7004%E4%BB%8E%E8%8A%82%E7%82%B9%E7%9A%84clusterState%E7%BB%93%E6%9E%84.png" alt="7004从节点的clusterState结构"></p>
<h2 id="故障检测"><a href="#故障检测" class="headerlink" title="故障检测"></a>故障检测</h2><p>集群中的每个节点都会定时的向集群中的其它节点发送ping消息,以此来检测对方是否在线;如果接收ping消息的节点在规定的时间内,回复pong消息,那么发送ping消息的及诶点就会向接收ping消息的节点标记为疑似下线状态(PFAIL);</p>
<p>集群中的各个节点都会通过互相发送消息的方式来交换集群中各个节点的状态消息,例如某个节点处于下线状态还是疑似下线状态.</p>
<p>当一个主节点A通过消息得知主节点B认为主节点C进入了疑似下线状态时,主节点A会在自己的clusterState.nodes字典中找到主节点C对应的clusterNode结构,并将主节点B的下线报告添加到clusterNode结构的fail_repoorts链表里面.</p>
<p>当主节点7001在收到主节点7002/主节点7003发送的消息后得知,主节点7002和主节点7003都认为主节点7000进入了疑似下线状态,那么主节点7001将为主节点7000创建如下的下线报告</p>
<p><img src="/images/redis/cluster/%E8%8A%82%E7%82%B97000%E7%9A%84%E4%B8%8B%E7%BA%BF%E6%8A%A5%E5%91%8A.png" alt="节点7000的下线报告"></p>
<p>如果一个集群里面,半数以上的负责处理槽的主节点将某个主节点X报告为疑似下线,那么主节点X将被将被标记为下线状态,将主节点X标记为下线状态的节点会向集群广播一条关于主节点X的fail消息,那么收到这条Fail消息的节点将会立即将主节点X标记为已下线.</p>
<h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><p>当从节点发现主节点进入下线状态,从节点开始对主节点进行故障转移:</p>
<p><img src="/images/redis/cluster/%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB%E7%9A%84%E6%AD%A5%E9%AA%A4.png" alt="故障转移的步骤"></p>
<h2 id="选举新的主节点"><a href="#选举新的主节点" class="headerlink" title="选举新的主节点"></a>选举新的主节点</h2><p>基于Raft算法:</p>
<p><img src="/images/redis/cluster/%E9%80%89%E5%8F%96%E6%96%B0%E7%9A%84%E4%B8%BB%E8%8A%82%E7%82%B91.png" alt="选取新的主节点1"></p>
<p><img src="/images/redis/cluster/%E9%80%89%E5%8F%96%E6%96%B0%E7%9A%84%E4%B8%BB%E8%8A%82%E7%82%B92.png" alt="选取新的主节点2"></p>
<h1 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h1><ul>
<li>meet消息</li>
</ul>
<p>发送者请求接收该消息者加入到当前所在的集群里面</p>
<ul>
<li>ping消息</li>
</ul>
<p>集群中每个节点默认每隔一秒钟都会从已知节点列表中随机选出5隔节点发送ping消息,一次来检验被选中的节点是否在线.</p>
<ul>
<li>pong消息</li>
</ul>
<p>接收ping或者meet消息的接受者会发送pong来回复发送者.还有在故障转移后,新的主节点会向集群广播一条pong消息,以此让集群知道该节点成为主节点,并接管了已经下线节点负责的槽.</p>
<ul>
<li>fail消息</li>
</ul>
<p>当A节点判断B节点进入Fail状态,它会向集群广播一条关于节点B的Fail消息,所有收到消息的节点会将B标记为下线状态.</p>
<ul>
<li>publish消息</li>
</ul>
<p>当节点接收到一个PUBLISH命令时,节点会向集群广播一条PUBLISH消息,所有接收到这条PUBLISH消息的节点都会执行相同的PUBLISH命令.</p>
<h2 id="消息头"><a href="#消息头" class="headerlink" title="消息头"></a>消息头</h2><p>节点发送的消息都由一个消息头包裹,消息头除了包含消息正文之外,还记录了消息发送者自身的一些信息.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-26/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-Sentinel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-26/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-Sentinel/" class="post-title-link" itemprop="url">redis设计与实现-Sentinel</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-26 00:02:28" itemprop="dateCreated datePublished" datetime="2018-01-26T00:02:28+08:00">2018-01-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>7.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Sentinel是redis的高可用性(High availability)的解决方案.有一个或者多个Sentinel的实例组成的Sentinel系统可以监视任意多个主服务器以及这些主服务器下的从服务器.当主服务下线的时候,从服务器会成为主服务器来执行主服务器的任务.</p>
<p>双环代表主服务器,单环代表从服务器</p>
<p><img src="/images/redis/sentinel/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%A5Sentinel%E7%B3%BB%E7%BB%9F.png" alt="服务器以Sentinel系统"></p>
<p>在主服务下线的时候,三个从服务器停止对主服务器的复制.</p>
<p><img src="/images/redis/sentinel/%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B%E7%BA%BF.png" alt="主服务器下线"></p>
<p>当server1的下线时间超过用户设定的下线时长上限时,sentinel系统会对server1进行故障转移.</p>
<ol>
<li>首先sentinel系统挑选server1属下的其中一个从服务器,并将这个被选中的从服务器升级为新的主服务器.</li>
<li>之后,sentinel系统会向server1属下的所有从服务器发送新的复制指令,让他们成为新的主服务器的从服务器.当所有的从服务器都开始复制新的主服务器时,故障转移操作执行完毕.</li>
<li>另外,sentinel会继续监视server1,并在它重新上线时,将他设置为新的主服务器的从服务器.</li>
</ol>
<p><img src="/images/redis/sentinel/%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB%E4%BB%A5%E5%8F%8A%E5%8E%9F%E6%9D%A5%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%81%A2%E5%A4%8D.png" alt="故障转移以及原来的服务器恢复"></p>
<h1 id="启动并初始化Sentinel"><a href="#启动并初始化Sentinel" class="headerlink" title="启动并初始化Sentinel"></a>启动并初始化Sentinel</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;src$ .&#x2F;redis-sentinel ..&#x2F;sentinel.conf &amp;</span><br><span class="line">[2] 13772</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;src$ 13772:X 27 Jan 01:05:25.512 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-&#96;&#96;__ &#39;&#39;-._                                             </span><br><span class="line">      _.-&#96;&#96;    &#96;.  &#96;_.  &#39;&#39;-._           Redis 3.2.10 (00000000&#x2F;0) 64 bit</span><br><span class="line">  .-&#96;&#96; .-&#96;&#96;&#96;.  &#96;&#96;&#96;\&#x2F;    _.,_ &#39;&#39;-._                                   </span><br><span class="line"> (    &#39;      ,       .-&#96;  | &#96;,    )     Running in sentinel mode</span><br><span class="line"> |&#96;-._&#96;-...-&#96; __...-.&#96;&#96;-._|&#39;&#96; _.-&#39;|     Port: 26379</span><br><span class="line"> |    &#96;-._   &#96;._    &#x2F;     _.-&#39;    |     PID: 13772</span><br><span class="line">  &#96;-._    &#96;-._  &#96;-.&#x2F;  _.-&#39;    _.-&#39;                                   </span><br><span class="line"> |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |           http:&#x2F;&#x2F;redis.io        </span><br><span class="line">  &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |                                  </span><br><span class="line">  &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line">      &#96;-._    &#96;-.__.-&#39;    _.-&#39;                                       </span><br><span class="line">          &#96;-._        _.-&#39;                                           </span><br><span class="line">              &#96;-.__.-&#39;                                               </span><br><span class="line"></span><br><span class="line">13772:X 27 Jan 01:05:25.514 # WARNING: The TCP backlog setting of 511 cannot be enforced because &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn is set to the lower value of 128.</span><br><span class="line">13772:X 27 Jan 01:05:25.514 # Sentinel ID is 9aa0e1e3a36ac2fa2e414ba752645816167f943e</span><br><span class="line">13772:X 27 Jan 01:05:25.514 # +monitor master mymaster 127.0.0.1 6379 quorum 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动Sentinel的时候,它要执行以下操作</p>
<ol>
<li>初始化服务器。</li>
<li>将普通 Redis 服务器使用的代码替换成 Sentinel 专用代码。</li>
<li>初始化 Sentinel 状态。</li>
<li>根据给定的配置文件， 初始化 Sentinel 的监视主服务器列表。</li>
<li>创建连向主服务器的网络连接。</li>
</ol>
<h2 id="初始化服务器"><a href="#初始化服务器" class="headerlink" title="初始化服务器"></a>初始化服务器</h2><p>首先， 因为 Sentinel 本质上只是一个运行在特殊模式下的 Redis 服务器， 所以启动 Sentinel 的第一步， 就是初始化一个普通的 Redis 服务器， 具体的步骤和《服务器》一章介绍的类似。</p>
<p>不过， 因为 Sentinel 执行的工作和普通 Redis 服务器执行的工作不同， 所以 Sentinel 的初始化过程和普通 Redis 服务器的初始化过程并不完全相同。</p>
<h2 id="使用-Sentinel-专用代码"><a href="#使用-Sentinel-专用代码" class="headerlink" title="使用 Sentinel 专用代码"></a>使用 Sentinel 专用代码</h2><p>比如说， 普通 Redis 服务器使用 redis.h/REDIS_SERVERPORT 常量的值作为服务器端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define REDIS_SERVERPORT 6379</span><br></pre></td></tr></table></figure>
<p>而 Sentinel 则使用 sentinel.c/REDIS_SENTINEL_PORT 常量的值作为服务器端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define REDIS_SENTINEL_PORT 26379</span><br></pre></td></tr></table></figure>

<p> Redis 服务器不能执行诸如 SET 、 DBSIZE 、 EVAL 等等这些命令 —— 因为服务器根本没有在命令表中载入这些命令： PING 、 SENTINEL 、 INFO 、 SUBSCRIBE 、 UNSUBSCRIBE 、 PSUBSCRIBE 和 PUNSUBSCRIBE 这七个命令就是客户端可以对 Sentinel 执行的全部命令了。</p>
<h2 id="初始化Sentinel状态"><a href="#初始化Sentinel状态" class="headerlink" title="初始化Sentinel状态"></a>初始化Sentinel状态</h2><p>在应用了 Sentinel 的专用代码之后， 接下来， 服务器会初始化一个 sentinel.c/sentinelState 结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">struct sentinelState &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 当前纪元，用于实现故障转移</span><br><span class="line">    uint64_t current_epoch;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 保存了所有被这个 sentinel 监视的主服务器</span><br><span class="line">    &#x2F;&#x2F; 字典的键是主服务器的名字</span><br><span class="line">    &#x2F;&#x2F; 字典的值则是一个指向 sentinelRedisInstance 结构的指针</span><br><span class="line">    dict *masters;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否进入了 TILT 模式？</span><br><span class="line">    int tilt;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 目前正在执行的脚本的数量</span><br><span class="line">    int running_scripts;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 进入 TILT 模式的时间</span><br><span class="line">    mstime_t tilt_start_time;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 最后一次执行时间处理器的时间</span><br><span class="line">    mstime_t previous_time;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 一个 FIFO 队列，包含了所有需要执行的用户脚本</span><br><span class="line">    list *scripts_queue;</span><br><span class="line"></span><br><span class="line">&#125; sentinel;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="初始化-Sentinel-状态的-masters-属性"><a href="#初始化-Sentinel-状态的-masters-属性" class="headerlink" title="初始化 Sentinel 状态的 masters 属性"></a>初始化 Sentinel 状态的 masters 属性</h2><p>Sentinel 状态中的 masters 字典记录了所有被 Sentinel 监视的主服务器的相关信息， 其中：</p>
<ol>
<li>字典的键是被监视主服务器的名字。</li>
<li>而字典的值则是被监视主服务器对应的 sentinel.c/sentinelRedisInstance 结构。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">typedef struct sentinelRedisInstance &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 标识值，记录了实例的类型，以及该实例的当前状态</span><br><span class="line">    int flags;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 实例的名字</span><br><span class="line">    &#x2F;&#x2F; 主服务器的名字由用户在配置文件中设置</span><br><span class="line">    &#x2F;&#x2F; 从服务器以及 Sentinel 的名字由 Sentinel 自动设置</span><br><span class="line">    &#x2F;&#x2F; 格式为 ip:port ，例如 &quot;127.0.0.1:26379&quot;</span><br><span class="line">    char *name;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 实例的运行 ID</span><br><span class="line">    char *runid;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 配置纪元，用于实现故障转移</span><br><span class="line">    uint64_t config_epoch;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 实例的地址</span><br><span class="line">    sentinelAddr *addr;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; SENTINEL down-after-milliseconds 选项设定的值</span><br><span class="line">    &#x2F;&#x2F; 实例无响应多少毫秒之后才会被判断为主观下线（subjectively down）</span><br><span class="line">    mstime_t down_after_period;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; SENTINEL monitor &lt;master-name&gt; &lt;IP&gt; &lt;port&gt; &lt;quorum&gt; 选项中的 quorum 参数</span><br><span class="line">    &#x2F;&#x2F; 判断这个实例为客观下线（objectively down）所需的支持投票数量</span><br><span class="line">    int quorum;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; SENTINEL parallel-syncs &lt;master-name&gt; &lt;number&gt; 选项的值</span><br><span class="line">    &#x2F;&#x2F; 在执行故障转移操作时，可以同时对新的主服务器进行同步的从服务器数量</span><br><span class="line">    int parallel_syncs;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; SENTINEL failover-timeout &lt;master-name&gt; &lt;ms&gt; 选项的值</span><br><span class="line">    &#x2F;&#x2F; 刷新故障迁移状态的最大时限</span><br><span class="line">    mstime_t failover_timeout;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">&#125; sentinelRedisInstance;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Sentinel启动时会载入以下内容的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#####################</span><br><span class="line"># master1 configure #</span><br><span class="line">#####################</span><br><span class="line"></span><br><span class="line">sentinel monitor master1 127.0.0.1 6379 2</span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds master1 30000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs master1 1</span><br><span class="line"></span><br><span class="line">sentinel failover-timeout master1 900000</span><br><span class="line"></span><br><span class="line">#####################</span><br><span class="line"># master2 configure #</span><br><span class="line">#####################</span><br><span class="line"></span><br><span class="line">sentinel monitor master2 127.0.0.1 12345 5</span><br><span class="line"></span><br><span class="line">sentinel down-after-milliseconds master2 50000</span><br><span class="line"></span><br><span class="line">sentinel parallel-syncs master2 5</span><br><span class="line"></span><br><span class="line">sentinel failover-timeout master2 450000</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/redis/sentinel/master1%E7%9A%84%E5%AE%9E%E4%BE%8B%E7%BB%93%E6%9E%84.png" alt="master1的实例结构"></p>
<p><img src="/images/redis/sentinel/master2%E7%9A%84%E5%AE%9E%E4%BE%8B%E7%BB%93%E6%9E%84.png" alt="master2的实例结构"></p>
<p><img src="/images/redis/sentinel/sentinel%E7%8A%B6%E6%80%81%E4%BB%A5%E5%8F%8Amaster%E5%AD%97%E5%85%B8.png" alt="sentinel状态以及master字典"></p>
<h2 id="创建连向主服务器的网络连接"><a href="#创建连向主服务器的网络连接" class="headerlink" title="创建连向主服务器的网络连接"></a>创建连向主服务器的网络连接</h2><p>对于每个被 Sentinel 监视的主服务器来说， Sentinel 会创建两个连向主服务器的异步网络连接：</p>
<ol>
<li>一个是命令连接， 这个连接专门用于向主服务器发送命令， 并接收命令回复。</li>
<li>另一个是订阅连接， 这个连接专门用于订阅主服务器的 <strong>sentinel</strong>:hello 频道。</li>
</ol>
<h1 id="获取主服务器的信息"><a href="#获取主服务器的信息" class="headerlink" title="获取主服务器的信息"></a>获取主服务器的信息</h1><p>Sentinel默认会以每十秒一次的频率,通过命令连接向被监视的<strong>主服务</strong>器发送INFO命令.并通过分析info命令的回复来获取主服务器的当前信息.</p>
<p><img src="/images/redis/sentinel/info%E5%91%BD%E4%BB%A4%E7%9A%84%E5%9B%9E%E5%A4%8D.png" alt="info命令的回复"></p>
<p>Sentinel在分析info命令返回的信息中对应的从服务器的实例是否在slave字典中存在而做出相应的操作.</p>
<p><img src="/images/redis/sentinel/%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%AE%83%E7%9A%84%E4%B8%89%E4%B8%AA%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="主服务器和它的三个从服务器"></p>
<h1 id="获取从服务器信息"><a href="#获取从服务器信息" class="headerlink" title="获取从服务器信息"></a>获取从服务器信息</h1><p>当Sentinel发现主服务器有新的从服务器出现时.Sentinel除了会为这个新的从服务器创建相应的实例结构外,Sentinel还会创建连接到从服务器的命令连接和订阅连接.</p>
<p><img src="/images/redis/sentinel/sentinel%E4%B8%8E%E5%90%84%E4%B8%AA%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BB%BA%E7%AB%8B%E5%91%BD%E4%BB%A4%E8%BF%9E%E6%8E%A5%E5%92%8C%E8%AE%A2%E9%98%85%E8%BF%9E%E6%8E%A5.png" alt="sentinel与各个从服务器建立命令连接和订阅连接"></p>
<p>Sentinel默认会以每十秒一次的频率,通过命令连接向被监视的<strong>从服务</strong>器发送INFO命令.并通过分析info命令的回复来获取主服务器的当前信息.</p>
<p><img src="/images/redis/sentinel/%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%9B%9E%E5%A4%8D.png" alt="从服务器的回复"></p>
<p><img src="/images/redis/sentinel/%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%AE%9E%E4%BE%8B%E7%BB%93%E6%9E%84.png" alt="从服务器的实例结构"></p>
<h1 id="向主服务器和从服务器发送信息"><a href="#向主服务器和从服务器发送信息" class="headerlink" title="向主服务器和从服务器发送信息"></a>向主服务器和从服务器发送信息</h1><p>默认情况下,Sentinel会以每两秒一次的频率,通过命令连接向所有被监视的主服务器和从服务器发送以下格式命令:</p>
<p><img src="/images/redis/sentinel/sentinel%E5%8F%91%E9%80%81%E5%91%BD%E4%BB%A4%E7%9A%84%E6%A0%BC%E5%BC%8F.png" alt="sentinel发送命令的格式"></p>
<h1 id="接收来自主服务器和从服务器的频道信息"><a href="#接收来自主服务器和从服务器的频道信息" class="headerlink" title="接收来自主服务器和从服务器的频道信息"></a>接收来自主服务器和从服务器的频道信息</h1><p>每个Sentinel连接的服务器.Sentinel既会通过命令连接向服务器的<em>Sentinel</em>:hello频道发送信息.又通过订阅连接从服务器的<em>Sentinel</em>:hello频道接收信息.</p>
<p>对于多个Sentinel来说,一个Sentinel发送的信息会被其它Sentinel接收到,以更新他们对监视服务器的认知.</p>
<h2 id="更新Sentinels字典"><a href="#更新Sentinels字典" class="headerlink" title="更新Sentinels字典"></a>更新Sentinels字典</h2><p>每个Sentinel实例中的Sentinels字典中保存这其它Sentinel实例的信息.各个Sentinel的ip和port就是该Sentinel字典中的key,而value就是Sentinel的实体结构</p>
<p>每次接收来自其它实例的信息时,各个实例都会更新其它实例在自己字典中的信息.</p>
<h2 id="创建连向其它Sentinel的命令连接"><a href="#创建连向其它Sentinel的命令连接" class="headerlink" title="创建连向其它Sentinel的命令连接"></a>创建连向其它Sentinel的命令连接</h2><p>当Sentinel通过频道信息发现一个新的Sentinel时,它不仅会为Sentinel在Sentinels字典中创建相应的实例结构,还会创建一个连向新Sentinel的命令连接.而新的Sentinel也会创建连向这个Sentinel的连接,最终监视同一个服务器的多个Sentinel会形成相互连接的网络</p>
<p>这样,各个Sentinel会通过其它Sentinel发来的命令交换信息.</p>
<ul>
<li>注意 Sentinel之间不会创建订阅连接.</li>
</ul>
<h1 id="检测主观下线状态"><a href="#检测主观下线状态" class="headerlink" title="检测主观下线状态"></a>检测主观下线状态</h1><p>默认Sentinel会以每秒一次的频率向所有与它创建了命令连接的实例(主从服务器,其它Sentinel在内)发送ping命令,通过他们的回复来判断他们是否在线.</p>
<p>Sentinel配置文件中的Down-after-milliseconds选项制定了Sentinel判断实例进入主观下线所需的时间长度.如果在该时间内无回复,则Sentinel会改变这个实例的对应的实例结构,在flags属性中打开SRI_S_Down表示,标志这该实例进入主管下线状态.</p>
<p>由于多个Sentinel的毫秒数设置的可能不同,所以各个Sentinel主观认为某个实例是否下线时不同的.</p>
<h1 id="检查客观下线状态"><a href="#检查客观下线状态" class="headerlink" title="检查客观下线状态"></a>检查客观下线状态</h1><p>当Sentinel将一个主服务器判断为主管下线之后,为了确认这个主服务器是否真的下线了,他会向同样监视这个主服务器的Sentinel进行询问.当从其它的Sentinel那接收到足够数量的已下线判断后,Sentinel会将主服务器判定为客观下线,并对主服务器执行故障转移操作</p>
<h2 id="发送Sentinel-is-master-down-by-addr命令"><a href="#发送Sentinel-is-master-down-by-addr命令" class="headerlink" title="发送Sentinel is-master-down-by-addr命令"></a>发送Sentinel is-master-down-by-addr命令</h2><p>![Sentinel is-master-down-by-addr各个参数的意义](/images/redis/sentinel/Sentinel is-master-down-by-addr各个参数的意义.png)</p>
<h2 id="接收Sentinel-is-master-down-by-addr命令"><a href="#接收Sentinel-is-master-down-by-addr命令" class="headerlink" title="接收Sentinel is-master-down-by-addr命令"></a>接收Sentinel is-master-down-by-addr命令</h2><p>![Sentinel is-master-down-by-addr回复的意义](/images/redis/sentinel/Sentinel is-master-down-by-addr回复的意义.png)</p>
<h2 id="接收Sentinel-is-master-down-by-addr的回复"><a href="#接收Sentinel-is-master-down-by-addr的回复" class="headerlink" title="接收Sentinel is-master-down-by-addr的回复"></a>接收Sentinel is-master-down-by-addr的回复</h2><p>根据Sentinel同意主服务器已下线的数量(quorum参数的值),当达到所需的数量,则将主服务器的flags属性的SRI_O_DOWN标示打开,表示主服务器已经进入客观下线状态</p>
<p>Sentinel monitor master 127.0.0.1 6379 2 包括当前的Sentinel在日,有2个Sentinel觉得主服务器已经下线,则当前Sentinel才会将主服务器判断为客观下线.</p>
<h1 id="选举领头-Sentinel"><a href="#选举领头-Sentinel" class="headerlink" title="选举领头 Sentinel"></a>选举领头 Sentinel</h1><p>当一个主服务器被判定为客观下线时.监视这个下线主服务器的各个Sentinel会进行协商,选举一个领头Sentinel,并由它对下线主服务器进行故障转移.</p>
<p>选举领头Sentinel的法则:</p>
<p><img src="/images/redis/sentinel/%E9%80%89%E4%B8%BE%E9%A2%86%E5%A4%B4Sentinel%E7%9A%84%E6%B3%95%E5%88%991.png" alt="选举领头Sentinel的法则1"></p>
<p><img src="/images/redis/sentinel/%E9%80%89%E4%B8%BE%E9%A2%86%E5%A4%B4Sentinel%E7%9A%84%E6%B3%95%E5%88%992.png" alt="选举领头Sentinel的法则2"></p>
<h1 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h1><p>领头的Sentinel对已下线的主服务器执行故障转移,操作如下</p>
<ol>
<li>在已下线的主服务器属下的所有从服务器里面,选一个从服务器将其转换为主服务器.</li>
<li>让已下线的服务器属下的所有从服务器改为复制新的主服务器.</li>
<li>将已下线的主服务器设置为新的主服务器的从服务器,待其上线后,它将成为新的额主服务器的从服务器.</li>
</ol>
<h2 id="选出的新的主服务器"><a href="#选出的新的主服务器" class="headerlink" title="选出的新的主服务器"></a>选出的新的主服务器</h2><p>故障转移操作的第一步就是在已下线的主服务器的属下的所有从服务器中,选出一个状态良好.数据完整的从服务器,然后向这个从服务器发送slave no one命令.将它由从服务器变为主服务器.</p>
<p>主服务的挑选规则:</p>
<p><img src="/images/redis/sentinel/%E4%B8%BB%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%8C%91%E9%80%89%E8%A7%84%E5%88%99.png" alt="主服务的挑选规则"></p>
<h2 id="修改从服务器的复制目标"><a href="#修改从服务器的复制目标" class="headerlink" title="修改从服务器的复制目标"></a>修改从服务器的复制目标</h2><p>当新的主服务器出现之后,领头Sentinel下一步做的就是让所有的从服务器去复制新的主服务器.这一动作通过<strong>领头Sentinel</strong>向从服务器发送SLAVEOF命令来实现</p>
<p><img src="/images/redis/sentinel/%E8%AE%A9%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%8D%E5%88%B6%E6%96%B0%E7%9A%84%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="让从服务器复制新的主服务器"></p>
<p><img src="/images/redis/sentinel/server3%E5%92%8Cserver4%E6%88%90%E4%B8%BAserver2%E7%9A%84%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="server3和server4成为server2的从服务器"></p>
<h2 id="让旧的主服务器成为从服务器"><a href="#让旧的主服务器成为从服务器" class="headerlink" title="让旧的主服务器成为从服务器"></a>让旧的主服务器成为从服务器</h2><p>由于旧的主服务器已经下线,所以这种操作时保存在在server1对应的实例结构里面的.当server1重新上线后,Sentinel会向它发送SLAVEOF命令,让server1成为server2的从服务器.</p>
<p><img src="/images/redis/sentinel/server1%E9%87%8D%E6%96%B0%E4%B8%8A%E7%BA%BF%E6%88%90%E4%B8%BAserver2%E7%9A%84%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="server1重新上线成为server2的从服务器"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-24/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-24/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">redis设计与实现-复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-24 00:43:00" itemprop="dateCreated datePublished" datetime="2018-01-24T00:43:00+08:00">2018-01-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>redis中可以通过slaveof命令或者配置slaveof选项,让一个服务器去复制(replicate)另一个服务器,被复制的服务器为master,对master进行复制的为slave.</p>
<p>从服务器和主服务保存的数据时相同的.这个称为数据库状态一致.</p>
<h1 id="旧版复制功能的实现"><a href="#旧版复制功能的实现" class="headerlink" title="旧版复制功能的实现"></a>旧版复制功能的实现</h1><p>复制功能分为同步(sync)和命令传播(command propagate) 两个操作</p>
<ol>
<li>同步是从服务器的数据库状态更新至主服务器当前所处的数据库状态.</li>
<li>命令传播操作是当主服务器的数据库状态被修改,导致主从服务器的数据库状态出现不一致的时候,让主从服务器的数据库状态回到一致状态.</li>
</ol>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><p>从服务器对主服务器的同步操作需要通过向主服务器发送 SYNC 命令来完成， 以下是 SYNC 命令的执行步骤：</p>
<ol>
<li>从服务器向主服务器发送 SYNC 命令。</li>
<li>收到 SYNC 命令的主服务器执行 BGSAVE 命令， 在后台生成一个 RDB 文件， 并使用一个缓冲区记录从现在开始执行的所有写命令。</li>
<li>当主服务器的 BGSAVE 命令执行完毕时， 主服务器会将 BGSAVE 命令生成的 RDB 文件发送给从服务器， 从服务器接收并载入这个 RDB 文件， 将自己的数据库状态更新至主服务器执行 BGSAVE 命令时的数据库状态。</li>
<li>主服务器将记录在缓冲区里面的所有写命令发送给从服务器， 从服务器执行这些写命令， 将自己的数据库状态更新至主服务器数据库当前所处的状态。</li>
</ol>
<p><img src="/images/redis/replicate/%E4%B8%BB%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8C%E6%AD%A5%E7%9A%84%E4%BE%8B%E5%AD%90.png" alt="主从服务器同步的例子"></p>
<h2 id="命令传播"><a href="#命令传播" class="headerlink" title="命令传播"></a>命令传播</h2><p>当同步完成之后,主从服务器的状态在当前时刻时一致的.当主库发生写操作,此时主从的数据时不一致的.主库需要将客户端传来的写操作的命令传递给从库.这样主从数据库才可以保持一致.</p>
<h1 id="旧版复制功能的缺陷"><a href="#旧版复制功能的缺陷" class="headerlink" title="旧版复制功能的缺陷"></a>旧版复制功能的缺陷</h1><p>主从复制分为以下两种情况:</p>
<ol>
<li>初次复制,从服务器从来没有复制过任何主服务器,或者从服务器要复制的主服务器和上一次复制的主服务器不同</li>
<li>断线后的复制,处于命令传播阶段的主从服务器因为网络原因中断了复制,网络恢复后从服务器对主服务器的复制.(断线重连后从服务器需要向主服务器发送sync命令)</li>
</ol>
<p><img src="/images/redis/replicate/%E6%96%AD%E7%BA%BF%E5%90%8E%E9%87%8D%E6%96%B0%E5%A4%8D%E5%88%B6%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E4%BE%8B%E5%AD%90.png" alt="断线后重新复制主服务器的例子"></p>
<p>其实断线这段时间,主服务器的写操作产生的数据是主从服务器之间的不同.但旧版的复制功能却采用sync命令,这样效率其实非常低.</p>
<h1 id="新版复制功能的实现"><a href="#新版复制功能的实现" class="headerlink" title="新版复制功能的实现"></a>新版复制功能的实现</h1><p>为了解决旧版掉线重连的同步数据地下的缺陷,有了新版复制功能的实现.</p>
<p>新版的复制功能采用PSYNC代替SYNC命令.PSYNC具有完整重同步和部分重同步2种操作,其中完整重同步和SYNC的基本一致,部分重同步是在网络恢复后,将断线期间的写命令发送给从服务器.</p>
<p><img src="/images/redis/replicate/PSYNC%E5%91%BD%E4%BB%A4%E8%BF%9B%E8%A1%8C%E6%96%AD%E7%BA%BF%E5%90%8E%E9%87%8D%E5%A4%8D%E5%88%B6.png" alt="PSYNC命令进行断线后重复制"></p>
<h1 id="部分重同步的实现"><a href="#部分重同步的实现" class="headerlink" title="部分重同步的实现"></a>部分重同步的实现</h1><p>主要包括以下三小结</p>
<h2 id="复制偏移量"><a href="#复制偏移量" class="headerlink" title="复制偏移量"></a>复制偏移量</h2><p>主从服务器都会维护一个复制偏移量.主服务器每次向从服务器传播N个字节,就会将自己的偏移量加上N,从服务器收到偏移量N就会为自己的偏移量加上N.</p>
<p><img src="/images/redis/replicate/%E6%8B%A5%E6%9C%89%E7%9B%B8%E5%90%8C%E5%81%8F%E7%A7%BB%E9%87%8F%E7%9A%84%E4%B8%80%E4%B8%BB%E4%B8%89%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="拥有相同偏移量的一主三从服务器"></p>
<h2 id="复制积压缓冲区"><a href="#复制积压缓冲区" class="headerlink" title="复制积压缓冲区"></a>复制积压缓冲区</h2><p>复制积压缓冲区是由主服务器维护的一个固定长度先进先出的队列.默认大小为1M.</p>
<p>当主服务器进行命令传播时,不仅将命令发送给所有的从服务器,还会将命令写入到复制积压缓冲区里面.</p>
<p><img src="/images/redis/replicate/%E5%A4%8D%E5%88%B6%E7%A7%AF%E5%8E%8B%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%9E%84%E9%80%A0.png" alt="复制积压缓冲区的构造"></p>
<p>当从服务器重新连接上主服务器后,从服务器会通过PSYNC命令将自己的复制偏移量offset发送给服务器,主服务会根据这个offset来决定执行什么操作.</p>
<p>如果offset偏移量之后的数据(offset+1后的数据),仍然存在与积压缓冲区中,则主服务会对从服务器执行部分重同步操作,否则自己完整重同步操作.</p>
<h2 id="服务器运行id"><a href="#服务器运行id" class="headerlink" title="服务器运行id"></a>服务器运行id</h2><p>除了复制偏移量和复制积压缓冲区外,实现部分重同步还需要用到服务器的运行ID.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info server</span><br><span class="line"># Server</span><br><span class="line">redis_version:3.2.10</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:e84c37c0154af52a</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Linux 4.4.0-109-generic x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">gcc_version:5.4.0</span><br><span class="line">process_id:22916</span><br><span class="line">run_id:1976d153c2f5dd6d9c62808b92dddbe572950c88 &#x2F;&#x2F;40个随机的16进制字符组成</span><br><span class="line">tcp_port:6379</span><br><span class="line">uptime_in_seconds:180</span><br><span class="line">uptime_in_days:0</span><br><span class="line">hz:10</span><br><span class="line">lru_clock:6863212</span><br><span class="line">executable:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;src&#x2F;.&#x2F;redis-server</span><br><span class="line">config_file:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;redis.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从服务器对主服务器进行初次同步的时候,主服务会将自己的run id传递给从服务器.断线重连后会将此id传递给主服务器,如果id和主服务器的相同,则尝试执行部分同步操作.否则执行全同步操作.</p>
<h1 id="PSYNC命令的实现"><a href="#PSYNC命令的实现" class="headerlink" title="PSYNC命令的实现"></a>PSYNC命令的实现</h1><p>PSYNC命令执行完整重同步和部分重同步时可能遇到的情况.</p>
<p><img src="/images/redis/replicate/PSYNC%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%95%B4%E9%87%8D%E5%90%8C%E6%AD%A5%E5%92%8C%E9%83%A8%E5%88%86%E9%87%8D%E5%90%8C%E6%AD%A5%E6%97%B6%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E6%83%85%E5%86%B5.png" alt="PSYNC命令执行完整重同步和部分重同步时可能遇到的情况"></p>
<h1 id="复制的实现"><a href="#复制的实现" class="headerlink" title="复制的实现"></a>复制的实现</h1><p>从服务通过 SLAVEOF <master_ip> <master_port> 复制主服务的数据</p>
<h2 id="设置主服务器的地址和端口"><a href="#设置主服务器的地址和端口" class="headerlink" title="设置主服务器的地址和端口"></a>设置主服务器的地址和端口</h2><p>执行SLAVEOF 127.0.0.1 6379命令后,从服务将主服务器的ip和端口设置到自己的服务器属性里.</p>
<p><img src="/images/redis/replicate/%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81.png" alt="从服务器的服务器状态"></p>
<h2 id="建立套接字连接"><a href="#建立套接字连接" class="headerlink" title="建立套接字连接"></a>建立套接字连接</h2><p>从服务器设置ip和端口号成功后,创建连向主服务器的套接字连接.创建成功后,从服务器会为这个套接字关联一个专门用于处理复制工作的文件事件处理器.</p>
<p>主服务器在接收从服务器的套接字连接之后,将为该套接字创建相应的客户端状态.而此时从服务器可以看做时连接向主服务器的客户端.此时从服务器同事具有服务器和客户端两个身份.</p>
<h2 id="发送ping命令"><a href="#发送ping命令" class="headerlink" title="发送ping命令"></a>发送ping命令</h2><p>虽然建立起连接,但是主从服务器从未通信,</p>
<ol>
<li>以此来检测套接字的读写状态是否正常.</li>
<li>检测主服务器能否正常处理命令.</li>
</ol>
<p>收到的回复</p>
<ol>
<li>timeout表示连接状态不佳.</li>
<li>返回一个错误,表示暂时没法处理命令.</li>
<li>pong,正常.</li>
</ol>
<h2 id="身份验证"><a href="#身份验证" class="headerlink" title="身份验证"></a>身份验证</h2><p>返回pong之后,如果从服务器设置了masterauth参数,那么进行身份验证.否者不进行身份验证.</p>
<p><img src="/images/redis/replicate/%E4%BB%8E%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98.png" alt="从服务进行身份验证可能遇到的问题"></p>
<h2 id="发送端口信息"><a href="#发送端口信息" class="headerlink" title="发送端口信息"></a>发送端口信息</h2><p>在身份验证步骤之后,从服务器将执行命令REPLCONF listening-port<port-num>,向主服务器发送从服务器的监听端口号</p>
<p>主服务在接收到这个命令之后,会将端口号记录在从服务器对应的客户端状态的slave_listening_port属性中.目前唯一的作用就是info repication会打印监听的端口号</p>
<h2 id="同步-1"><a href="#同步-1" class="headerlink" title="同步"></a>同步</h2><p>之后,从服务器向主服务器发送PSYNC命令.执行同步,此时主服务器也成为从服务器的客户端,这样主服务才可以在之后的操作中将缓冲区的内容发送过去.而且主从之间才可以保持同步.</p>
<h2 id="命令传播-1"><a href="#命令传播-1" class="headerlink" title="命令传播"></a>命令传播</h2><p>之后,主从服务器进入命令传播阶段.主从服务器的数据保持一致.</p>
<h1 id="心跳检测"><a href="#心跳检测" class="headerlink" title="心跳检测"></a>心跳检测</h1><p>在命令传播阶段,从服务器会默认以每秒一次的频率向主服务发送命令 REPLCONF ACK <replication_offset>,其中replication_offset是从服务器当前的复制偏移量.</p>
<p>作用:</p>
<ol>
<li>检测主从服务器的网络状态</li>
<li>辅助实现min-slaves选项</li>
<li>检测命令丢失</li>
</ol>
<h2 id="检测主从服务器的网络状态"><a href="#检测主从服务器的网络状态" class="headerlink" title="检测主从服务器的网络状态"></a>检测主从服务器的网络状态</h2><p>如果主服务器超过一秒没有收到从服务器的REPLCONF命令,则主服务器认为从服务器出现故障.</p>
<p>info replication命令的lag项表示从服务器上一次向从服务器发送命令距今有多少秒.</p>
<h2 id="辅助实现min-slaves选项"><a href="#辅助实现min-slaves选项" class="headerlink" title="辅助实现min-slaves选项"></a>辅助实现min-slaves选项</h2><p>redis的两个选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">min-slaves-to-write 3</span><br><span class="line">min-slaves-to-lag 10</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>表示从服务器的数量少于三个或者三个服务器的值都大于等于10秒,主服务器将拒绝执行写命令.</p>
<h2 id="检测命令丢失"><a href="#检测命令丢失" class="headerlink" title="检测命令丢失"></a>检测命令丢失</h2><p>主服务器在收到从服务器的replication_offset参数后,发现与自己的偏移量不一致,会从复制积压缓冲区中取出数据重新发送.以保证主从数据的同步.这个类似于部分重同步操作.</p>
<ul>
<li>redis2.8版本添加了REPLCONF ACK 命令和复制积压缓冲区,以前的版本中主从复制的命令丢失都不会被发觉.为了保证复制时主从服务器的数据一致性.最好使用2.8+版本</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-23/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%8E%92%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-23/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%8E%92%E5%BA%8F/" class="post-title-link" itemprop="url">redis设计与实现-排序</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-23 01:44:33" itemprop="dateCreated datePublished" datetime="2018-01-23T01:44:33+08:00">2018-01-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.6k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="排序-快速排序算法"><a href="#排序-快速排序算法" class="headerlink" title="排序 (快速排序算法)"></a>排序 (快速排序算法)</h1><p>redis的sort命令可以对列表键/集合键或者有序集合键进行排序</p>
<p>命令如下:</p>
<p>sort key [BY pattern] [LIMIT offset count] [GET pattern [GET pattern …]] [ASC|DESC] [ALPHA] [STORE destination]</p>
<p>例子1: 对列表进行排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush numbers 5 2 1 4 2</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; LRANGE numbers 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;1&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line">5) &quot;2&quot;</span><br><span class="line">127.0.0.1:6379&gt; sort numbers</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;2&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line">5) &quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; sort numbers desc</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;4&quot;</span><br><span class="line">3) &quot;2&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例子2: 对集合进行排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd alphabet a b c d e f g h </span><br><span class="line">(integer) 8</span><br><span class="line">127.0.0.1:6379&gt; smembers alphabet</span><br><span class="line">1) &quot;e&quot;</span><br><span class="line">2) &quot;d&quot;</span><br><span class="line">3) &quot;h&quot;</span><br><span class="line">4) &quot;a&quot;</span><br><span class="line">5) &quot;g&quot;</span><br><span class="line">6) &quot;f&quot;</span><br><span class="line">7) &quot;b&quot;</span><br><span class="line">8) &quot;c&quot;</span><br><span class="line">127.0.0.1:6379&gt; sort alphabet alpha</span><br><span class="line">1) &quot;a&quot;</span><br><span class="line">2) &quot;b&quot;</span><br><span class="line">3) &quot;c&quot;</span><br><span class="line">4) &quot;d&quot;</span><br><span class="line">5) &quot;e&quot;</span><br><span class="line">6) &quot;f&quot;</span><br><span class="line">7) &quot;g&quot;</span><br><span class="line">8) &quot;h&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例子3: 对有序集合进行排序,使用by字段排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd test-result 3.0 jack 3.5 peter 4.0 tom </span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zrange test-result 0 -1</span><br><span class="line">1) &quot;jack&quot;</span><br><span class="line">2) &quot;peter&quot;</span><br><span class="line">3) &quot;tom&quot;</span><br><span class="line">127.0.0.1:6379&gt; mset peter-number 1 tom-number 2 jack-number 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; sort test-result by *-number</span><br><span class="line">1) &quot;peter&quot;</span><br><span class="line">2) &quot;tom&quot;</span><br><span class="line">3) &quot;jack&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="sort命令的实现"><a href="#sort命令的实现" class="headerlink" title="sort命令的实现"></a>sort<key>命令的实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush  numbers 3 1 2</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; sort numbers</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上排序的具体实现</p>
<ol>
<li><p>创建一个和 numbers 列表长度相同的数组， 该数组的每个项都是一个 redis.h/redisSortObject 结构， 如图 IMAGE_CREATE_ARRAY 所示。<br><img src="/images/redis/luaandsort/IMAGE_CREATE_ARRAY.png" alt="IMAGE_CREATE_ARRAY"></p>
</li>
<li><p>遍历数组， 将各个数组项的 obj 指针分别指向 numbers 列表的各个项， 构成 obj 指针和列表项之间的一对一关系， 如图 IMAGE_POINT_OBJ 所示。<br><img src="/images/redis/luaandsort/IMAGE_POINT_OBJ.png" alt="IMAGE_POINT_OBJ"></p>
</li>
<li><p>遍历数组， 将各个 obj 指针所指向的列表项转换成一个 double 类型的浮点数， 并将这个浮点数保存在相应数组项的 u.score 属性里面， 如图 IMAGE_SET_SCORE 所示。<br><img src="/images/redis/luaandsort/IMAGE_SET_SCORE.png" alt="IMAGE_SET_SCORE"></p>
</li>
<li><p>根据数组项 u.score 属性的值， 对数组进行数字值排序， 排序后的数组项按 u.score 属性的值从小到大排列， 如图 IMAGE_SORTED 所示。<br><img src="/images/redis/luaandsort/IMAGE_SORTED.png" alt="IMAGE_SORTED"></p>
</li>
</ol>
<ul>
<li>redisSortObject 结构</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _redisSortObject &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 被排序键的值</span><br><span class="line">    robj *obj;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 权重</span><br><span class="line">    union &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 排序数字值时使用</span><br><span class="line">        double score;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 排序带有 BY 选项的字符串值时使用</span><br><span class="line">        robj *cmpobj;</span><br><span class="line"></span><br><span class="line">    &#125; u;</span><br><span class="line"></span><br><span class="line">&#125; redisSortObject;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ALPHA选项的实现"><a href="#ALPHA选项的实现" class="headerlink" title="ALPHA选项的实现"></a>ALPHA选项的实现</h2><p>与sort<key> 类似,只不过排序的是字母.按照字母排序而不是数字的大小</p>
<h2 id="ASC和DESC选项的实现"><a href="#ASC和DESC选项的实现" class="headerlink" title="ASC和DESC选项的实现"></a>ASC和DESC选项的实现</h2><p>sort<key> 默认升序排列(ASC), DESC选项是将序排列</p>
<h2 id="BY选项的实现"><a href="#BY选项的实现" class="headerlink" title="BY选项的实现"></a>BY选项的实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd test-result 3.0 jack 3.5 peter 4.0 tom </span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zrange test-result 0 -1</span><br><span class="line">1) &quot;jack&quot;</span><br><span class="line">2) &quot;peter&quot;</span><br><span class="line">3) &quot;tom&quot;</span><br><span class="line">127.0.0.1:6379&gt; mset peter-number 1 tom-number 2 jack-number 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; sort test-result by *-number</span><br><span class="line">1) &quot;peter&quot;</span><br><span class="line">2) &quot;tom&quot;</span><br><span class="line">3) &quot;jack&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>该例子中,只是将peter的权重键peter-number 1.0 放到u.score的位置,tom-number 2.0放到u.score的位置,jack-number 3.0放到u.score的位置,然后按照权重排序,输出到客户端.</p>
<h2 id="LIMIT-offset-count-选项"><a href="#LIMIT-offset-count-选项" class="headerlink" title="LIMIT offset count 选项"></a>LIMIT offset count 选项</h2><p>只是在排完序后跳过offset后,取出 count个元素</p>
<h2 id="GET选项"><a href="#GET选项" class="headerlink" title="GET选项"></a>GET选项</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd students &quot;peter&quot; &quot;jack&quot; &quot;tom&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; sort students alpha</span><br><span class="line">1) &quot;jack&quot;</span><br><span class="line">2) &quot;peter&quot;</span><br><span class="line">3) &quot;tom&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;设置以上三个元素的全名</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; set peter-name &quot;peter white&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set jack-name &quot;jack snow&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set tom-name &quot;tom smith&quot;</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;sort命令首先对students集合进行排序,得到结果集,获取并返回键 peter-name jack-name tom-name的值</span><br><span class="line">127.0.0.1:6379&gt; sort students alpha get *-name</span><br><span class="line">1) &quot;jack snow&quot;</span><br><span class="line">2) &quot;peter white&quot;</span><br><span class="line">3) &quot;tom smith&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="store-选项"><a href="#store-选项" class="headerlink" title="store 选项"></a>store 选项</h2><p>将排序结果存到store的key中</p>
<h2 id="多个选项的执行顺序"><a href="#多个选项的执行顺序" class="headerlink" title="多个选项的执行顺序"></a>多个选项的执行顺序</h2><ol>
<li>排序:在这一步,命令会使用ALPHA/ASC/或者DESC/BY这几个选项,对输入键进行排序.并得到一个排序结果集.</li>
<li>限制排序结果集的长度.使用limit选项,对结果集的长度进行限制.</li>
<li>获取外部键,在这一步,命令会使用GET选项,根据排序结果集中的元素,以及get选项选定的模式,查找并获取指定的键的值,并用这些值作为新的排序结果集.</li>
<li>保存排序结果集,这这一步,命令会使用store选项,将结果集保存到指定的键上.</li>
<li>向客户端返回结果</li>
</ol>
<h1 id="LUA脚本"><a href="#LUA脚本" class="headerlink" title="LUA脚本"></a>LUA脚本</h1><p>redis从2.6版本开始对LUA脚本的支持,redis客户端可以使用LUA脚本,直接在服务端原子性的执行多条redis命令.</p>
<p>基本命令包括EVAL和EVALSHA,管理命令的四个命令:SCRIPT FLUSH,SCRIPT EXISTS,SCRIPT LOAD,SCRIPT KILL 四个命令.</p>
<p>关于LUA脚本,暂时不学习.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-21/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E5%92%8C%E4%BA%8B%E5%8A%A1%E4%BB%A5%E5%8F%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E7%BB%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-21/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E5%92%8C%E4%BA%8B%E5%8A%A1%E4%BB%A5%E5%8F%8A%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E7%BB%84/" class="post-title-link" itemprop="url">redis设计与实现-慢查询日志和事务以及二进制数组</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-21 02:55:34" itemprop="dateCreated datePublished" datetime="2018-01-21T02:55:34+08:00">2018-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h1><p>Redis 的慢查询日志功能用于记录执行时间超过给定时长的命令请求， 用户可以通过这个功能产生的日志来监视和优化查询速度。</p>
<ol>
<li>slowlog-log-slower-than 选项指定执行时间超过多少微秒（1 秒等于 1,000,000 微秒）的命令请求会被记录到日志上。</li>
<li>slowlog-max-len 选项指定服务器最多保存多少条慢查询日志。( 当服务器储存的慢查询日志数量等于 slowlog-max-len 选项的值时， 服务器在添加一条新的慢查询日志之前， 会先将最旧的一条慢查询日志删除。)</li>
</ol>
<p>代码demo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;先将时间设置为0 以使得所有的命令都会记录到慢查询日志里</span><br><span class="line">127.0.0.1:6379&gt; config get slowlog-log-slower-than</span><br><span class="line">1) &quot;slowlog-log-slower-than&quot;</span><br><span class="line">2) &quot;0&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;记录慢查询日志的条数</span><br><span class="line">127.0.0.1:6379&gt; config get slowlog-max-len</span><br><span class="line">1) &quot;slowlog-max-len&quot;</span><br><span class="line">2) &quot;10&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;查询慢日志</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; slowlog get</span><br><span class="line"> 1) 1) (integer) 9           # 日志的唯一标识符（uid）</span><br><span class="line">    2) (integer) 1516475717  # 命令执行时的 UNIX 时间戳</span><br><span class="line">    3) (integer) 5           # 命令执行的时长，以微秒计算</span><br><span class="line">    4) 1) &quot;slowlog&quot;          # 命令以及命令参数</span><br><span class="line">       2) &quot;ge&quot;</span><br><span class="line"> 2) 1) (integer) 8</span><br><span class="line">    2) (integer) 1516475638</span><br><span class="line">    3) (integer) 49</span><br><span class="line">    4) 1) &quot;config&quot;</span><br><span class="line">       2) &quot;get&quot;</span><br><span class="line">       3) &quot;slowlog-log-slower-than&quot;</span><br><span class="line"> 3) 1) (integer) 7</span><br><span class="line">    2) (integer) 1516475500</span><br><span class="line">    3) (integer) 61</span><br><span class="line">    4) 1) &quot;config&quot;</span><br><span class="line">       2) &quot;get&quot;</span><br><span class="line">       3) &quot;slowlog-max-len&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="慢查询记录的保存"><a href="#慢查询记录的保存" class="headerlink" title="慢查询记录的保存"></a>慢查询记录的保存</h2><p>服务器状态中包含了几个和慢查询日志功能有关的属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">struct redisServer &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 下一条慢查询日志的 ID</span><br><span class="line">    long long slowlog_entry_id;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 保存了所有慢查询日志的链表</span><br><span class="line">    list *slowlog;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 服务器配置 slowlog-log-slower-than 选项的值</span><br><span class="line">    long long slowlog_log_slower_than;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 服务器配置 slowlog-max-len 选项的值</span><br><span class="line">    unsigned long slowlog_max_len;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>slowlog 链表保存了服务器中的所有慢查询日志， 链表中的每个节点都保存了一个 slowlogEntry 结构， 每个 slowlogEntry 结构代表一条慢查询日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typedef struct slowlogEntry &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 唯一标识符</span><br><span class="line">    long long id;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 命令执行时的时间，格式为 UNIX 时间戳</span><br><span class="line">    time_t time;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 执行命令消耗的时间，以微秒为单位</span><br><span class="line">    long long duration;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 命令与命令参数</span><br><span class="line">    robj **argv;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 命令与命令参数的数量</span><br><span class="line">    int argc;</span><br><span class="line"></span><br><span class="line">&#125; slowlogEntry;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="慢查询日志的阅览和删除"><a href="#慢查询日志的阅览和删除" class="headerlink" title="慢查询日志的阅览和删除"></a>慢查询日志的阅览和删除</h2><p>伪代码实现</p>
<p>SLOWLOG GET 伪代码实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">def SLOWLOG_GET(number&#x3D;None):</span><br><span class="line"></span><br><span class="line">    # 用户没有给定 number 参数</span><br><span class="line">    # 那么打印服务器包含的全部慢查询日志</span><br><span class="line">    if number is None:</span><br><span class="line">        number &#x3D; SLOWLOG_LEN()</span><br><span class="line"></span><br><span class="line">    # 遍历服务器中的慢查询日志</span><br><span class="line">    for log in redisServer.slowlog:</span><br><span class="line"></span><br><span class="line">        if number &lt;&#x3D; 0:</span><br><span class="line">            # 打印的日志数量已经足够，跳出循环</span><br><span class="line">            break</span><br><span class="line">        else:</span><br><span class="line">            # 继续打印，将计数器的值减一</span><br><span class="line">            number -&#x3D; 1</span><br><span class="line"></span><br><span class="line">        # 打印日志</span><br><span class="line">        printLog(log)</span><br></pre></td></tr></table></figure>

<p>SLOWLOG LEN伪代码实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def SLOWLOG_LEN():</span><br><span class="line"></span><br><span class="line">    # slowlog 链表的长度就是慢查询日志的条目数量</span><br><span class="line">    return len(redisServer.slowlog)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>SLOWLOG RESET 伪代码实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def SLOWLOG_RESET():</span><br><span class="line"></span><br><span class="line">    # 遍历服务器中的所有慢查询日志</span><br><span class="line">    for log in redisServer.slowlog:</span><br><span class="line"></span><br><span class="line">        # 删除日志</span><br><span class="line">        deleteLog(log)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;get</span><br><span class="line">127.0.0.1:6379&gt; slowlog get</span><br><span class="line"> 1) 1) (integer) 14</span><br><span class="line">    2) (integer) 1516476187</span><br><span class="line">    3) (integer) 6</span><br><span class="line">    4) 1) &quot;slowlog&quot;</span><br><span class="line">       2) &quot;restt&quot;</span><br><span class="line"> 2) 1) (integer) 13</span><br><span class="line">    2) (integer) 1516476173</span><br><span class="line">    3) (integer) 5</span><br><span class="line">    4) 1) &quot;slowlog&quot;</span><br><span class="line">       2) &quot;len&quot;</span><br><span class="line"> 3) 1) (integer) 12</span><br><span class="line">    2) (integer) 1516476169</span><br><span class="line">    3) (integer) 4</span><br><span class="line">    4) 1) &quot;slowlog&quot;</span><br><span class="line">       2) &quot;len&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; len</span><br><span class="line">127.0.0.1:6379&gt; slowlog len</span><br><span class="line">(integer) 10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; reset</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; slowlog reset</span><br><span class="line">OK</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="添加新日志"><a href="#添加新日志" class="headerlink" title="添加新日志"></a>添加新日志</h2><p>在每次执行命令的之前和之后， 程序都会记录微秒格式的当前 UNIX 时间戳， 这两个时间戳之间的差就是服务器执行命令所耗费的时长， 服务器会将这个时长作为参数之一传给 slowlogPushEntryIfNeeded 函数， 而 slowlogPushEntryIfNeeded 函数则负责检查是否需要为这次执行的命令创建慢查询日志， 以下伪代码展示了这一过程：</p>
<p>伪代码实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 记录执行命令前的时间</span><br><span class="line">before &#x3D; unixtime_now_in_us()</span><br><span class="line"></span><br><span class="line"># 执行命令</span><br><span class="line">execute_command(argv, argc, client)</span><br><span class="line"></span><br><span class="line"># 记录执行命令后的时间</span><br><span class="line">after &#x3D; unixtime_now_in_us()</span><br><span class="line"></span><br><span class="line"># 检查是否需要创建新的慢查询日志</span><br><span class="line">slowlogPushEntryIfNeeded(argv, argc, before-after)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>slowlogPushEntryIfNeeded函数检查slowlog-log-slower-than和slowlog-max-len这两个参数及做出相应的操作.</p>
<h1 id="监视器"><a href="#监视器" class="headerlink" title="监视器"></a>监视器</h1><p>通过执行 MONITOR 命令， 客户端可以将自己变为一个监视器， 实时地接收并打印出服务器当前处理的命令请求的相关信息：</p>
<p>每当一个客户端向服务器发送一条命令请求时， 服务器除了会处理这条命令请求之外， 还会将关于这条命令请求的信息发送给所有监视器</p>
<p>实例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;监视器对象客户端</span><br><span class="line">127.0.0.1:6379&gt; MONITOR</span><br><span class="line">OK</span><br><span class="line">1516477049.121659 [0 127.0.0.1:58004] &quot;ping&quot;  &#x2F;&#x2F;在1516477049.121659个时间点,根据 IP 为 127.0.0.1 、端口号为 56604 的客户端发送的命令请求， 对 0 号数据库执行命令ping</span><br><span class="line">1516477085.685457 [0 127.0.0.1:58004] &quot;set&quot; &quot;testkey&quot; &quot;test&quot;</span><br><span class="line">1516477099.400328 [0 127.0.0.1:58004] &quot;get&quot; &quot;testkey&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;执行命令的客户端</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; set testkey test</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get testkey</span><br><span class="line">&quot;test&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="成为监视器"><a href="#成为监视器" class="headerlink" title="成为监视器"></a>成为监视器</h2><p>伪代码实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def MONITOR():</span><br><span class="line"></span><br><span class="line">    # 打开客户端的监视器标志</span><br><span class="line">    client.flags |&#x3D; REDIS_MONITOR</span><br><span class="line"></span><br><span class="line">    # 将客户端添加到服务器状态的 monitors 链表的末尾</span><br><span class="line">    server.monitors.append(client)</span><br><span class="line"></span><br><span class="line">    # 向客户端返回 OK</span><br><span class="line">    send_reply(&quot;OK&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="向监视器发送命令信息"><a href="#向监视器发送命令信息" class="headerlink" title="向监视器发送命令信息"></a>向监视器发送命令信息</h2><p>服务器在每次处理命令请求之前， 都会调用 replicationFeedMonitors 函数， 由这个函数将被处理命令请求的相关信息发送给各个监视器。</p>
<p>replicationFeedMonitors 函数的伪代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def replicationFeedMonitors(client, monitors, dbid, argv, argc):</span><br><span class="line"></span><br><span class="line">    # 根据执行命令的客户端、当前数据库的号码、命令参数、命令参数个数等参数</span><br><span class="line">    # 创建要发送给各个监视器的信息</span><br><span class="line">    msg &#x3D; create_message(client, dbid, argv, argc)</span><br><span class="line"></span><br><span class="line">    # 遍历所有监视器</span><br><span class="line">    for monitor in monitors:</span><br><span class="line"></span><br><span class="line">        # 将信息发送给监视器</span><br><span class="line">        send_message(monitor, msg)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>redis通过multi/exec/watch等命令来实现事务(transaction)功能.</p>
<p>实例demo:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set name &quot;practical common listp&quot;</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set author &quot;peter seibel&quot;</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get author</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) &quot;practical common listp&quot;</span><br><span class="line">3) OK</span><br><span class="line">4) &quot;peter seibel&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="事务的实现"><a href="#事务的实现" class="headerlink" title="事务的实现"></a>事务的实现</h2><p>事务的实现会经历三个阶段:</p>
<ol>
<li>事务开始;</li>
<li>命令入队;</li>
<li>事务执行</li>
</ol>
<h3 id="事务开始"><a href="#事务开始" class="headerlink" title="事务开始"></a>事务开始</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; MULTI</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>MULTI 命令可以将执行该命令的客户端从非事务状态切换至事务状态， 这一切换是通过在客户端状态的 flags 属性中打开 REDIS_MULTI 标识来完成的</p>
<p>伪代码实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def MULTI():</span><br><span class="line"></span><br><span class="line">    # 打开事务标识</span><br><span class="line">    client.flags |&#x3D; REDIS_MULTI</span><br><span class="line"></span><br><span class="line">    # 返回 OK 回复</span><br><span class="line">    replyOK()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="命令入队"><a href="#命令入队" class="headerlink" title="命令入队"></a>命令入队</h3><p>当一个客户端处于非事务状态时， 这个客户端发送的命令会立即被服务器执行,</p>
<p>当一个客户端切换到事务状态之后， 服务器会根据这个客户端发来的不同命令执行不同的操作:</p>
<ol>
<li>如果客户端发送的命令为 EXEC 、 DISCARD 、 WATCH 、 MULTI 四个命令的其中一个， 那么服务器立即执行这个命令。</li>
<li>如果客户端发送的命令是 EXEC 、 DISCARD 、 WATCH 、 MULTI 四个命令以外的其他命令， 那么服务器并不立即执行这个命令， 而是将这个命令放入一个事务队列里面， 然后向客户端返回 QUEUED 回复。</li>
</ol>
<h3 id="事务队列"><a href="#事务队列" class="headerlink" title="事务队列"></a>事务队列</h3><p>Redis 客户端都有自己的事务状态， 这个事务状态保存在客户端状态的 mstate 属性里面</p>
<p>事务状态的状态结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typedef struct redisClient &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 事务状态</span><br><span class="line">    multiState mstate;      &#x2F;* MULTI&#x2F;EXEC state *&#x2F;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">&#125; redisClient;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>事务队列的结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typedef struct multiState &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 事务队列，FIFO 顺序</span><br><span class="line">    multiCmd *commands;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 已入队命令计数</span><br><span class="line">    int count;</span><br><span class="line"></span><br><span class="line">&#125; multiState;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>事务队列是一个 multiCmd 类型的数组， 数组中的每个 multiCmd 结构都保存了一个已入队命令的相关信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">typedef struct multiCmd &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 参数</span><br><span class="line">    robj **argv;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 参数数量</span><br><span class="line">    int argc;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 命令指针</span><br><span class="line">    struct redisCommand *cmd;</span><br><span class="line"></span><br><span class="line">&#125; multiCmd;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/images/redis/transactionbitmap/IMAGE_TRANSACTION_STATE%E4%BA%8B%E5%8A%A1%E7%8A%B6%E6%80%81.png" alt="IMAGE_TRANSACTION_STATE事务状态"></p>
<h3 id="执行事务"><a href="#执行事务" class="headerlink" title="执行事务"></a>执行事务</h3><p>当一个处于事务状态的客户端向服务器发送 EXEC 命令时， 这个 EXEC 命令将立即被服务器执行： 服务器会遍历这个客户端的事务队列， 执行队列中保存的所有命令， 最后将执行命令所得的结果全部返回给客户端。</p>
<p>EXEC 命令的实现原理可以用以下伪代码来描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">def EXEC():</span><br><span class="line"></span><br><span class="line">    # 创建空白的回复队列</span><br><span class="line">    reply_queue &#x3D; []</span><br><span class="line"></span><br><span class="line">    # 遍历事务队列中的每个项</span><br><span class="line">    # 读取命令的参数，参数的个数，以及要执行的命令</span><br><span class="line">    for argv, argc, cmd in client.mstate.commands:</span><br><span class="line"></span><br><span class="line">        # 执行命令，并取得命令的返回值</span><br><span class="line">        reply &#x3D; execute_command(cmd, argv, argc)</span><br><span class="line"></span><br><span class="line">        # 将返回值追加到回复队列末尾</span><br><span class="line">        reply_queue.append(reply)</span><br><span class="line"></span><br><span class="line">    # 移除 REDIS_MULTI 标识，让客户端回到非事务状态</span><br><span class="line">    client.flags &amp;&#x3D; ~REDIS_MULTI</span><br><span class="line"></span><br><span class="line">    # 清空客户端的事务状态，包括：</span><br><span class="line">    # 1）清零入队命令计数器</span><br><span class="line">    # 2）释放事务队列</span><br><span class="line">    client.mstate.count &#x3D; 0</span><br><span class="line">    release_transaction_queue(client.mstate.commands)</span><br><span class="line"></span><br><span class="line">    # 将事务的执行结果返回给客户端</span><br><span class="line">    send_reply_to_client(client, reply_queue)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="WATCH-命令的实现"><a href="#WATCH-命令的实现" class="headerlink" title="WATCH 命令的实现"></a>WATCH 命令的实现</h2><p>WATCH 命令是一个乐观锁,它可以在exec命令执行之前.监视任意数量的数据库键,并在exec命令执行时,检查被监视的键是否至少有一个已经被修改过了,如果是的话,服务器拒绝执行事务,并向服务器端返回代表事务执行失败的空回复.</p>
<p><img src="/images/redis/transactionbitmap/watch%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%A4%B1%E8%B4%A5%E7%9A%84%E4%BE%8B%E5%AD%90.png" alt="watch命令执行失败的例子"></p>
<p>在T5时执行exec,服务器会发现watch监视的键”name” 已经发生了变化,则拒绝执行A的事务.</p>
<h3 id="使用watch命令监听数据库键"><a href="#使用watch命令监听数据库键" class="headerlink" title="使用watch命令监听数据库键"></a>使用watch命令监听数据库键</h3><p>每个redis数据库保存着一个watched_keys字典,这个字典的键是某个被watch命令监视的数据库键,值则是一个链表,链表记录了所监视的相应数据库键的客户端.</p>
<p>以下是watched_keys字典的实例.通过watch关键字可以使得key和客户端在watched_keys字典中进行关联.</p>
<p><img src="/images/redis/transactionbitmap/%E4%B8%80%E4%B8%AAwatched_keys%E5%AD%97%E5%85%B8.png" alt="一个watched_keys字典"></p>
<h3 id="监视机制的触发"><a href="#监视机制的触发" class="headerlink" title="监视机制的触发"></a>监视机制的触发</h3><p>对数据库进行写操作的时候,都会调用touchWatchKey函数进行检查,检查是否客户端正在监视刚刚被命令修改过的数据库键.如果有的话,那么该函数会将监视被修改键的客户端的REDIS_DIRTY_CAS 标示打开,标示客户端的事务的安全性被破坏.</p>
<h3 id="判断事务是否安全"><a href="#判断事务是否安全" class="headerlink" title="判断事务是否安全"></a>判断事务是否安全</h3><p>在服务器收到一个客户端发过来的exec命令时,服务器检查这个客户端是否打开 REDIS_DIRTY_CAS.打开了则放弃执行,没打开则执行.</p>
<h3 id="一个完整事务的执行过程"><a href="#一个完整事务的执行过程" class="headerlink" title="一个完整事务的执行过程"></a>一个完整事务的执行过程</h3><p>一个C1的客户端在执行watch name命令后,watch_keys字典的当前状态为name–C1;接下来客户端C1执行如下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C1&gt;multi</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">C1&gt;set name &quot;peter&quot;</span><br><span class="line">QUEUED</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这时,C2客户端执行set name “test” 命令,C2执行这个set命令会导致那些正在监视name键的客户端的REDIS_DIRTY_CAS标示被打开,其中包括C1客户端</p>
<p>之后,C1执行exec操作,发现REDIS_DIRTY_CAS处于打开的状态,则服务器拒绝它提交事务.</p>
<h2 id="事务的-ACID-性质"><a href="#事务的-ACID-性质" class="headerlink" title="事务的 ACID 性质"></a>事务的 ACID 性质</h2><p>事务的原子性,一致性,隔离性和持久性简称ACID可以检查事务的可靠性和安全性.</p>
<h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><p>要么全部执行,要么不执行.下面的例子中事务有错误的命令,所以事务中的所有命令不可以执行.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get</span><br><span class="line">(error) ERR wrong number of arguments for &#39;get&#39; command</span><br><span class="line">127.0.0.1:6379&gt; get message</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>redis的事务和传统的关系型数据库最大区别在于不支持事务的回滚机制.</p>
<h3 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h3><p>事务的一致性是指,数据库的状态在事务执行之前和执行之后(无论是否成功)都是一致的.</p>
<h4 id="入队错误"><a href="#入队错误" class="headerlink" title="入队错误"></a>入队错误</h4><p>在入队的过程中出现错误,则redis拒绝执行该事务.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set name test</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; ddd</span><br><span class="line">(error) ERR unknown command &#39;ddd&#39;</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="执行错误"><a href="#执行错误" class="headerlink" title="执行错误"></a>执行错误</h4><p>比如一个type为String类型的键,执行了lpush操作.在入队时是发现不了的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; type name</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lpush name 1 2 3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">1) (error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br><span class="line">2) &quot;test&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>出错的命令会被服务器识别出来,不去执行,所以不会对数据库造成影响.</p>
<h3 id="隔离性"><a href="#隔离性" class="headerlink" title="隔离性"></a>隔离性</h3><p>事务的隔离性是指,即使数据库中有多个事务并发的执行,各个事务之间也不会互相的影响.并且并发状态下执行的事务和串行执行的事务产生的结果完全相同.</p>
<p>由于redis是单线程的,所以事务的执行都是串行的,所以事务是具有隔离性的.</p>
<h3 id="持久性"><a href="#持久性" class="headerlink" title="持久性"></a>持久性</h3><p>事务的持久性是指,当一个事务执行完毕时,执行这个事务的结果已经被永久的保存到数据库中了,即使服务器停机,结果也不会丢失.</p>
<p>redis事务只是简单的将命令包裹在一起,并没有提供持久化的功能.具体是否持久化到硬盘是有redis的持久化机制决定的.所以redis是否持久化是与redis事务没有关系的.</p>
<h1 id="二进制位数组"><a href="#二进制位数组" class="headerlink" title="二进制位数组"></a>二进制位数组</h1><p>redis提供了SETBIT GETBIT BITCOUNT BITOP四个命令用于处理二进制输入(位数组)</p>
<p>setbit命令用于为位数组指定偏移量上的二进制位设置值,位数组的<strong>偏移量从0开始计数</strong>,而<strong>二进制位的值则可以是0或者1</strong>.返回该位置原先的值.</p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit bit 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit bit 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit bit 0 0</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>getbit则用于获取位数组指定偏移量上的二进制位的值.</p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getbit bit 100</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit bit 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit bit 3</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>bitcount 用于统计位数组里面,值为1的二进制位的数量.</p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitcount bit 0 -1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>

<p>bitcount 命令可以对多个位数组进行按位与(and) 或(or) 异或(xor)运算</p>
<p>与运算：0&amp;0=0;  0&amp;1=0;   1&amp;0=0;    1&amp;1=1;(两位同时为“1”，结果才为“1”，否则为0)<br>或运算: 0|0=0；  0|1=1；  1|0=1；   1|1=1；(参加运算的两个对象只要有一个为1，其值为1。)<br>异或运算:0^0=0；  0^1=1；  1^0=1；   1^1=0；(参加运算的两个对象，如果两个相应位为“异”（值不同），则该位结果为1，否则为0。)</p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit x 3 1   x &#x3D;0000 1011</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit x 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit x 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit y 2 1   y &#x3D;0000 0110</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit y 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit z 2 1   z &#x3D;0000 0101</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit z 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; bitop and resultand x y z   0000 0000</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount resultand 0  -1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; bitop or resultor x y z     0000 1111</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount resultor 0 -1</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; bitop xor resultxor x y z  0000 1000</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount resultxor 0 -1</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="位数组的表示"><a href="#位数组的表示" class="headerlink" title="位数组的表示"></a>位数组的表示</h2><p>位数组采用字符串对象表示.</p>
<p><img src="/images/redis/transactionbitmap/SDS%E8%A1%A8%E7%A4%BA%E7%9A%84%E4%BD%8D%E6%95%B0%E7%BB%84.png" alt="SDS表示的位数组"></p>
<p>redisObject.type的值为REDIS_STRING</p>
<p>sdshdr.len的值为1</p>
<p>buf数组中的buf[0]表示存了一字节畅的位数组.</p>
<p>buf数组中的buf[1]字节保存了SDS程序自动追加到值末尾的空字符串’\0’</p>
<p><img src="/images/redis/transactionbitmap/%E4%B8%80%E5%AD%97%E8%8A%82%E9%95%BF%E7%9A%84%E4%BD%8D%E6%95%B0%E7%BB%84%E7%9A%84SDS%E8%A1%A8%E7%A4%BA.png" alt="一字节长的位数组的SDS表示"></p>
<h2 id="GETBIT命令的实现"><a href="#GETBIT命令的实现" class="headerlink" title="GETBIT命令的实现"></a>GETBIT命令的实现</h2><p>getbit <bitarray> <offset></p>
<ol>
<li>计算byte=(offset/8) byte值记录了offset偏移量指定的二进制位保存在数组的哪个字节;</li>
<li>计算bit=(offset mod 8) +1 ,bit位记录了offset偏移量指定的二进制位是byte字节的第几个二进制位;</li>
<li>根据byte值和bit值.在位数组bitarray中定位offset偏移量制定的二进制位.并返回这个位的值;</li>
</ol>
<p>例子:</p>
<p>GETBIT <bitarray> 3</p>
<ol>
<li><p>3/8 的值为0.</p>
</li>
<li><p>(3 mod 8) +1的值为4</p>
</li>
<li><p>定位到buf[0]字节上面.人后去除第四个二进制位的值为1 返回给客户端</p>
</li>
</ol>
<p>以上操作都在常数时间内完成,时间复杂度为O(1)</p>
<h2 id="SETBIT命令的实现"><a href="#SETBIT命令的实现" class="headerlink" title="SETBIT命令的实现"></a>SETBIT命令的实现</h2><p>SET <bitarray> <offset> <value></p>
<ol>
<li>len =(offset/8)+1 计算出需要多少字节;</li>
<li>检查bitarray键保存的长度是否小于len,如果是的话则扩展空间为len字节,并将所有的新空间的二进制位设置为0</li>
<li>计算byte=(offset/8) byte值记录了offset偏移量指定的二进制位保存的位数在哪个字节上</li>
<li>bit= (offset mod 8)+1 bit记录了偏移量指定的二进制位是byte字节的第几个二进制位;</li>
<li>byte值和bit值,在bitarray键保存的位数组中定位offset偏移量指定的二进制位,先将保存新值,然后返回旧值给客户端.</li>
</ol>
<h2 id="BITCOUNT命令的实现"><a href="#BITCOUNT命令的实现" class="headerlink" title="BITCOUNT命令的实现"></a>BITCOUNT命令的实现</h2><p>bitcount <bitarray></p>
<p>计算二进制数组中1的个数</p>
<p>算法:</p>
<p>采用的是查表和variable-precisionSWAR两种算法.具体细节可自行查阅资料.</p>
<h2 id="BITOP命令"><a href="#BITOP命令" class="headerlink" title="BITOP命令"></a>BITOP命令</h2><p>采用的是计算机的位运算符操作,将结果放到给定的键上</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-21/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-21/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85/" class="post-title-link" itemprop="url">redis设计与实现-发布与订阅</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-21 00:36:05" itemprop="dateCreated datePublished" datetime="2018-01-21T00:36:05+08:00">2018-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>redis的订阅与发布功能由publish subscribe psubscribe等命令组成.客户端可以订阅<strong>多个频道</strong>或者<strong>订阅多个模式</strong>.从而成为这些明道的订阅者.当其它客户端向这些频道发送消息,这些地订阅者可以收到.</p>
<p><img src="/images/redis/subscribe/%E5%B0%86%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E5%88%B0%E9%A2%91%E9%81%93%E8%AE%A2%E9%98%85%E8%80%85%E5%92%8C%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%BC%8F%E7%9A%84%E8%AE%A2%E9%98%85%E8%80%85.png" alt="将消息发送到频道订阅者和匹配模式的订阅者"></p>
<p>订阅一个news.it频道和以及接收到其它客户端向这个频道发送来的信息.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">订阅者</span><br><span class="line">127.0.0.1:6379&gt; subscribe &quot;news.it&quot;</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;news.it&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line"></span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;news.it&quot;</span><br><span class="line">3) &quot;hello&quot;</span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;news.it&quot;</span><br><span class="line">3) &quot;test&quot;</span><br><span class="line"></span><br><span class="line">发布者</span><br><span class="line">127.0.0.1:6379&gt; publish &quot;news.it&quot; hello</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; publish &quot;news.it&quot; test</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="频道的订阅与退订"><a href="#频道的订阅与退订" class="headerlink" title="频道的订阅与退订"></a>频道的订阅与退订</h1><p>当一个客户端执行 SUBSCRIBE 命令， 订阅某个或某些频道的时候， 这个客户端与被订阅频道之间就建立起了一种订阅关系。</p>
<p>Redis 将所有频道的订阅关系都保存在服务器状态的 pubsub_channels 字典里面， 这个字典的键是某个被订阅的频道， 而键的值则是一个链表， 链表里面记录了所有订阅这个频道的客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct redisServer &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 保存所有频道的订阅关系</span><br><span class="line">    dict *pubsub_channels;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一个pubsub_channels字典示例:</p>
<p><img src="/images/redis/subscribe/%E4%B8%80%E4%B8%AApubsub_channels%E5%AD%97%E5%85%B8%E7%A4%BA%E4%BE%8B.png" alt="一个pubsub_channels字典示例"></p>
<h2 id="订阅频道"><a href="#订阅频道" class="headerlink" title="订阅频道"></a>订阅频道</h2><p>每当客户端执行 SUBSCRIBE 命令， 订阅某个或某些频道的时候， 服务器都会将客户端与被订阅的频道在 pubsub_channels 字典中进行关联。</p>
<ol>
<li>如果频道已经有其他订阅者， 那么它在 pubsub_channels 字典中必然有相应的订阅者链表， 程序唯一要做的就是将客户端添加到订阅者链表的末尾。</li>
<li>如果频道还未有任何订阅者， 那么它必然不存在于 pubsub_channels 字典， 程序首先要在 pubsub_channels 字典中为频道创建一个键， 并将这个键的值设置为空链表， 然后再将客户端添加到链表， 成为链表的第一个元素。</li>
</ol>
<p>SUBSCRIBE 命令的实现可以用以下伪代码来描述：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def subscribe(*all_input_channels):</span><br><span class="line"></span><br><span class="line">    # 遍历输入的所有频道</span><br><span class="line">    for channel in all_input_channels:</span><br><span class="line"></span><br><span class="line">        # 如果 channel 不存在于 pubsub_channels 字典（没有任何订阅者）</span><br><span class="line">        # 那么在字典中添加 channel 键，并设置它的值为空链表</span><br><span class="line">        if channel not in server.pubsub_channels:</span><br><span class="line">            server.pubsub_channels[channel] &#x3D; []</span><br><span class="line"></span><br><span class="line">        # 将订阅者添加到频道所对应的链表的末尾</span><br><span class="line">        server.pubsub_channels[channel].append(client)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="退订频道"><a href="#退订频道" class="headerlink" title="退订频道"></a>退订频道</h2><p>UNSUBSCRIBE 命令的行为和 SUBSCRIBE 命令的行为正好相反 —— 当一个客户端退订某个或某些频道的时候， 服务器将从 pubsub_channels 中解除客户端与被退订频道之间的关联：</p>
<ol>
<li>程序会根据被退订频道的名字， 在 pubsub_channels 字典中找到频道对应的订阅者链表， 然后从订阅者链表中删除退订客户端的信息。</li>
<li>如果删除退订客户端之后， 频道的订阅者链表变成了空链表， 那么说明这个频道已经没有任何订阅者了， 程序将从 pubsub_channels 字典中删除频道对应的键。</li>
</ol>
<h1 id="模式的订阅与退订"><a href="#模式的订阅与退订" class="headerlink" title="模式的订阅与退订"></a>模式的订阅与退订</h1><p>与频道类似,服务器将所有模式的订阅关系都保存在服务器状态的pubsub_pattterns属性里面:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct redisServer &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 保存所有模式的订阅关系</span><br><span class="line">    list *pubsub_pattterns;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>pubsub_pattterns是一个链表,链表中每个及诶点都包含着pubsub_patttern结构,这个结构的pattern属性记录了被订阅的模式,而client记录了订阅模式的客户端.</p>
<p><img src="/images/redis/subscribe/pubsub_pattterns%E9%93%BE%E8%A1%A8%E7%9A%84%E5%AE%9E%E4%BE%8B.png" alt="pubsub_pattterns链表的实例"></p>
<h2 id="订阅模式"><a href="#订阅模式" class="headerlink" title="订阅模式"></a>订阅模式</h2><p>每个客户端执行psubscribe命令的订阅某个模式的时候,服务器会对每个订阅的模式执行以下两个操作.</p>
<ol>
<li>新建一个pubsub_patttern的结构,将新结构的pattern属性设置为被订阅的模式,clients属性升值而为订阅模式的客户端.</li>
<li>将pubsub_patttern结构添加到pubsub_pattterns链表的尾端.</li>
</ol>
<p>执行psubscribe “news.*”</p>
<p><img src="/images/redis/subscribe/%E6%89%A7%E8%A1%8Cpsubscribe%E5%90%8E%E7%9A%84%E9%93%BE%E8%A1%A8.png" alt="执行psubscribe后的链表"></p>
<h2 id="退订模式"><a href="#退订模式" class="headerlink" title="退订模式"></a>退订模式</h2><p>当punsubscribe执行的时候,服务器将遍历pubsub_pattterns链表,查找并删除那些pattern模式为被退订模式.</p>
<h1 id="发送消息"><a href="#发送消息" class="headerlink" title="发送消息"></a>发送消息</h1><p>当一个redis客户端执行publish命令将小心message发送到频道channel的时候,服务器执行以下2个动作:</p>
<ol>
<li>将message发送给channel频道的订阅者;</li>
<li>如果有一个或者多个模式pattern与频道channel相匹配,那么消息message发送给pattern模式的订阅者;</li>
</ol>
<h2 id="将消息发送给频道的订阅者"><a href="#将消息发送给频道的订阅者" class="headerlink" title="将消息发送给频道的订阅者"></a>将消息发送给频道的订阅者</h2><p>将消息发送给channel频道的所有订阅者,就是将pubsub_chanels字典了找到频道的订阅者名单,然后将消息发送给其客户端.</p>
<p><img src="/images/redis/subscribe/%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E8%BF%98%E7%BB%99%E9%A2%91%E9%81%93%E8%AE%A2%E9%98%85%E8%80%85%E7%9A%84%E4%BC%AA%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0.png" alt="发送消息还给频道订阅者的伪代码实现"></p>
<h2 id="将消息发送给模式订阅者"><a href="#将消息发送给模式订阅者" class="headerlink" title="将消息发送给模式订阅者"></a>将消息发送给模式订阅者</h2><p>将消息发送给channel频道模式相匹配的所有订阅者,就是将pubsub_patterns链表了找到频道相匹配的模式,然后将消息发送给其客户端.</p>
<p><img src="/images/redis/subscribe/%E5%B0%86%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%BB%99%E6%A8%A1%E5%BC%8F%E8%AE%A2%E9%98%85%E8%80%85%E7%9A%84%E4%BC%AA%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0.png" alt="将消息发送给模式订阅者的伪代码实现"></p>
<h1 id="查看订阅信息"><a href="#查看订阅信息" class="headerlink" title="查看订阅信息"></a>查看订阅信息</h1><p>通过pubsub命令查看频道和模式的相关信息.</p>
<h2 id="pubsub-channels-pattern"><a href="#pubsub-channels-pattern" class="headerlink" title="pubsub channels [pattern]"></a>pubsub channels [pattern]</h2><p>返回服务器当前被订阅的频道,其中pattern是可选的参数;</p>
<p><img src="/images/redis/subscribe/pubsub_channel%E4%BC%AA%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0.png" alt="pubsub_channel伪代码实现"></p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pubsub channels</span><br><span class="line">1) &quot;news.it&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="pubsub-numsub-chanel-1-channel-2…"><a href="#pubsub-numsub-chanel-1-channel-2…" class="headerlink" title="pubsub numsub [chanel-1,channel-2…]"></a>pubsub numsub [chanel-1,channel-2…]</h2><p>接收任意多个频道作为输入参数,并返回这些频道的订阅数量</p>
<p><img src="/images/redis/subscribe/pubsub_numsub%E4%BC%AA%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0.png" alt="pubsub_numsub伪代码实现"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pubsub numsub &quot;news.it&quot;</span><br><span class="line">1) &quot;news.it&quot;</span><br><span class="line">2) (integer) 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="PUBSUB-NUMPAT"><a href="#PUBSUB-NUMPAT" class="headerlink" title="PUBSUB NUMPAT"></a>PUBSUB NUMPAT</h2><p>返回服务器当前被订阅模式的数量,其实就是返回pubsub_patterns的链表的长度.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pubsub numpat</span><br><span class="line">(integer) 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>



























      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-18/elasticsearch%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-18/elasticsearch%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">elasticsearch入门教程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-18 15:56:37" itemprop="dateCreated datePublished" datetime="2018-01-18T15:56:37+08:00">2018-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h1><p>有一张答题记录表，主要字段如下。由于数据量比较大，所以按照学员id的后两位横向分表为100张表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">&#96;stu_id&#96; int(11) NOT NULL COMMENT &#39;学员id&#39;,</span><br><span class="line">&#96;stu_total_score&#96; decimal(4,1) DEFAULT NULL COMMENT &#39;学员得分&#39;,, </span><br><span class="line">&#96;t_paper_id&#96; int(11) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;试卷id&#39;,</span><br><span class="line">&#96;total_time&#96; int(11) DEFAULT NULL COMMENT &#39;答题总用时，单位为s&#39;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有一需求，需要实时的根据stu_id获取该学员的paperId下的排名，以及学员排行榜（前10名），规则是按照分数降序、答题时间升序。</p>
<p>方案一：用union all 关键字关联100张表（是按照stu_id分表的），进行排序。然后获取学员的名次和排行榜。（由于数据量巨大，这种方案显然是不可取的）</p>
<p>方案二：使用redis的sorted set类型存储数据，但是细想其实 sorted set只能以一个字段作为排序字段，也是不可取的</p>
<p>方案三: 使用es，将所有的数据入es。</p>
<p>后续在生产环境使用es，由于有实时的查询排行榜的需求，所以在index数据入es的时候，实时的setRefresh操作，这样，在并发量比较大的时候，造成es响应很慢，大概50至60秒。</p>
<p>后来翻阅相关资料，发现es其实根本不适合做排序相关的排行榜需求，我们可以使用redis，将排序的2个字段加权后作为sorted set的score，实时证明，redis才是非常适合做实时排序相关功能的。</p>
<h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><h2 id="近实时："><a href="#近实时：" class="headerlink" title="近实时："></a>近实时：</h2><p>Elasticsearch 是一个接近实时的搜索平台。这意味着，从索引一个文档直到这个文档能够被搜索到有一个很小的延迟（通常是 1 秒）。</p>
<h2 id="集群（cluster）："><a href="#集群（cluster）：" class="headerlink" title="集群（cluster）："></a>集群（cluster）：</h2><p>一个集群就是由一个或多个节点组织在一起， 它们共同持有你全部的数据， 并一起<strong>提供索引和搜索功能</strong>。 一个集群由一个唯一的名字标识， 这个名字默认就是“elasticsearch”。 这个名字很重要， 因为一个节点只能通过指定某个集群的名字，来加入这个集群。一个集群中只包含一个节点是合法的。另外，你也可以拥有多个集群，集群以名字区分。</p>
<h2 id="节点（node）："><a href="#节点（node）：" class="headerlink" title="节点（node）："></a>节点（node）：</h2><p>一个节点是你集群中的一个服务器，作为集群的一部分，它存储你的数据，参与集群的索引和搜索功能。 和集群类似， 一个节点也是由一个名字来标识的， 默认情况下， 这个名字是一个随机的Marvel角色的名字，这个名字会在节点启动时分配给它。一个节点可以通过配置集群名称的方式来加入一个指定的集群。 默认情况下，每个节点都会被安排加入到一个叫做“elasticsearch”的集群中，这意味着，如果你在你的网络中启动了若干个节点， 并假定它们能够相互发现彼此，它们将会自动地形成并加入到一个叫做“elasticsearch” 的集群中。</p>
<p> <strong>注意：</strong>如果当前你的网络中没有运行任何Elasticsearch节点，这时启动一个节点，会默认创建并加入一个叫做“elasticsearch”的单节点集群。</p>
<h2 id="索引（index）"><a href="#索引（index）" class="headerlink" title="索引（index）:"></a>索引（index）:</h2><p>一个索引就是一个拥有相似特征的文档的集合。(相当于mysql的db) 。一个索引由一个名字来 标识（必须全部是小写字母的）</p>
<h2 id="类型（type）："><a href="#类型（type）：" class="headerlink" title="类型（type）："></a>类型（type）：</h2><p>在一个索引中，你可以定义一种或多种类型。（相当于mysql的table）一个类型是你的索引的一个逻辑上的分类/分区，其语义完全由你来定。通常，会为具有一组相同字段的文档定义一个类型。</p>
<h2 id="文档（document）："><a href="#文档（document）：" class="headerlink" title="文档（document）："></a>文档（document）：</h2><p>一个文档是一个可被索引的基础信息单元。（相当于mysql的一条数据）文档以JSON格式来表示</p>
<h2 id="分片和复制（shards-and-replicas）："><a href="#分片和复制（shards-and-replicas）：" class="headerlink" title="分片和复制（shards and replicas）："></a>分片和复制（shards and replicas）：</h2><h3 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h3><p>一个索引可以存储超出单个结点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点可能<strong>没有这样大的磁盘空间</strong>来存储或者<strong>单个节点处理搜索请求，响应会太慢</strong>。</p>
<ol>
<li>允许你水平分割/扩展你的内容容量</li>
<li>允许你在分片（位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量</li>
</ol>
<p>当你创建一个索引的时候，你可以指定你想要的分片的数量。</p>
<h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><ol>
<li>在分片/节点失败的情况下，复制提供了高可用性。复制分片不与原/主要分片置于同一节点上是非常重要的。</li>
<li>因为搜索可以在所有的复制上并行运行，复制可以扩展你的搜索量/吞吐量</li>
</ol>
<p>分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你不能再改变分片的数量。</p>
<p>默认情况下，Elasticsearch中的每个索引分配5个主分片和1个复制。这意味着，如果你的集群中至少有两个节点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样每个索引总共就有10个分片。</p>
<h1 id="安装-（待补充）"><a href="#安装-（待补充）" class="headerlink" title="安装 （待补充）"></a>安装 （待补充）</h1><p>需要jdk1.7 +  </p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/downloads/elasticsearch">下载 tar包</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf *.tar.gz</span><br><span class="line">cd bin</span><br><span class="line">.&#x2F;elasticsearch</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="操作集群"><a href="#操作集群" class="headerlink" title="操作集群"></a>操作集群</h1><h2 id="查看集群健康"><a href="#查看集群健康" class="headerlink" title="查看集群健康"></a>查看集群健康</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">get请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;_cat&#x2F;health?v</span><br><span class="line"></span><br><span class="line">epoch      timestamp cluster status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent </span><br><span class="line">1516295539 01:12:19  ENT-ES  yellow          1         1     51  51    0    0       51             0                  -                 50.0% </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们可能得到绿色、黄色或红色三种状态。绿色代表一切正常（集群功能齐全）；黄色意味着所有的数据都是可用的，但是某些复制没有被分配（集群功能齐全）； 红色则代表因为某些原因，某些数据不可用,但是可能你需要尽快修复它，因为你有丢失的数据。</p>
<h2 id="集群节点"><a href="#集群节点" class="headerlink" title="集群节点"></a>集群节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;_cat&#x2F;nodes?v</span><br><span class="line"></span><br><span class="line">host           ip             heap.percent ram.percent load node.role master name     </span><br><span class="line">172.16.116.121 172.16.116.121           36          91 0.81 d         *      TEST_ENT </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>TEST_ENT代表的是节点的名称</p>
<h2 id="列出索引"><a href="#列出索引" class="headerlink" title="列出索引"></a>列出索引</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">get请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;_cat&#x2F;indices?v</span><br><span class="line"></span><br><span class="line">health status index                         pri rep docs.count docs.deleted store.size pri.store.size </span><br><span class="line">yellow open   teacher_platform_unit           5   1       6634           17      2.3mb          2.3mb </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="添加索引"><a href="#添加索引" class="headerlink" title="添加索引"></a>添加索引</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">get请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;?pretty</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;_cat&#x2F;indices?v</span><br><span class="line"></span><br><span class="line">health status index                         pri rep docs.count docs.deleted store.size pri.store.size </span><br><span class="line">yellow open   customer                        5   1          0            0       650b           650b </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们现在有一个叫做 customer 的索引，并且它有5个主分片和1份复制（都是默认值），其中包含0个文档。</p>
<p>由于现在我们只有一个节点在运行，那一份复制就分配不了了（为了高可用），直到当另外一个节点加入到这个集群后，才能分配。一旦那份复制在第二个节点上被复制，这个节点(黄色)的健康状态就会变成绿色。</p>
<h2 id="索引文档"><a href="#索引文档" class="headerlink" title="索引文档"></a>索引文档</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">put请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;1?pretty </span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;John Doe&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当你想将文档索引到某个索引的时候，Elasticsearch并不强制要求这个索引被显式地创建。在前面这个例子中，如果customer索引不存在，Elasticsearch将会自动地创建这个索引。</p>
<h2 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">get请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;1?pretty</span><br><span class="line"></span><br><span class="line">response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;John Doe&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">delete请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;1?pretty</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 2,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;1?pretty</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;found&quot;: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">delete请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;?pretty</span><br><span class="line"></span><br><span class="line">response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h2><p>默认情况下，从你索引/更新/删除你的数据动作开始到它出现在你的搜索结果中，大概会有1秒钟的延迟。这和其它的SQL平台不同，它们的数据在一个事务完成之后就会立即可用。</p>
<p>修改前的数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">get请求：</span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;2?pretty  -d</span><br><span class="line"></span><br><span class="line">response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot;: 2,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;John Smith&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>使用一个新的document来修改id为2的数据（replace）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">put请求：</span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;2?pretty  -d</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;John Wall&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">  &quot;_version&quot;: 3,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot;: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>id是可选的，如果不指定，则es会产生一个随机的id。由于没有指定id，则使用的是post请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post请求:</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;?pretty  -d</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;chenweijie&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;AWEM3CUozADEKUeU9hxP&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><p>Elasticsearch底层并不支持原地更新。在我们想要做一次更新的时候，Elasticsearch先删除旧文档，然后再索引更新的新文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post请求：</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;external&#x2F;1&#x2F;_update?pretty</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123; &quot;name&quot;: &quot;Jane Ball&quot;, &quot;age&quot;: 20 &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 3,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 0,</span><br><span class="line">    &quot;successful&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="搜索API-（复杂查询）"><a href="#搜索API-（复杂查询）" class="headerlink" title="搜索API （复杂查询）"></a>搜索API （复杂查询）</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">REST API 可以通过_search终点(endpoint)来访问</span><br><span class="line"></span><br><span class="line">get请求：</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;_search?q&#x3D;*&amp;pretty</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 18,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;AWEM3CUozADEKUeU9hxP&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;chenweijie&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;John Wall&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;John tes&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上搜索等价于 请求体方法的等价搜索是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">post请求</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;customer&#x2F;_search?pretty</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 1,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;AWEM3CUozADEKUeU9hxP&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;chenweijie&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;John Wall&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;external&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;John tes&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们在customer索引中搜索（ _search终点），并且q=*参数指示Elasticsearch去匹配这个索引中所有的文档。pretty参数仅仅是告诉Elasticsearch返回美观的JSON结果。</p>
<ul>
<li>took：Elasticsearch 执行这个搜索的耗时，以毫秒为单位</li>
<li>timed_out：指明这个搜索是否超时</li>
<li>_shards：指出多少个分片被搜索了，同时也指出了成功/失败的被搜索的shards 的数量</li>
<li>hits：搜索结果</li>
<li>hits.total：匹配查询条件的文档的总数目</li>
<li>hits.hits：真正的搜索结果数组（默认是前10个文档）</li>
</ul>
<ul>
<li>搜索中只返回指定的字段：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">post请求：</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;t_tiku_user_record&#x2F;_search?pretty</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot;: [</span><br><span class="line">    &quot;knowledgeTreeId&quot;,</span><br><span class="line">    &quot;continousDays&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 25,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 11,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10000&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;continousDays&quot;: 1</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10006&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;continousDays&quot;: 1</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查询条件:stuTotalScore为3000的数据：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">post请求：</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;t_tiku_user_record&#x2F;_search?pretty</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; &quot;match&quot;: &#123; &quot;stuTotalScore&quot;: 3000 &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 60,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10000&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;createTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;updateTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;knowledgeNodeId&quot;: 12,</span><br><span class="line">          &quot;stuTotalScore&quot;: &quot;3000&quot;,</span><br><span class="line">          &quot;endTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;tPaperId&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>或查询（should）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">post请求：</span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;t_tiku_user_record&#x2F;_search?pretty</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;stuTotalScore&quot;: 3000 &#125; &#125;,</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;stuTotalScore&quot;: 3001 &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 32,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;max_score&quot;: 0.39103588,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10001&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.39103588,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;createTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;updateTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;knowledgeNodeId&quot;: 12,</span><br><span class="line">          &quot;stuTotalScore&quot;: &quot;3001&quot;,</span><br><span class="line">          &quot;endTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;tPaperId&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10000&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.25427115,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;createTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;updateTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;knowledgeNodeId&quot;: 12,</span><br><span class="line">          &quot;stuTotalScore&quot;: &quot;3000&quot;,</span><br><span class="line">          &quot;endTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;tPaperId&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>且查询（must）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">post请求：</span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;t_tiku_user_record&#x2F;_search?pretty</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;knowledgeTreeId&quot;: 16 &#125; &#125;,</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;stuTotalScore&quot;: 3001 &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 5,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;max_score&quot;: 1.5756677,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10001&quot;,</span><br><span class="line">        &quot;_score&quot;: 1.5756677,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;createTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;updateTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;knowledgeNodeId&quot;: 12,</span><br><span class="line">          &quot;stuTotalScore&quot;: &quot;3001&quot;,</span><br><span class="line">          &quot;endTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;tPaperId&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="执行过滤器"><a href="#执行过滤器" class="headerlink" title="执行过滤器"></a>执行过滤器</h2><p>文档得分的细节（搜索结果中的_score字段）。这个得分是指定的搜索查询匹配程度的一个相对度量。得分越高，文档越相关，得分越低文档的相关度越低</p>
<p>过滤器的形式提供了另一种查询功能。过滤器在概念上类似于查询，但是它们有非常快的执行速度，这种快的执行速度主要有以下两个原因：</p>
<ol>
<li>过滤器不会计算相关度的得分，所以它们在计算上更快一些</li>
<li>过滤器可以被缓存到内存中，这使得在重复的搜索查询上，其要比相应的查询快出许多。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">post请求：</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;172.16.116.121:9200&#x2F;t_tiku_user_record&#x2F;_search?pretty</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;filtered&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;stuTotalScore&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 3000,</span><br><span class="line">            &quot;lte&quot;: 3002</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response：</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 1,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10000&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;createTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;updateTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;knowledgeNodeId&quot;: 12,</span><br><span class="line">          &quot;stuTotalScore&quot;: &quot;3000&quot;,</span><br><span class="line">          &quot;endTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;tPaperId&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10001&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;createTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;updateTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;knowledgeNodeId&quot;: 12,</span><br><span class="line">          &quot;stuTotalScore&quot;: &quot;3001&quot;,</span><br><span class="line">          &quot;endTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;tPaperId&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;t_tiku_user_record&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;90-10002&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;knowledgeTreeId&quot;: 16,</span><br><span class="line">          &quot;createTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;updateTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;knowledgeNodeId&quot;: 12,</span><br><span class="line">          &quot;stuTotalScore&quot;: &quot;3002&quot;,</span><br><span class="line">          &quot;endTime&quot;: &quot;2018-01-18T08:12:57.068Z&quot;,</span><br><span class="line">          &quot;tPaperId&quot;: 100</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="执行聚合"><a href="#执行聚合" class="headerlink" title="执行聚合"></a>执行聚合</h2><p>聚合查询，主要用于统计相关的，在这里不做详细介绍。具体细节可以翻阅其它资料。</p>
<p><a target="_blank" rel="noopener" href="https://endymecy.gitbooks.io/elasticsearch-guide-chinese/content/index.html">参考资料</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chenwj.cn/2018-01-16/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon.ico">
      <meta itemprop="name" content="陈伟杰">
      <meta itemprop="description" content="学习，坚持。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="茄子的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018-01-16/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF/" class="post-title-link" itemprop="url">redis设计与实现-客户端和服务端</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-16 01:43:55" itemprop="dateCreated datePublished" datetime="2018-01-16T01:43:55+08:00">2018-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-08-21 01:03:09" itemprop="dateModified" datetime="2020-08-21T01:03:09+08:00">2020-08-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h1><p>redis服务器与客户端是一对多的关系,使用由I/O多路复用技术实现的文件事件处理器,redis服务器单线程和单进程的方式来处理命令请求,并与多个客户端进行网络通信.</p>
<p>redisClient结构保存了客户端当前的状态信息:</p>
<ol>
<li>客户端的套接字描述</li>
<li>客户端的名字</li>
<li>客户端的标志值 flag</li>
<li>执行客户端正在使用的数据库的指针,以及数据库的号码</li>
<li>客户端当前要执行的命令/命令的参数/命令参数的个数/指向命令实现函数的指针</li>
<li>客户端输入和输出缓冲区</li>
<li>客户端复制状态信息以及进行复制所需要的数据结构</li>
<li>客户端执行BRPOP BLPOP等等列表阻塞命令时使用的数据结构</li>
<li>客户端的事务状态以及watch命令用到的数据结构</li>
<li>身份验证标志</li>
<li>客户端的创建时间,客户端和服务端最后的通信时间等</li>
</ol>
<p>Redis服务器状态结构的<strong>clients属性是一个链表</strong>,这个链表保存了所有连接的客户端的状态结构</p>
<p><img src="/images/redis/serverClient/redisServer%E7%9A%84clients.png" alt="redisServer的clients"></p>
<p><img src="/images/redis/serverClient/clients%E9%93%BE%E8%A1%A8.png" alt="clients链表"></p>
<h2 id="客户端属性"><a href="#客户端属性" class="headerlink" title="客户端属性"></a>客户端属性</h2><p>一种是通用的属性,另一种是特定功能的属性</p>
<h3 id="套接字描述"><a href="#套接字描述" class="headerlink" title="套接字描述"></a>套接字描述</h3><p>td属性 fd属性的值可以是-1或者大于-1的整数:</p>
<p>伪客户端的fd属性的值为-1,它处理的命令来自AOF文件或者Lua脚本,而不是网络.</p>
<p>普通客户端的fd属性值为大于-1的整数,它使用套接字来与服务器进行通讯,所以服务器使用fd属性来记录客户端套接字的描述符.</p>
<p>客户端的描述信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">27.0.0.1:6379&gt; CLIENT LIST</span><br><span class="line">id&#x3D;2 addr&#x3D;127.0.0.1:53958 fd&#x3D;5 name&#x3D; age&#x3D;25 idle&#x3D;0 flags&#x3D;N db&#x3D;0 sub&#x3D;0 psub&#x3D;0 multi&#x3D;-1 qbuf&#x3D;0 qbuf-free&#x3D;32768 obl&#x3D;0 oll&#x3D;0 omem&#x3D;0 events&#x3D;r cmd&#x3D;client</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="名字"><a href="#名字" class="headerlink" title="名字"></a>名字</h3><p>默认的客户端时没有名字的,可以使用client setname来设置名字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CLIENT SETNAME testName</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; CLIENT GETNAME</span><br><span class="line">&quot;testName&quot;</span><br><span class="line">127.0.0.1:6379&gt; CLIENT LIST</span><br><span class="line">id&#x3D;2 addr&#x3D;127.0.0.1:53958 fd&#x3D;5 name&#x3D;testName age&#x3D;198 idle&#x3D;0 flags&#x3D;N db&#x3D;0 sub&#x3D;0 psub&#x3D;0 multi&#x3D;-1 qbuf&#x3D;0 qbuf-free&#x3D;32768 obl&#x3D;0 oll&#x3D;0 omem&#x3D;0 events&#x3D;r cmd&#x3D;client</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="标志"><a href="#标志" class="headerlink" title="标志"></a>标志</h3><p>flags记录客户端的角色,可以是一个或者多个</p>
<p>flags=<flag1>|<flag2> </p>
<p><img src="/images/redis/serverClient/client%E7%9A%84flags1.png" alt="client的flags1"></p>
<p><img src="/images/redis/serverClient/client%E7%9A%84flags2.png" alt="client的flags2"></p>
<h3 id="输入缓冲区"><a href="#输入缓冲区" class="headerlink" title="输入缓冲区"></a>输入缓冲区</h3><p>在客户端输入以下命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set key value</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以下展示SDS的值以及querybuf属性的样子</p>
<p><img src="/images/redis/serverClient/querybuf%E5%B1%9E%E6%80%A7%E7%9A%84%E6%A0%B7%E5%AD%90.png" alt="querybuf属性的样子"></p>
<h3 id="命令与命令参数"><a href="#命令与命令参数" class="headerlink" title="命令与命令参数"></a>命令与命令参数</h3><p>服务器将客户端端发送的请求保存到客户端状态的querybuf属性之后,服务器将对命令请求的状态进行分析,并将得出的命令和参数的格式分别保存到客户端状态的argv属性和argc属性</p>
<p>argv属性是一个数组,数组中的每个项都是一个字符串对象,其中arg[0]时要执行的命令,而后的其它项都是传给命令的参数</p>
<p>argc属性则负责记录argv数组的长度</p>
<p><img src="/images/redis/serverClient/argv%E5%92%8Cargc%E5%B1%9E%E6%80%A7%E7%9A%84%E7%A4%BA%E4%BE%8B.png" alt="argv和argc属性的示例"></p>
<h3 id="命令的实现函数"><a href="#命令的实现函数" class="headerlink" title="命令的实现函数"></a>命令的实现函数</h3><p>服务器会根据argv[0]去命令表中查找命令所对应的命令实现函数.</p>
<p>命令表如下所示,它时一个字典,字典的键时一个SDS结构,保存了命令的名字,字典的值是命令所对应的redisCommand结构,这个结构保存了命令的实现函数.命令的标志.命令应该给定的参数个数.命令的执行次数以及总消耗时长等信息</p>
<p><img src="/images/redis/serverClient/%E6%9F%A5%E6%89%BE%E5%91%BD%E4%BB%A4%E5%B9%B6%E8%AE%BE%E7%BD%AEcmd%E5%B1%9E%E6%80%A7.png" alt="查找命令并设置cmd属性"></p>
<p>当程序在命令表中成功的找到argv[0]结构时,它会将客户端状态的cmd指针指向redisClient结构,之后服务器就使用cmd属性指向的redisCommand结构,以及其它一些参数来执行制定的命令.</p>
<h3 id="输出缓冲区"><a href="#输出缓冲区" class="headerlink" title="输出缓冲区"></a>输出缓冲区</h3><p>执行命令所得的命令的回复会被保存到客户端状态的输出缓冲区中,每个客户端都有2个输出缓冲区</p>
<h4 id="固定大小"><a href="#固定大小" class="headerlink" title="固定大小"></a>固定大小</h4><p>固定大小的缓冲区用于保存那些长度比较小的回复,ok,简短的字符串值等</p>
<p><img src="/images/redis/serverClient/%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%9A%84%E7%BC%93%E5%86%B2%E5%8C%BA.png" alt="固定大小的缓冲区"></p>
<h4 id="可变大小"><a href="#可变大小" class="headerlink" title="可变大小"></a>可变大小</h4><p>可变大小的缓冲区用于保存那些长度比较大的回复</p>
<p>可变大小缓冲区由reply链表和一个或者多个字符串对象组成</p>
<p><img src="/images/redis/serverClient/%E5%8F%AF%E5%8F%98%E5%A4%A7%E5%B0%8F%E7%BC%93%E5%86%B2%E5%8C%BA%E7%A4%BA%E4%BE%8B.png" alt="可变大小缓冲区示例"></p>
<h3 id="身份验证"><a href="#身份验证" class="headerlink" title="身份验证"></a>身份验证</h3><p>客户端状态的authenticated属性用于记录客户端是否通过了身份验证: 值为0表示未通过身份验证,1表示已经通过身份验证,使用auth命令进行验证</p>
<h3 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h3><p>ctime属性记录了创建客户端的时间,client list命令的age域记录了这个秒数</p>
<p>lastinteraction记录了与客户端最后互动的时间,client list命令的idle记录了空闲了多久</p>
<h2 id="客户端的创建和关闭"><a href="#客户端的创建和关闭" class="headerlink" title="客户端的创建和关闭"></a>客户端的创建和关闭</h2><h3 id="创建客户端"><a href="#创建客户端" class="headerlink" title="创建客户端"></a>创建客户端</h3><p>如果客户端是通过网络连接与服务器进行连接的普通客户端,那么connect函数连接到服务器时,服务器就会调用连接事件处理器为客户端创建相应的客户端状态,并将这个新的客户端状态添加到服务器链表的末尾</p>
<p><img src="/images/redis/serverClient/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E7%BB%93%E6%9E%84%E7%9A%84clients%E9%93%BE%E8%A1%A8.png" alt="服务器状态结构的clients链表"></p>
<h3 id="关闭普通客户端"><a href="#关闭普通客户端" class="headerlink" title="关闭普通客户端"></a>关闭普通客户端</h3><p>关闭的原因如下:</p>
<p><img src="/images/redis/serverClient/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%85%B3%E9%97%AD%E7%9A%84%E5%8E%9F%E5%9B%A0%E5%A6%82%E4%B8%8B.png" alt="客户端关闭的原因如下"></p>
<h3 id="Lua脚本的伪客户端"><a href="#Lua脚本的伪客户端" class="headerlink" title="Lua脚本的伪客户端"></a>Lua脚本的伪客户端</h3><p>服务器会在初始化时创建负责执行Lua脚本中包含的Redis命令的伪客户端.伪客户端在服务器运行的整个生命周期都会一直存在,只有服务器被关闭时,这个客户端才会被关闭</p>
<h3 id="AOF伪客户端"><a href="#AOF伪客户端" class="headerlink" title="AOF伪客户端"></a>AOF伪客户端</h3><p>载入AOF文件时,会创建用于执行AOF文件中包含的redis命令的伪客户端,载入完成则关闭这个伪客户端.</p>
<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><p>redis服务器负责与多个客户端建立网络连接,处理客户端发送的命令请求,在数据库中保存客户端执行命令所产生的数据,并通过资源管理来维持服务器自身的运转.</p>
<h2 id="命令请求的执行过程"><a href="#命令请求的执行过程" class="headerlink" title="命令请求的执行过程"></a>命令请求的执行过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set key value </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>客户端向服务器发送命令请求 SET KEY VALUE 。</li>
<li>服务器接收并处理客户端发来的命令请求 SET KEY VALUE ， 在数据库中进行设置操作， 并产生命令回复 OK 。</li>
<li>服务器将命令回复 OK 发送给客户端。</li>
<li>客户端接收服务器返回的命令回复 OK ， 并将这个回复打印给用户观看。</li>
</ol>
<h3 id="发送命令请求"><a href="#发送命令请求" class="headerlink" title="发送命令请求"></a>发送命令请求</h3><p>Redis 服务器的命令请求来自 Redis 客户端， 当用户在客户端中键入一个命令请求时， 客户端会将这个命令请求转换成协议格式， 然后通过连接到服务器的套接字， 将协议格式的命令请求发送给服务器</p>
<p><img src="/images/redis/serverClient/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E6%94%B6%E5%B9%B6%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E5%91%BD%E4%BB%A4%E7%9A%84%E8%BF%87%E7%A8%8B.png" alt="客户端接收并发送请求命令的过程"></p>
<h3 id="读取命令请求"><a href="#读取命令请求" class="headerlink" title="读取命令请求"></a>读取命令请求</h3><p>服务器读取命令的过程</p>
<ol>
<li>读取套接字中协议格式的命令请求， 并将其保存到客户端状态的输入缓冲区里面。</li>
<li>对输入缓冲区中的命令请求进行分析， 提取出命令请求中包含的命令参数， 以及命令参数的个数， 然后分别将参数和参数个数保存到客户端状态的 argv 属性和 argc 属性里面。</li>
<li>调用命令执行器， 执行客户端指定的命令。</li>
</ol>
<p><img src="/images/redis/serverClient/%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E4%B8%AD%E7%9A%84%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82.png" alt="客户端状态中的命令请求"></p>
<p><img src="/images/redis/serverClient/%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E4%B8%AD%E7%9A%84argv%E5%92%8Cargc%E5%8F%82%E6%95%B0.png" alt="客户端状态中的argv和argc参数"></p>
<h2 id="命令执行器"><a href="#命令执行器" class="headerlink" title="命令执行器"></a>命令执行器</h2><p>命令执行器要做的第一件事就是根据客户端状态的 argv[0] 参数， 在命令表（command table）中查找参数所指定的命令， 并将找到的命令保存到客户端状态的 cmd 属性里面。</p>
<h3 id="查找命令的实现"><a href="#查找命令的实现" class="headerlink" title="查找命令的实现"></a>查找命令的实现</h3><p>redisCommand 结构的主要属性</p>
<p><img src="/images/redis/serverClient/redisCommand%E7%BB%93%E6%9E%84%E7%9A%84%E4%B8%BB%E8%A6%81%E5%B1%9E%E6%80%A7.png" alt="redisCommand结构的主要属性"></p>
<p>sflags属性的标识</p>
<p><img src="/images/redis/serverClient/sflags%E5%B1%9E%E6%80%A7%E7%9A%84%E6%A0%87%E8%AF%86.png" alt="sflags属性的标识"></p>
<p>SET 命令的名字为 “set” ， 实现函数为 setCommand ； 命令的参数个数为 -3 ， 表示命令接受三个或以上数量的参数； 命令的标识为 “wm” ， 表示 SET 命令是一个写入命令， 并且在执行这个命令之前， 服务器应该对占用内存状况进行检查， 因为这个命令可能会占用大量内存。</p>
<p>GET 命令的名字为 “get” ， 实现函数为 getCommand 函数； 命令的参数个数为 2 ， 表示命令只接受两个参数； 命令的标识为 “r” ， 表示这是一个只读命令。</p>
<p><img src="/images/redis/serverClient/%E5%91%BD%E4%BB%A4%E8%A1%A8.png" alt="命令表"></p>
<p>继续之前 SET 命令的例子， 当程序以图 14-3 中的 argv[0] 作为输入， 在命令表中进行查找时， 命令表将返回 “set” 键所对应的 redisCommand 结构， 客户端状态的 cmd 指针会指向这个 redisCommand 结构， 如图 14-5 所示。</p>
<p><img src="/images/redis/serverClient/%E8%AE%BE%E7%BD%AE%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81%E7%9A%84cmd%E6%8C%87%E9%92%88.png" alt="设置客户端状态的cmd指针"></p>
<h3 id="进行预备操作"><a href="#进行预备操作" class="headerlink" title="进行预备操作"></a>进行预备操作</h3><p>在以上操作之后,在真正执行命令之前还要进行一些预备操作</p>
<ol>
<li>检查客户端状态的 cmd 指针是否指向 NULL ， 如果是的话， 那么说明用户输入的命令名字找不到相应的命令实现， 服务器不再执行后续步骤， 并向客户端返回一个错误。</li>
<li>根据客户端 cmd 属性指向的 redisCommand 结构的 arity 属性， 检查命令请求所给定的参数个数是否正确， 当参数个数不正确时， 不再执行后续步骤， 直接向客户端返回一个错误。 比如说， 如果 redisCommand 结构的 arity 属性的值为 -3 ， 那么用户输入的命令参数个数必须大于等于 3 个才行。</li>
<li>检查客户端是否已经通过了身份验证， 未通过身份验证的客户端只能执行 AUTH 命令， 如果未通过身份验证的客户端试图执行除 AUTH 命令之外的其他命令， 那么服务器将向客户端返回一个错误。</li>
<li>如果服务器打开了 maxmemory 功能， 那么在执行命令之前， 先检查服务器的内存占用情况， 并在有需要时进行内存回收， 从而使得接下来的命令可以顺利执行。 如果内存回收失败， 那么不再执行后续步骤， 向客户端返回一个错误。</li>
<li>如果服务器上一次执行 BGSAVE 命令时出错， 并且服务器打开了 stop-writes-on-bgsave-error 功能， 而且服务器即将要执行的命令是一个写命令， 那么服务器将拒绝执行这个命令， 并向客户端返回一个错误。</li>
<li>如果客户端当前正在用 SUBSCRIBE 命令订阅频道， 或者正在用 PSUBSCRIBE 命令订阅模式， 那么服务器只会执行客户端发来的 SUBSCRIBE 、 PSUBSCRIBE 、 UNSUBSCRIBE 、 PUNSUBSCRIBE 四个命令， 其他别的命令都会被服务器拒绝。</li>
<li>如果服务器正在进行数据载入， 那么客户端发送的命令必须带有 l 标识（比如 INFO 、 SHUTDOWN 、 PUBLISH ，等等）才会被服务器执行， 其他别的命令都会被服务器拒绝。</li>
<li>如果服务器因为执行 Lua 脚本而超时并进入阻塞状态， 那么服务器只会执行客户端发来的 SHUTDOWN nosave 命令和 SCRIPT KILL 命令， 其他别的命令都会被服务器拒绝。</li>
<li>如果客户端正在执行事务， 那么服务器只会执行客户端发来的 EXEC 、 DISCARD 、 MULTI 、 WATCH 四个命令， 其他命令都会被放进事务队列中。</li>
<li>如果服务器打开了监视器功能， 那么服务器会将要执行的命令和参数等信息发送给监视器。</li>
</ol>
<h3 id="调用命令的实现函数"><a href="#调用命令的实现函数" class="headerlink" title="调用命令的实现函数"></a>调用命令的实现函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; client 是指向客户端状态的指针</span><br><span class="line"></span><br><span class="line">client-&gt;cmd-&gt;proc(client);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>以上代码相当于执行setCommand(client)</p>
<p><img src="/images/redis/serverClient/%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%8A%B6%E6%80%81.png" alt="客户端状态"></p>
<p>被调用的命令实现函数会执行指定的操作， 并产生相应的命令回复， 这些回复会被保存在客户端状态的输出缓冲区里面（buf 属性和 reply 属性）， 之后实现函数还会为客户端的套接字关联命令回复处理器， 这个处理器负责将命令回复返回给客户端。</p>
<h3 id="执行后续操作"><a href="#执行后续操作" class="headerlink" title="执行后续操作"></a>执行后续操作</h3><ol>
<li>如果服务器开启了慢查询日志功能， 那么慢查询日志模块会检查是否需要为刚刚执行完的命令请求添加一条新的慢查询日志。</li>
<li>根据刚刚执行命令所耗费的时长， 更新被执行命令的 redisCommand 结构的 milliseconds 属性， 并将命令的 redisCommand 结构的 calls 计数器的值增一。</li>
<li>如果服务器开启了 AOF 持久化功能， 那么 AOF 持久化模块会将刚刚执行的命令请求写入到 AOF 缓冲区里面。</li>
<li>如果有其他从服务器正在复制当前这个服务器， 那么服务器会将刚刚执行的命令传播给所有从服务器。</li>
</ol>
<h3 id="将命令回复给客户端"><a href="#将命令回复给客户端" class="headerlink" title="将命令回复给客户端"></a>将命令回复给客户端</h3><p>服务器命令实现函数为套接字关联命令回复处理器,将客户端buf属性中回复信息以协议格式的命令回复给客户端.</p>
<h3 id="客户端接收并打印命令回复"><a href="#客户端接收并打印命令回复" class="headerlink" title="客户端接收并打印命令回复"></a>客户端接收并打印命令回复</h3><p><img src="/images/redis/serverClient/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E6%94%B6%E5%B9%B6%E6%89%93%E5%8D%B0%E5%91%BD%E4%BB%A4%E5%9B%9E%E5%A4%8D.png" alt="客户端接收并打印命令回复"></p>
<h2 id="serverCron-函数"><a href="#serverCron-函数" class="headerlink" title="serverCron 函数"></a>serverCron 函数</h2><p>serverCron函数默认每100毫秒执行一次,这个函数负责管理服务器资源</p>
<h3 id="更新服务器的时间缓存"><a href="#更新服务器的时间缓存" class="headerlink" title="更新服务器的时间缓存"></a>更新服务器的时间缓存</h3><p>服务器中有好多命令需要获取当前时间,为了减少系统调用的执行次数.服务器状态中的unixtime和mstime属性被作为当前时间的缓存</p>
<p><img src="/images/redis/serverClient/redisServer%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4%E5%B1%9E%E6%80%A7.png" alt="redisServer中的时间属性"></p>
<p>serverCron函数默认会100毫秒一次的频率更新unixtime属性和mstime属性.所以这两个属性记录的时间精度不高,</p>
<p>对于打印日志,更新服务器的LRU时钟,决定是否执行持久化任务,计算服务器上线时间这类对时间精度不高的功能上使用以上时间属性.对键设置过期时间 添加慢查询日志这种需要搞定的时间功能来说还是需要获取最准确的系统当前时间</p>
<h3 id="更新LRU时钟"><a href="#更新LRU时钟" class="headerlink" title="更新LRU时钟"></a>更新LRU时钟</h3><p>服务器状态中的lruclock属性保存了服务器的LRU时钟,这个服务器时间缓存的一种,默认每10秒更新一次时钟缓存.用于计算键的idle</p>
<p>每个redis对象都有一个lru属性,保存了对象最后一次被访问的时间</p>
<p>当服务器计算一个数据库键的空转时间,可以使用服务器的lruclock减去键的lru属性</p>
<p>因为serverCron函数会以每10秒一次的频率更新lruClock的值,所以计算的idle不是非常精确的</p>
<h3 id="更新服务器美妙执行命令的次数"><a href="#更新服务器美妙执行命令的次数" class="headerlink" title="更新服务器美妙执行命令的次数"></a>更新服务器美妙执行命令的次数</h3><p>serverCron函数中的trackOperationPerSecond函数会以每100毫秒一次的频率执行,这个函数以抽样的方式计算服务器在最近一秒钟处理的命令请求数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info stats</span><br><span class="line"># Stats</span><br><span class="line">total_connections_received:1</span><br><span class="line">total_commands_processed:5</span><br><span class="line">instantaneous_ops_per_sec:0</span><br><span class="line">total_net_input_bytes:145</span><br><span class="line">total_net_output_bytes:11352</span><br><span class="line">instantaneous_input_kbps:0.00</span><br><span class="line">instantaneous_output_kbps:0.00</span><br><span class="line">rejected_connections:0</span><br><span class="line">sync_full:0</span><br><span class="line">sync_partial_ok:0</span><br><span class="line">sync_partial_err:0</span><br><span class="line">expired_keys:0</span><br><span class="line">evicted_keys:0</span><br><span class="line">keyspace_hits:0</span><br><span class="line">keyspace_misses:0</span><br><span class="line">pubsub_channels:0</span><br><span class="line">pubsub_patterns:0</span><br><span class="line">latest_fork_usec:0</span><br><span class="line">migrate_cached_sockets:0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="更新服务器内存峰值记录"><a href="#更新服务器内存峰值记录" class="headerlink" title="更新服务器内存峰值记录"></a>更新服务器内存峰值记录</h3><p>used_memory_peak和used_memory_peak_human参数分别以两种形式记录服务器内存峰值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info memory</span><br><span class="line"># Memory</span><br><span class="line">used_memory:821744</span><br><span class="line">used_memory_human:802.48K</span><br><span class="line">used_memory_rss:9351168</span><br><span class="line">used_memory_rss_human:8.92M</span><br><span class="line">used_memory_peak:821744</span><br><span class="line">used_memory_peak_human:802.48K</span><br><span class="line">total_system_memory:8053633024</span><br><span class="line">total_system_memory_human:7.50G</span><br><span class="line">used_memory_lua:37888</span><br><span class="line">used_memory_lua_human:37.00K</span><br><span class="line">maxmemory:0</span><br><span class="line">maxmemory_human:0B</span><br><span class="line">maxmemory_policy:noeviction</span><br><span class="line">mem_fragmentation_ratio:11.38</span><br><span class="line">mem_allocator:jemalloc-4.0.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="处理sigterm信号"><a href="#处理sigterm信号" class="headerlink" title="处理sigterm信号"></a>处理sigterm信号</h3><p>在启动服务器时,redis会为服务器进程的sigterm信号关联处理器sigtermHandler函数,这个信号处理器负责在服务器接收到sigterm信号时打开关标识</p>
<p><img src="/images/redis/serverClient/sigtermHandler%E5%87%BD%E6%95%B0.png" alt="sigtermHandler函数"></p>
<p>服务器一接收到sigterm信号就会关闭服务器,服务器要拦截sigterm信号,在关闭服务器之前进行RDB操作</p>
<h3 id="管理客户端资源"><a href="#管理客户端资源" class="headerlink" title="管理客户端资源"></a>管理客户端资源</h3><p>serverCron函数每次执行都会调用clientsCron函数,该clientsCron函数会对客户端进行检查</p>
<ol>
<li><p>如果客户端与服务器连接已经超时(客户端与服务器很长时间都没有互动),那么程序释放这个客户端</p>
</li>
<li><p>如果客户端在上一次执行命令之后,输入缓冲区的大小超过了一定的长度,那么程序会释放客户端的当前的缓冲区,并重新创建一个默认的缓冲区</p>
</li>
</ol>
<h3 id="管理数据库资源"><a href="#管理数据库资源" class="headerlink" title="管理数据库资源"></a>管理数据库资源</h3><p>serverCron函数每次执行都会调用databaseCron函数,该databaseCron函数会对数据库进行检查,删除其中的过期键.</p>
<h3 id="执行被延迟的BGREWRITEAOF"><a href="#执行被延迟的BGREWRITEAOF" class="headerlink" title="执行被延迟的BGREWRITEAOF"></a>执行被延迟的BGREWRITEAOF</h3><p>在服务器执行BGSAVE命令的期间,如果客户端向服务器发来BGREWRITEAOF命令,那么服务器会将BGREWRITEAOF延迟到BGSAVE命令之后执行 </p>
<p>redisServer的aof_rewrite_scheduled标识记录了服务器是否延迟了BGREWRITEAOF命令,如果被延迟,则将该标识置为1</p>
<p>每次调用serverCron函数执行,函数都检查bgsave和BGREWRITEAOF命令是否在执行,如果都没有执行,并且aof_rewrite_scheduled属性的值为1,那么服务器就会执行之前被推延的BGREWRITEAOF命令</p>
<h3 id="检查持久化操作的运行状态"><a href="#检查持久化操作的运行状态" class="headerlink" title="检查持久化操作的运行状态"></a>检查持久化操作的运行状态</h3><p>服务器使用rdb_child_pid属性和aof_child_pid属性记录执行bgsave命令和BGREWRITEAOF命令的子进程的ID,这两个属性也可以检查bgsave命令或者BGREWRITEAOF是否正在执行</p>
<p><img src="/images/redis/serverClient/%E6%8C%81%E4%B9%85%E5%8C%96%E6%93%8D%E4%BD%9C%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81%E7%9A%84%E5%8F%82%E6%95%B0.png" alt="持久化操作的运行状态的参数"></p>
<ul>
<li><p>每次serverCron函数执行都会检查这两个pid属性的值是否为-1,</p>
<pre><code>只有其中一个不为-1,程序就会执行wait3函数,检查子进程是否有信号发来服务器进程 如果有信号到达,表示新的RDB文件生成完成或者新的AOF文件重写完毕.服务器需要进行后续操作,比如新的RDB文件替换现有的RDB文件,新的AOF文件替换现有的AOF文件

如果2个进程id都不是-1则要进行以下检查:检查是否有BGREWRITEAOF命令被延迟;是否满足自动保存条件(bgsave执行的条件);AOF重写的条件是否满足</code></pre>
</li>
</ul>
<h3 id="AOF缓冲区的内容写到AOF文件"><a href="#AOF缓冲区的内容写到AOF文件" class="headerlink" title="AOF缓冲区的内容写到AOF文件"></a>AOF缓冲区的内容写到AOF文件</h3><p>如果服务器开启了AOF功能,并且AOF文件中还有待写入的数据,那么serverCron函数会调用相应的函数将数据写入到AOF文件</p>
<h3 id="关闭异步客户端"><a href="#关闭异步客户端" class="headerlink" title="关闭异步客户端"></a>关闭异步客户端</h3><p>关闭那些输入缓冲区超出大小限制的客户端</p>
<h3 id="增加cronloops计数器的值"><a href="#增加cronloops计数器的值" class="headerlink" title="增加cronloops计数器的值"></a>增加cronloops计数器的值</h3><p>服务器状态的cronloops记录了serverCron函数执行的次数(唯一的功能是,实现每执行N次就执行一次制定的代码)</p>
<h2 id="初始化服务器"><a href="#初始化服务器" class="headerlink" title="初始化服务器"></a>初始化服务器</h2><h3 id="初始化服务器状态结构"><a href="#初始化服务器状态结构" class="headerlink" title="初始化服务器状态结构"></a>初始化服务器状态结构</h3><p>即将redisServer类型的实例变量server作为服务器的状态,并为结构中的各个属性设置默认值,调用initServerConfig函数做以下工作,为服务器赋默认值</p>
<ol>
<li>设计服务器的运行id</li>
<li>设计服务器的默认运行频率</li>
<li>设置服务器的默认配置文件路径</li>
<li>设置服务器的运行架构</li>
<li>设置服务器的默认端口号</li>
<li>设置服务器的默认RDB持久化条件和AOF持久化条件</li>
<li>初始化服务器的LRU时钟</li>
<li>创建命令表</li>
</ol>
<h3 id="载入配置文件"><a href="#载入配置文件" class="headerlink" title="载入配置文件"></a>载入配置文件</h3><p>用户可以制定参数或者制定配置文件,对服务器的默认配置进行修改,是对初始化服务器结构的参数进行修改.这是第二步操作.</p>
<p>直接指定参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;src$ .&#x2F;redis-server -- port 10086 &amp;</span><br><span class="line">[1] 11639</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;src$ 11639:M 18 Jan 02:09:01.264 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-&#96;&#96;__ &#39;&#39;-._                                             </span><br><span class="line">      _.-&#96;&#96;    &#96;.  &#96;_.  &#39;&#39;-._           Redis 3.2.10 (00000000&#x2F;0) 64 bit</span><br><span class="line">  .-&#96;&#96; .-&#96;&#96;&#96;.  &#96;&#96;&#96;\&#x2F;    _.,_ &#39;&#39;-._                                   </span><br><span class="line"> (    &#39;      ,       .-&#96;  | &#96;,    )     Running in standalone mode</span><br><span class="line"> |&#96;-._&#96;-...-&#96; __...-.&#96;&#96;-._|&#39;&#96; _.-&#39;|     Port: 10086</span><br><span class="line"> |    &#96;-._   &#96;._    &#x2F;     _.-&#39;    |     PID: 11639</span><br><span class="line">  &#96;-._    &#96;-._  &#96;-.&#x2F;  _.-&#39;    _.-&#39;                                   </span><br><span class="line"> |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |           http:&#x2F;&#x2F;redis.io        </span><br><span class="line">  &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |                                  </span><br><span class="line">  &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line">      &#96;-._    &#96;-.__.-&#39;    _.-&#39;                                       </span><br><span class="line">          &#96;-._        _.-&#39;                                           </span><br><span class="line">              &#96;-.__.-&#39;                                               </span><br><span class="line"></span><br><span class="line">11639:M 18 Jan 02:09:01.266 # WARNING: The TCP backlog setting of 511 cannot be enforced because &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn is set to the lower value of 128.</span><br><span class="line">11639:M 18 Jan 02:09:01.266 # Server started, Redis version 3.2.10</span><br><span class="line">11639:M 18 Jan 02:09:01.267 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory&#x3D;1&#39; for this to take effect.</span><br><span class="line">11639:M 18 Jan 02:09:01.267 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&#39; as root, and add it to your &#x2F;etc&#x2F;rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br><span class="line">11639:M 18 Jan 02:09:01.267 * DB loaded from disk: 0.000 seconds</span><br><span class="line">11639:M 18 Jan 02:09:01.267 * The server is now ready to accept connections on port 10086</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者指定配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;src$ .&#x2F;redis-server ..&#x2F;redis.conf &amp;</span><br><span class="line">[1] 11765</span><br><span class="line">zhuningning@ubuntu:&#x2F;usr&#x2F;local&#x2F;redis-3.2.10&#x2F;src$ 11765:M 18 Jan 02:10:21.493 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-&#96;&#96;__ &#39;&#39;-._                                             </span><br><span class="line">      _.-&#96;&#96;    &#96;.  &#96;_.  &#39;&#39;-._           Redis 3.2.10 (00000000&#x2F;0) 64 bit</span><br><span class="line">  .-&#96;&#96; .-&#96;&#96;&#96;.  &#96;&#96;&#96;\&#x2F;    _.,_ &#39;&#39;-._                                   </span><br><span class="line"> (    &#39;      ,       .-&#96;  | &#96;,    )     Running in standalone mode</span><br><span class="line"> |&#96;-._&#96;-...-&#96; __...-.&#96;&#96;-._|&#39;&#96; _.-&#39;|     Port: 6379</span><br><span class="line"> |    &#96;-._   &#96;._    &#x2F;     _.-&#39;    |     PID: 11765</span><br><span class="line">  &#96;-._    &#96;-._  &#96;-.&#x2F;  _.-&#39;    _.-&#39;                                   </span><br><span class="line"> |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |           http:&#x2F;&#x2F;redis.io        </span><br><span class="line">  &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line"> |&#96;-._&#96;-._    &#96;-.__.-&#39;    _.-&#39;_.-&#39;|                                  </span><br><span class="line"> |    &#96;-._&#96;-._        _.-&#39;_.-&#39;    |                                  </span><br><span class="line">  &#96;-._    &#96;-._&#96;-.__.-&#39;_.-&#39;    _.-&#39;                                   </span><br><span class="line">      &#96;-._    &#96;-.__.-&#39;    _.-&#39;                                       </span><br><span class="line">          &#96;-._        _.-&#39;                                           </span><br><span class="line">              &#96;-.__.-&#39;                                               </span><br><span class="line"></span><br><span class="line">11765:M 18 Jan 02:10:21.495 # WARNING: The TCP backlog setting of 511 cannot be enforced because &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn is set to the lower value of 128.</span><br><span class="line">11765:M 18 Jan 02:10:21.495 # Server started, Redis version 3.2.10</span><br><span class="line">11765:M 18 Jan 02:10:21.495 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory&#x3D;1&#39; for this to take effect.</span><br><span class="line">11765:M 18 Jan 02:10:21.495 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&#39; as root, and add it to your &#x2F;etc&#x2F;rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br><span class="line">11765:M 18 Jan 02:10:21.495 * DB loaded from disk: 0.000 seconds</span><br><span class="line">11765:M 18 Jan 02:10:21.495 * The server is now ready to accept connections on port 6379</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="初始化服务器数据结构"><a href="#初始化服务器数据结构" class="headerlink" title="初始化服务器数据结构"></a>初始化服务器数据结构</h3><p>第三步 就是调用initServer初始化数据结构,包括:</p>
<p>server.clients链表,这个链表包含了所有与服务器连接的客户端redisClient,结构实例</p>
<p>server.db数组,包含了服务器的所有数据库</p>
<p>server.pubsub_channelszidian关于频道订阅信息的</p>
<p>用于执行lua脚本的环境server.lua</p>
<p>用于保存慢查询日志的server.slowlog属性</p>
<p>为以上的数据机构分配内存,除此之外还包括以下:</p>
<p><img src="/images/redis/serverClient/initServer%E5%87%BD%E6%95%B0%E7%9A%84%E5%85%B6%E5%AE%83%E6%93%8D%E4%BD%9C.png" alt="initServer函数的其它操作"></p>
<h3 id="还原数据库状态"><a href="#还原数据库状态" class="headerlink" title="还原数据库状态"></a>还原数据库状态</h3><p>如果开启了AOF持久化功能,则使用AOF文件还原数据库,否则使用RDB文件还原数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11765:M 18 Jan 02:10:21.495 * DB loaded from disk: 0.000 seconds</span><br></pre></td></tr></table></figure>

<h3 id="执行时间循环"><a href="#执行时间循环" class="headerlink" title="执行时间循环"></a>执行时间循环</h3><p>初始化的最后异步打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">11765:M 18 Jan 02:10:21.495 * The server is now ready to accept connections on port 6379</span><br></pre></td></tr></table></figure>

<p>之后开始执行时间循环.</p>
<p>这样服务器这样就可以接收客户端的连接请求,以及接收客户端的命令了.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="陈伟杰"
      src="/images/favicon.ico">
  <p class="site-author-name" itemprop="name">陈伟杰</p>
  <div class="site-description" itemprop="description">学习，坚持。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">75</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/chenwj1103" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chenwj1103" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">陈伟杰</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">638k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:40</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
