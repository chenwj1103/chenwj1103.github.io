---
title: 高性能mysql-复制
copyright: true
date: 2019-01-27 23:54:46
tags: mysql复制
categories: mysql

---

复制功能不仅有利于构建高性能的应用，也是高可用性、可扩展性、灾难恢复、备份以及数据仓库等工作的基础。

# 复制概述

复制解决的事让一台服务器的数据与其他服务器保持同步。一台主库的数据可以同步到多台备库上。

mysql支持两种复制方式：基于行的复制和基于语句的复制。两种方式都是通过在主库上记录二进制日志，在备库上重放日志的方式来实现异步的数据复制。所以会存在延迟。

复制通常只会启用二进制日志带来开销，其它的不会。


## 复制解决的问题

- 数据分布，可以分布在不同的数据中心；
- 负载均衡，通过mysql复制可以将读操作分不到不同的服务器上，实现对读密集型的应用的额优化，并且实现很方便。
- 备份，复制是一种很有意义的技术补充，但复制既不是备份也不能够取代备份；
- 高可用性和故障切换,复制能够帮助应用避免mysql单点失败，一个包含复制的设计良好的故障切换系统能够显著的缩短宕机的时间。

## 复制如何工作

复制的步骤：

1.在主库上把数据更改记录到二进制日志中，（binary log），二进制日志事件；
2.备库将主库上的日志复制到自己的中继日志（relayLog）中；
3.备库读取中继日志中的事件，将其重放到备库数据之上；

![mysql复制如何工作](/images/mysql/mysql复制如何工作.png)

![复制的过程](/images/mysql/复制的过程.png)


# 配置复制

步骤：

1.在每台服务器上创建复制账号；
2.配置主库和备库；
3.通知备库连接到主库并从主库复制数据；

## 创建复制账号

mysql会赋予一些特殊的权限给复制线程。在备库运行的IO线程会建立一个到主库的TCP/IP连接，这就意味着在主库创建一个用户，并赋予其合适的权限。备库IO线程以该用户名连接到主库并读取二进制读取其日志。

````
mysql> grant replication slave,replication client on *.* to repl@'127.0.0.%' identified by 'p4ssword';

Query OK, 0 rows affected (0.02 sec)
````

**注意** 

我们在主库和备库都创建该账号，我们把这个账户限制在本地网络，这是一个特权账号。

复制账户事实上只需要在主库上的replication slave权限，并不一定需要每一端服务器都有replication client权限，为什么需要给备库赋予权限呢？

1.用来监控和管理复制的账号需要replication client权限，并且针对这两种目的使用同一个账号更加容易；
2.如果在主库上建立了账号，然后从主库将数据克隆到备库上时，备库也就设置好了，编程主库所需要的配置，这样后续可以方便的交换主库的角色；

## 配置主库和备库

- 加入server1是主库，需要打开二进制日志并指定一个服务器id 在主库的my.cnf文件中增加或修改如下内容：

````
log_bin = mysql-bin;
server_id = 10
````
开启了binLog需要重启mysql服务。

````
mysql> show master status;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 |      154 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
````
- 备库上也需要在my.cnf中增加类似的配置，而且需要重启服务器；

````
log_bin = mysql-bin
server_id = 2
relay_log = /var/lib/mysql/mysql-relay-bin
log_slave_updates = 1
read_only =1

````

上述配置只有server_id是必须的，replay_log是指中继日志的位置，log_slave_updates表示运行备库将其重放的事件也记录到自身的日志中。

## 启动复制










