---
title: redis设计与实现-事件
date: 2018-01-14 00:49:02
tags: redis事件
categories: redis

---

redis服务器时一个事件驱动程序,服务器需要处理以下两类事件.

- 文件事件:redis服务器通过套接字与客户端进行连接.而文件事件就是服务器对套接字的抽象.服务器与客户端的通信会产生相应的文件事件,服务器监听并处理这些事件来完成一些列网络操作.

- 时间事件:redis服务器中的一些操作需要在给定的时间点执行,而时间事件就是对这类定时操作的抽象

# 文件事件

redis基于Reactor模式开发了自己的网络事件处理器:这个处理器被成为文件处理器.

文件事件处理器使用I/O多路复用来监听多个套接字,并根据套接字目前执行的任务来为套接字关联不同的事件处理器

当被监听的套接字准备好执行连接应答/读取/写入/关闭操作时,与操作对应的文件事件就会产生.这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件.

## 文件事件处理器的构成

以下是文件事件处理器的四个组成部分:

![文件事件处理器](/images/redis/event/文件事件处理器.png)

文件事件会并发的出现,但是I/O多路复用程序总是会将所有产生事件的套接字放到一个队列,然后通过队列进行后续处理.

## 事件的类型

当客户端变得可读时(客户端对套接字执行write操作,或者执行close操作)或者有新的应答套接字出现时(客户端对服务器监听的套接字执行connect操作) 套接字产生**AE_READABLE**事件.

当套接字变得可读时(客户端对套接字执行read操作) 套接字产生**AE_WRITEABLE**事件

多路复用程序允许服务器同时监听以上两种事件,文件时间分配器会优先处理读事件,然后处理写事件.

## 文件事件处理器

redis为文件事件编写了多个处理器:连接应答处理器,命令请求处理器,命令回复处理器,复制处理器


# 时间事件

redis时间事件分为定时事件和周期性事件

时间事件的属性:

1. id:服务器为时间事件创建的全局唯一ID,从小到大递增.
2. when:毫秒精度的UNIX时间戳,记录了事件的到达事件.
3. timeProc:事件处理器,一个函数.时间事件到达后,服务器就会调用相应的处理器来处理事件.

如果事件处理器返回一个AE_NOMORE 那么这个事件为定时事件,该事件在被处理一次后就不再执行,而是被删除.

如果返回一个非AE_NOMORE 的这个事件时周期性事件,处理玩后,服务器会根据返回值对时间事件的属性when进行更新.

## 实现

服务器的时间时间都放在一个无需链表中.运行时遍历整个链表,发现到达的时间事件,并调用相应的时间处理器.

如下:

![链表连接起来的三个时间事件](/images/redis/event/链表连接起来的三个时间事件.png)

![时间事件处理器伪代码实现](/images/redis/event/时间事件处理器伪代码实现.png)


## 时间事件的应用实例:severCron函数

持续运行的服务器需要对自身的资源和状态进行检查和调整.主要由serverCron函数来执行,主要功能如下:

![serverCron函数的执行的功能](/images/redis/event/serverCron函数的执行的功能.png)

serverCron函数每秒运行10次.

# 事件的调度和执行

事件的调度和执行规则

![事件的调度和执行规则1](/images/redis/event/事件的调度和执行规则1.png)

![事件的调度和执行规则2](/images/redis/event/事件的调度和执行规则2.png)







































